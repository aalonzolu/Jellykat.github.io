define(["exports","playbackManager","events","serverNotifications","connectionManager"],(function(_exports,_playbackManager,_events,_serverNotifications,_connectionManager){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function getActivePlayerId(){var info=_playbackManager.default.getPlayerInfo();return info?info.id:null}function sendPlayCommand(apiClient,options,playType){var sessionId=getActivePlayerId(),remoteOptions={ItemIds:(options.ids||options.items.map((function(i){return i.Id}))).join(","),PlayCommand:playType};return options.startPositionTicks&&(remoteOptions.StartPositionTicks=options.startPositionTicks),options.mediaSourceId&&(remoteOptions.MediaSourceId=options.mediaSourceId),null!=options.audioStreamIndex&&(remoteOptions.AudioStreamIndex=options.audioStreamIndex),null!=options.subtitleStreamIndex&&(remoteOptions.SubtitleStreamIndex=options.subtitleStreamIndex),null!=options.startIndex&&(remoteOptions.StartIndex=options.startIndex),apiClient.sendPlayCommand(sessionId,remoteOptions)}function sendPlayStateCommand(apiClient,command,options){var sessionId=getActivePlayerId();apiClient.sendPlayStateCommand(sessionId,command,options)}function getCurrentApiClient(instance){var currentServerId=instance.currentServerId;return currentServerId?_connectionManager.default.getApiClient(currentServerId):_connectionManager.default.currentApiClient()}function sendCommandByName(instance,name,options){var command={Name:name};options&&(command.Arguments=options),instance.sendCommand(command)}function processUpdatedSessions(instance,sessions,apiClient){var serverId=apiClient.serverId();sessions.map((function(s){s.NowPlayingItem&&(s.NowPlayingItem.ServerId=serverId)}));var currentTargetId=getActivePlayerId(),session=sessions.filter((function(s){return s.Id===currentTargetId}))[0];if(session){!function normalizeImages(state,apiClient){if(state&&state.NowPlayingItem){var item=state.NowPlayingItem;item.ImageTags&&item.ImageTags.Primary||item.PrimaryImageTag&&(item.ImageTags=item.ImageTags||{},item.ImageTags.Primary=item.PrimaryImageTag),item.BackdropImageTag&&item.BackdropItemId===item.Id&&(item.BackdropImageTags=[item.BackdropImageTag]),item.BackdropImageTag&&item.BackdropItemId!==item.Id&&(item.ParentBackdropImageTags=[item.BackdropImageTag],item.ParentBackdropItemId=item.BackdropItemId),item.ServerId||(item.ServerId=apiClient.serverId())}}(session,apiClient);var eventNames=function getChangedEvents(state1,state2){var names=[];if(!state1)return names.push("statechange"),names.push("timeupdate"),names.push("pause"),names;return names.push("statechange"),names.push("timeupdate"),names.push("pause"),names}(instance.lastPlayerData);instance.lastPlayerData=session;for(var i=0,length=eventNames.length;i<length;i++)_events.default.trigger(instance,eventNames[i],[session])}else instance.lastPlayerData=session,_playbackManager.default.setDefaultPlayerActive()}function onPollIntervalFired(){var instance=this,apiClient=getCurrentApiClient(instance);apiClient.isMessageChannelOpen()||apiClient.getSessions().then((function(sessions){processUpdatedSessions(instance,sessions,apiClient)}))}function subscribeToPlayerUpdates(instance){instance.isUpdating=!0,getCurrentApiClient(instance).sendMessage("SessionsStart","100,800"),instance.pollInterval&&(clearInterval(instance.pollInterval),instance.pollInterval=null),instance.pollInterval=setInterval(onPollIntervalFired.bind(instance),5e3)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_playbackManager=_interopRequireDefault(_playbackManager),_events=_interopRequireDefault(_events),_serverNotifications=_interopRequireDefault(_serverNotifications),_connectionManager=_interopRequireDefault(_connectionManager);var _default=function(){function SessionPlayer(){!function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,SessionPlayer);var self=this;this.name="Remote Control",this.type="mediaplayer",this.isLocalPlayer=!1,this.id="remoteplayer",_events.default.on(_serverNotifications.default,"Sessions",(function(e,apiClient,data){processUpdatedSessions(self,data,apiClient)}))}return function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}(SessionPlayer,[{key:"beginPlayerUpdates",value:function beginPlayerUpdates(){this.playerListenerCount=this.playerListenerCount||0,this.playerListenerCount<=0&&(this.playerListenerCount=0,subscribeToPlayerUpdates(this)),this.playerListenerCount++}},{key:"endPlayerUpdates",value:function endPlayerUpdates(){this.playerListenerCount=this.playerListenerCount||0,this.playerListenerCount--,this.playerListenerCount<=0&&(!function unsubscribeFromPlayerUpdates(instance){instance.isUpdating=!0,getCurrentApiClient(instance).sendMessage("SessionsStop"),instance.pollInterval&&(clearInterval(instance.pollInterval),instance.pollInterval=null)}(this),this.playerListenerCount=0)}},{key:"getPlayerState",value:function getPlayerState(){return this.lastPlayerData||{}}},{key:"getTargets",value:function getTargets(){var apiClient=getCurrentApiClient(this),sessionQuery={ControllableByUserId:apiClient.getCurrentUserId()};if(apiClient){var name=this.name;return apiClient.getSessions(sessionQuery).then((function(sessions){return sessions.filter((function(s){return s.DeviceId!==apiClient.deviceId()})).map((function(s){return{name:s.DeviceName,deviceName:s.DeviceName,deviceType:s.DeviceType,id:s.Id,playerName:name,appName:s.Client,playableMediaTypes:s.PlayableMediaTypes,isLocalPlayer:!1,supportedCommands:s.Capabilities.SupportedCommands,user:s.UserId?{Id:s.UserId,Name:s.UserName,PrimaryImageTag:s.UserPrimaryImageTag}:null}}))}))}return Promise.resolve([])}},{key:"sendCommand",value:function sendCommand(command){var sessionId=getActivePlayerId();getCurrentApiClient(this).sendCommand(sessionId,command)}},{key:"play",value:function play(options){return(options=Object.assign({},options)).items&&(options.ids=options.items.map((function(i){return i.Id})),options.items=null),sendPlayCommand(getCurrentApiClient(this),options,"PlayNow")}},{key:"shuffle",value:function shuffle(item){sendPlayCommand(getCurrentApiClient(this),{ids:[item.Id]},"PlayShuffle")}},{key:"instantMix",value:function instantMix(item){sendPlayCommand(getCurrentApiClient(this),{ids:[item.Id]},"PlayInstantMix")}},{key:"queue",value:function queue(options){sendPlayCommand(getCurrentApiClient(this),options,"PlayNext")}},{key:"queueNext",value:function queueNext(options){sendPlayCommand(getCurrentApiClient(this),options,"PlayLast")}},{key:"canPlayMediaType",value:function canPlayMediaType(mediaType){return"audio"===(mediaType=(mediaType||"").toLowerCase())||"video"===mediaType}},{key:"canQueueMediaType",value:function canQueueMediaType(mediaType){return this.canPlayMediaType(mediaType)}},{key:"stop",value:function stop(){sendPlayStateCommand(getCurrentApiClient(this),"stop")}},{key:"nextTrack",value:function nextTrack(){sendPlayStateCommand(getCurrentApiClient(this),"nextTrack")}},{key:"previousTrack",value:function previousTrack(){sendPlayStateCommand(getCurrentApiClient(this),"previousTrack")}},{key:"seek",value:function seek(positionTicks){sendPlayStateCommand(getCurrentApiClient(this),"seek",{SeekPositionTicks:positionTicks})}},{key:"currentTime",value:function currentTime(val){if(null!=val)return this.seek(val);var state=this.lastPlayerData||{};return(state=state.PlayState||{}).PositionTicks}},{key:"duration",value:function duration(){var state=this.lastPlayerData||{};return(state=state.NowPlayingItem||{}).RunTimeTicks}},{key:"paused",value:function paused(){var state=this.lastPlayerData||{};return(state=state.PlayState||{}).IsPaused}},{key:"getVolume",value:function getVolume(){var state=this.lastPlayerData||{};return(state=state.PlayState||{}).VolumeLevel}},{key:"isMuted",value:function isMuted(){var state=this.lastPlayerData||{};return(state=state.PlayState||{}).IsMuted}},{key:"pause",value:function pause(){sendPlayStateCommand(getCurrentApiClient(this),"Pause")}},{key:"unpause",value:function unpause(){sendPlayStateCommand(getCurrentApiClient(this),"Unpause")}},{key:"playPause",value:function playPause(){sendPlayStateCommand(getCurrentApiClient(this),"PlayPause")}},{key:"setMute",value:function setMute(isMuted){sendCommandByName(this,isMuted?"Mute":"Unmute")}},{key:"toggleMute",value:function toggleMute(){sendCommandByName(this,"ToggleMute")}},{key:"setVolume",value:function setVolume(vol){sendCommandByName(this,"SetVolume",{Volume:vol})}},{key:"volumeUp",value:function volumeUp(){sendCommandByName(this,"VolumeUp")}},{key:"volumeDown",value:function volumeDown(){sendCommandByName(this,"VolumeDown")}},{key:"toggleFullscreen",value:function toggleFullscreen(){sendCommandByName(this,"ToggleFullscreen")}},{key:"audioTracks",value:function audioTracks(){var state=this.lastPlayerData||{};return((state=state.NowPlayingItem||{}).MediaStreams||[]).filter((function(s){return"Audio"===s.Type}))}},{key:"getAudioStreamIndex",value:function getAudioStreamIndex(){var state=this.lastPlayerData||{};return(state=state.PlayState||{}).AudioStreamIndex}},{key:"playTrailers",value:function playTrailers(item){sendCommandByName(this,"PlayTrailers",{ItemId:item.Id})}},{key:"setAudioStreamIndex",value:function setAudioStreamIndex(index){sendCommandByName(this,"SetAudioStreamIndex",{Index:index})}},{key:"subtitleTracks",value:function subtitleTracks(){var state=this.lastPlayerData||{};return((state=state.NowPlayingItem||{}).MediaStreams||[]).filter((function(s){return"Subtitle"===s.Type}))}},{key:"getSubtitleStreamIndex",value:function getSubtitleStreamIndex(){var state=this.lastPlayerData||{};return(state=state.PlayState||{}).SubtitleStreamIndex}},{key:"setSubtitleStreamIndex",value:function setSubtitleStreamIndex(index){sendCommandByName(this,"SetSubtitleStreamIndex",{Index:index})}},{key:"setRepeatMode",value:function setRepeatMode(mode){sendCommandByName(this,"SetRepeatMode",{RepeatMode:mode})}},{key:"getRepeatMode",value:function getRepeatMode(){}},{key:"setQueueShuffleMode",value:function setQueueShuffleMode(mode){sendCommandByName(this,"SetShuffleQueue",{ShuffleMode:mode})}},{key:"getQueueShuffleMode",value:function getQueueShuffleMode(){}},{key:"displayContent",value:function displayContent(options){sendCommandByName(this,"DisplayContent",options)}},{key:"isPlaying",value:function isPlaying(mediaType){var state=this.lastPlayerData||{};return null!=state.NowPlayingItem&&(state.NowPlayingItem.MediaType===mediaType||!mediaType)}},{key:"isPlayingVideo",value:function isPlayingVideo(){var state=this.lastPlayerData||{};return"Video"===(state=state.NowPlayingItem||{}).MediaType}},{key:"isPlayingAudio",value:function isPlayingAudio(){var state=this.lastPlayerData||{};return"Audio"===(state=state.NowPlayingItem||{}).MediaType}},{key:"getPlaylist",value:function getPlaylist(){return Promise.resolve([])}},{key:"getCurrentPlaylistItemId",value:function getCurrentPlaylistItemId(){}},{key:"setCurrentPlaylistItem",value:function setCurrentPlaylistItem(playlistItemId){return Promise.resolve()}},{key:"removeFromPlaylist",value:function removeFromPlaylist(playlistItemIds){return Promise.resolve()}},{key:"tryPair",value:function tryPair(target){return Promise.resolve()}}]),SessionPlayer}();_exports.default=_default}));
//# sourceMappingURL=plugin.js.map
