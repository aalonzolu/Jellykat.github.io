define(["require","exports","events","browser","apphost","htmlMediaHelper"],(function(_require,_exports,_events,_browser,_apphost,htmlMediaHelper){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var cache=new WeakMap;return _getRequireWildcardCache=function _getRequireWildcardCache(){return cache},cache}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache();if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}var fadeTimeout,supportedFeatures;function cancelFadeTimeout(){fadeTimeout&&(clearTimeout(fadeTimeout),fadeTimeout=null)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_events=_interopRequireDefault(_events),_browser=_interopRequireDefault(_browser),_apphost=_interopRequireDefault(_apphost),htmlMediaHelper=_interopRequireWildcard(htmlMediaHelper);var _default=function(){function HtmlAudioPlayer(){!function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,HtmlAudioPlayer);var self=this;function unBindEvents(elem){elem.removeEventListener("timeupdate",onTimeUpdate),elem.removeEventListener("ended",onEnded),elem.removeEventListener("volumechange",onVolumeChange),elem.removeEventListener("pause",onPause),elem.removeEventListener("playing",onPlaying),elem.removeEventListener("play",onPlay),elem.removeEventListener("waiting",onWaiting)}function onEnded(){htmlMediaHelper.onEndedInternal(self,this,onError)}function onTimeUpdate(){var time=this.currentTime;self._isFadingOut||(self._currentTime=time,_events.default.trigger(self,"timeupdate"))}function onVolumeChange(){self._isFadingOut||(htmlMediaHelper.saveVolume(this.volume),_events.default.trigger(self,"volumechange"))}function onPlaying(e){self._started||(self._started=!0,this.removeAttribute("controls"),htmlMediaHelper.seekOnPlaybackStart(self,e.target,self._currentPlayOptions.playerStartPositionTicks)),_events.default.trigger(self,"playing")}function onPlay(e){_events.default.trigger(self,"unpause")}function onPause(){_events.default.trigger(self,"pause")}function onWaiting(){_events.default.trigger(self,"waiting")}function onError(){var type,errorCode=this.error&&this.error.code||0,errorMessage=this.error&&this.error.message||"";switch(console.error("media element error: "+errorCode.toString()+" "+errorMessage),errorCode){case 1:return;case 2:type="network";break;case 3:if(self._hlsPlayer)return void htmlMediaHelper.handleHlsJsMediaError(self);type="mediadecodeerror";break;case 4:type="medianotsupported";break;default:return}htmlMediaHelper.onErrorInternal(self,type)}self.name="Html Audio Player",self.type="mediaplayer",self.id="htmlaudioplayer",self.priority=1,self.play=function(options){return self._started=!1,self._timeUpdated=!1,self._currentTime=null,function setCurrentSrc(elem,options){elem.removeEventListener("error",onError),unBindEvents(elem),function bindEvents(elem){elem.addEventListener("timeupdate",onTimeUpdate),elem.addEventListener("ended",onEnded),elem.addEventListener("volumechange",onVolumeChange),elem.addEventListener("pause",onPause),elem.addEventListener("playing",onPlaying),elem.addEventListener("play",onPlay),elem.addEventListener("waiting",onWaiting)}(elem);var val=options.url;console.debug("playing url: "+val);var seconds=(options.playerStartPositionTicks||0)/1e7;seconds&&(val+="#t="+seconds);htmlMediaHelper.destroyHlsPlayer(self),self._currentPlayOptions=options;var crossOrigin=htmlMediaHelper.getCrossOriginValue(options.mediaSource);crossOrigin&&(elem.crossOrigin=crossOrigin);return function enableHlsPlayer(url,item,mediaSource,mediaType){return htmlMediaHelper.enableHlsJsPlayer(mediaSource.RunTimeTicks,mediaType)?-1!==url.indexOf(".m3u8")?Promise.resolve():new Promise((function(resolve,reject){new Promise((function(_resolve,_reject){return _require(["fetchHelper"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(fetchHelper){fetchHelper.ajax({url:url,type:"HEAD"}).then((function(response){"application/x-mpegurl"===(response.headers.get("Content-Type")||"").toLowerCase()?resolve():reject()}),reject)}))})):Promise.reject()}(val,options.item,options.mediaSource,"Audio").then((function(){return new Promise((function(resolve,reject){!function requireHlsPlayer(callback){new Promise((function(_resolve,_reject){return _require(["hlsjs"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref2){var hls=_ref2.default;window.Hls=hls,callback()}))}((function(){var hls=new Hls({manifestLoadingTimeOut:2e4,xhrSetup:function xhrSetup(xhr,url){xhr.withCredentials=!0}});hls.loadSource(val),hls.attachMedia(elem),htmlMediaHelper.bindEventsToHlsPlayer(self,hls,elem,onError,resolve,reject),self._hlsPlayer=hls,self._currentSrc=val}))}))}),(function(){return elem.autoplay=!0,elem.crossOrigin="use-credentials",htmlMediaHelper.applySrc(elem,val,options).then((function(){return self._currentSrc=val,htmlMediaHelper.playWithPromise(elem,onError)}))}))}(function createMediaElement(){var elem=self._mediaElement;if(elem)return elem;(elem=document.querySelector(".mediaPlayerAudio"))||((elem=document.createElement("audio")).classList.add("mediaPlayerAudio"),elem.classList.add("hide"),document.body.appendChild(elem));return elem.volume=htmlMediaHelper.getSavedVolume(),self._mediaElement=elem,elem}(),options)},self.stop=function(destroyPlayer){cancelFadeTimeout();var elem=self._mediaElement,src=self._currentSrc;if(elem&&src){if(!destroyPlayer||!function supportsFade(){return!_browser.default.tv}())return elem.pause(),htmlMediaHelper.onEndedInternal(self,elem,onError),destroyPlayer&&self.destroy(),Promise.resolve();var originalVolume=elem.volume;return function fade(instance,elem,startingVolume){instance._isFadingOut=!0;var newVolume=Math.max(0,startingVolume-.15);return console.debug("fading volume to "+newVolume),elem.volume=newVolume,newVolume<=0?(instance._isFadingOut=!1,Promise.resolve()):new Promise((function(resolve,reject){cancelFadeTimeout(),fadeTimeout=setTimeout((function(){fade(instance,elem,newVolume).then(resolve,reject)}),100)}))}(self,elem,elem.volume).then((function(){elem.pause(),elem.volume=originalVolume,htmlMediaHelper.onEndedInternal(self,elem,onError),destroyPlayer&&self.destroy()}))}return Promise.resolve()},self.destroy=function(){unBindEvents(self._mediaElement)}}return function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}(HtmlAudioPlayer,[{key:"currentSrc",value:function currentSrc(){return this._currentSrc}},{key:"canPlayMediaType",value:function canPlayMediaType(mediaType){return"audio"===(mediaType||"").toLowerCase()}},{key:"getDeviceProfile",value:function getDeviceProfile(item){return _apphost.default.getDeviceProfile?_apphost.default.getDeviceProfile(item):function getDefaultProfile(){return new Promise((function(_resolve,_reject){return _require(["browserdeviceprofile"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref){return(0,_ref.default)({})}))}()}},{key:"currentTime",value:function currentTime(val){var mediaElement=this._mediaElement;if(mediaElement){if(null!=val)return void(mediaElement.currentTime=val/1e3);var currentTime=this._currentTime;return currentTime?1e3*currentTime:1e3*(mediaElement.currentTime||0)}}},{key:"duration",value:function duration(val){var mediaElement=this._mediaElement;if(mediaElement){var duration=mediaElement.duration;if(htmlMediaHelper.isValidDuration(duration))return 1e3*duration}return null}},{key:"seekable",value:function seekable(){var mediaElement=this._mediaElement;if(mediaElement){var seekable=mediaElement.seekable;if(seekable&&seekable.length){var start=seekable.start(0),end=seekable.end(0);return htmlMediaHelper.isValidDuration(start)||(start=0),htmlMediaHelper.isValidDuration(end)||(end=0),end-start>0}return!1}}},{key:"getBufferedRanges",value:function getBufferedRanges(){var mediaElement=this._mediaElement;return mediaElement?htmlMediaHelper.getBufferedRanges(this,mediaElement):[]}},{key:"pause",value:function pause(){var mediaElement=this._mediaElement;mediaElement&&mediaElement.pause()}},{key:"resume",value:function resume(){var mediaElement=this._mediaElement;mediaElement&&mediaElement.play()}},{key:"unpause",value:function unpause(){var mediaElement=this._mediaElement;mediaElement&&mediaElement.play()}},{key:"paused",value:function paused(){var mediaElement=this._mediaElement;return!!mediaElement&&mediaElement.paused}},{key:"setPlaybackRate",value:function setPlaybackRate(value){var mediaElement=this._mediaElement;mediaElement&&(mediaElement.playbackRate=value)}},{key:"getPlaybackRate",value:function getPlaybackRate(){var mediaElement=this._mediaElement;return mediaElement?mediaElement.playbackRate:null}},{key:"setVolume",value:function setVolume(val){var mediaElement=this._mediaElement;mediaElement&&(mediaElement.volume=val/100)}},{key:"getVolume",value:function getVolume(){var mediaElement=this._mediaElement;if(mediaElement)return Math.min(Math.round(100*mediaElement.volume),100)}},{key:"volumeUp",value:function volumeUp(){this.setVolume(Math.min(this.getVolume()+2,100))}},{key:"volumeDown",value:function volumeDown(){this.setVolume(Math.max(this.getVolume()-2,0))}},{key:"setMute",value:function setMute(mute){var mediaElement=this._mediaElement;mediaElement&&(mediaElement.muted=mute)}},{key:"isMuted",value:function isMuted(){var mediaElement=this._mediaElement;return!!mediaElement&&mediaElement.muted}},{key:"supports",value:function supports(feature){return supportedFeatures||(supportedFeatures=function getSupportedFeatures(){var list=[];"number"==typeof document.createElement("audio").playbackRate&&list.push("PlaybackRate");return list}()),-1!==supportedFeatures.indexOf(feature)}}]),HtmlAudioPlayer}();_exports.default=_default}));
//# sourceMappingURL=plugin.js.map
