{"version":3,"sources":["plugins/bookPlayer/plugin.js"],"names":["define","_require","_exports","_connectionManager","_loading","_keyboardnavigation","_dialogHelper","_dom","_events","_style","_materialIcons","_paperIconButtonLight","_tableOfContents","_interopRequireDefault","obj","__esModule","default","_typeof","Symbol","iterator","constructor","prototype","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","value","error","done","Promise","then","_asyncToGenerator","fn","self","this","args","arguments","apply","err","undefined","_getRequireWildcardCache","WeakMap","cache","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","BookPlayer","_classCallCheck","instance","Constructor","TypeError","name","type","id","priority","onDialogClosed","bind","openTableOfContents","onWindowKeyUp","_createClass","protoProps","staticProps","play","options","_progress","_loaded","loading","show","elem","createMediaElement","setCurrentSrc","stop","unbindEvents","_mediaElement","tocElement","_tocElement","rendition","_rendition","dialogHelper","close","destroy","hide","_cancellationToken","shouldCancel","currentItem","_currentItem","currentTime","duration","getBufferedRanges","start","end","volume","isMuted","paused","seekable","e","keyboardnavigation","getKeyName","book","package","metadata","direction","prev","next","onTouchStart","touches","clientX","dom","getWindowSize","innerWidth","bindMediaElementEvents","addEventListener","once","querySelector","bindEvents","document","on","unbindMediaElementEvents","removeEventListener","off","TableOfContents","getElementById","createDialog","exitAnimationDuration","size","autoFocus","scrollY","exitAnimation","removeOnClose","innerHTML","html","open","_this","item","items","streamInfo","started","ended","mediaSource","Id","serverId","ServerId","apiClient","connectionManager","getApiClient","_resolve","_reject","imported","_interopRequireWildcard","has","get","newObj","hasPropertyDescriptor","getOwnPropertyDescriptor","hasOwnProperty","call","desc","set","_ref","epubjs","downloadHref","getItemDownloadUrl","openAs","renderTo","width","height","_currentSrc","cancellationToken","display","epubElem","style","locations","generate","regeneratorRuntime","mark","_callee","percentageTicks","resumeLocation","wrap","_callee$","_context","abrupt","startPositionTicks","cfiFromPercentage","percentageFromCfi","cfi","events","trigger","console","canPlayMediaType","mediaType","toLowerCase","canPlayItem","Path","endsWith","_default"],"mappings":"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","file":"plugin.js","sourcesContent":["import connectionManager from 'connectionManager';\nimport loading from 'loading';\nimport keyboardnavigation from 'keyboardnavigation';\nimport dialogHelper from 'dialogHelper';\nimport dom from 'dom';\nimport events from 'events';\nimport 'css!./style';\nimport 'material-icons';\nimport 'paper-icon-button-light';\n\nimport TableOfContents from './tableOfContents';\n\nexport class BookPlayer {\n    constructor() {\n        this.name = 'Book Player';\n        this.type = 'mediaplayer';\n        this.id = 'bookplayer';\n        this.priority = 1;\n\n        this.onDialogClosed = this.onDialogClosed.bind(this);\n        this.openTableOfContents = this.openTableOfContents.bind(this);\n        this.onWindowKeyUp = this.onWindowKeyUp.bind(this);\n    }\n\n    play(options) {\n        this._progress = 0;\n        this._loaded = false;\n\n        loading.show();\n        const elem = this.createMediaElement();\n        return this.setCurrentSrc(elem, options);\n    }\n\n    stop() {\n        this.unbindEvents();\n\n        const elem = this._mediaElement;\n        const tocElement = this._tocElement;\n        const rendition = this._rendition;\n\n        if (elem) {\n            dialogHelper.close(elem);\n            this._mediaElement = null;\n        }\n\n        if (tocElement) {\n            tocElement.destroy();\n            this._tocElement = null;\n        }\n\n        if (rendition) {\n            rendition.destroy();\n        }\n\n        // Hide loader in case player was not fully loaded yet\n        loading.hide();\n        this._cancellationToken.shouldCancel = true;\n    }\n\n    currentItem() {\n        return this._currentItem;\n    }\n\n    currentTime() {\n        return this._progress * 1000;\n    }\n\n    duration() {\n        return 1000;\n    }\n\n    getBufferedRanges() {\n        return [{\n            start: 0,\n            end: 10000000\n        }];\n    }\n\n    volume() {\n        return 100;\n    }\n\n    isMuted() {\n        return false;\n    }\n\n    paused() {\n        return false;\n    }\n\n    seekable() {\n        return true;\n    }\n\n    onWindowKeyUp(e) {\n        const key = keyboardnavigation.getKeyName(e);\n\n        // TODO: depending on the event this can be the document or the rendition itself\n        const rendition = this._rendition || this;\n        const book = rendition.book;\n\n        if (this._loaded === false) return;\n        switch (key) {\n            case 'l':\n            case 'ArrowRight':\n            case 'Right':\n                book.package.metadata.direction === 'rtl' ? rendition.prev() : rendition.next();\n                break;\n            case 'j':\n            case 'ArrowLeft':\n            case 'Left':\n                book.package.metadata.direction === 'rtl' ? rendition.next() : rendition.prev();\n                break;\n            case 'Escape':\n                if (this._tocElement) {\n                    // Close table of contents on ESC if it is open\n                    this._tocElement.destroy();\n                } else {\n                    // Otherwise stop the entire book player\n                    this.stop();\n                }\n                break;\n        }\n    }\n\n    onTouchStart(e) {\n        // TODO: depending on the event this can be the document or the rendition itself\n        const rendition = this._rendition || this;\n        const book = rendition.book;\n\n        // check that the event is from the book or the document\n        if (!book || this._loaded === false) return;\n\n        // epubjs stores pages off the screen or something for preloading\n        // get the modulus of the touch event to account for the increased width\n        if (!e.touches || e.touches.length === 0) return;\n\n        const touch = e.touches[0].clientX % dom.getWindowSize().innerWidth;\n        if (touch < dom.getWindowSize().innerWidth / 2) {\n            book.package.metadata.direction === 'rtl' ? rendition.next() : rendition.prev();\n        } else {\n            book.package.metadata.direction === 'rtl' ? rendition.prev() : rendition.next();\n        }\n    }\n\n    onDialogClosed() {\n        this.stop();\n    }\n\n    bindMediaElementEvents() {\n        const elem = this._mediaElement;\n\n        elem.addEventListener('close', this.onDialogClosed, {once: true});\n        elem.querySelector('.btnBookplayerExit').addEventListener('click', this.onDialogClosed, {once: true});\n        elem.querySelector('.btnBookplayerToc').addEventListener('click', this.openTableOfContents);\n    }\n\n    bindEvents() {\n        this.bindMediaElementEvents();\n\n        document.addEventListener('keyup', this.onWindowKeyUp);\n        document.addEventListener('touchstart', this.onTouchStart);\n\n        // FIXME: I don't really get why document keyup event is not triggered when epub is in focus\n        this._rendition.on('keyup', this.onWindowKeyUp);\n        this._rendition.on('touchstart', this.onTouchStart);\n    }\n\n    unbindMediaElementEvents() {\n        const elem = this._mediaElement;\n\n        elem.removeEventListener('close', this.onDialogClosed);\n        elem.querySelector('.btnBookplayerExit').removeEventListener('click', this.onDialogClosed);\n        elem.querySelector('.btnBookplayerToc').removeEventListener('click', this.openTableOfContents);\n    }\n\n    unbindEvents() {\n        if (this._mediaElement) {\n            this.unbindMediaElementEvents();\n        }\n\n        document.removeEventListener('keyup', this.onWindowKeyUp);\n        document.removeEventListener('touchstart', this.onTouchStart);\n\n        if (this._rendition) {\n            this._rendition.off('keyup', this.onWindowKeyUp);\n            this._rendition.off('touchstart', this.onTouchStart);\n        }\n    }\n\n    openTableOfContents() {\n        if (this._loaded) {\n            this._tocElement = new TableOfContents(this);\n        }\n    }\n\n    createMediaElement() {\n        let elem = this._mediaElement;\n        if (elem) {\n            return elem;\n        }\n\n        elem = document.getElementById('bookPlayer');\n        if (!elem) {\n            elem = dialogHelper.createDialog({\n                exitAnimationDuration: 400,\n                size: 'fullscreen',\n                autoFocus: false,\n                scrollY: false,\n                exitAnimation: 'fadeout',\n                removeOnClose: true\n            });\n\n            elem.id = 'bookPlayer';\n\n            let html = '';\n            html += '<div class=\"topRightActionButtons\">';\n            html += '<button is=\"paper-icon-button-light\" class=\"autoSize bookplayerButton btnBookplayerExit hide-mouse-idle-tv\" tabindex=\"-1\"><i class=\"material-icons bookplayerButtonIcon close\"></i></button>';\n            html += '</div>';\n            html += '<div class=\"topLeftActionButtons\">';\n            html += '<button is=\"paper-icon-button-light\" class=\"autoSize bookplayerButton btnBookplayerToc hide-mouse-idle-tv\" tabindex=\"-1\"><i class=\"material-icons bookplayerButtonIcon toc\"></i></button>';\n            html += '</div>';\n\n            elem.innerHTML = html;\n\n            dialogHelper.open(elem);\n        }\n\n        this._mediaElement = elem;\n\n        return elem;\n    }\n\n    setCurrentSrc(elem, options) {\n        const item = options.items[0];\n        this._currentItem = item;\n        this.streamInfo = {\n            started: true,\n            ended: false,\n            mediaSource: {\n                Id: item.Id\n            }\n        };\n\n        const serverId = item.ServerId;\n        const apiClient = connectionManager.getApiClient(serverId);\n\n        return new Promise((resolve, reject) => {\n            import('epubjs').then(({default: epubjs}) => {\n                const downloadHref = apiClient.getItemDownloadUrl(item.Id);\n                const book = epubjs(downloadHref, {openAs: 'epub'});\n                const rendition = book.renderTo(elem, {width: '100%', height: '97%'});\n\n                this._currentSrc = downloadHref;\n                this._rendition = rendition;\n                const cancellationToken = {\n                    shouldCancel: false\n                };\n\n                this._cancellationToken = cancellationToken;\n\n                return rendition.display().then(() => {\n                    const epubElem = document.querySelector('.epub-container');\n                    epubElem.style.display = 'none';\n\n                    this.bindEvents();\n\n                    return this._rendition.book.locations.generate(1024).then(async () => {\n                        if (cancellationToken.shouldCancel) {\n                            return reject();\n                        }\n\n                        const percentageTicks = options.startPositionTicks / 10000000;\n                        if (percentageTicks !== 0.0) {\n                            const resumeLocation = book.locations.cfiFromPercentage(percentageTicks);\n                            await rendition.display(resumeLocation);\n                        }\n\n                        this._loaded = true;\n                        epubElem.style.display = 'block';\n                        rendition.on('relocated', (locations) => {\n                            this._progress = book.locations.percentageFromCfi(locations.start.cfi);\n                            events.trigger(this, 'timeupdate');\n                        });\n\n                        loading.hide();\n\n                        return resolve();\n                    });\n                }, () => {\n                    console.error('failed to display epub');\n                    return reject();\n                });\n            });\n        });\n    }\n\n    canPlayMediaType(mediaType) {\n        return (mediaType || '').toLowerCase() === 'book';\n    }\n\n    canPlayItem(item) {\n        if (item.Path && (item.Path.endsWith('epub'))) {\n            return true;\n        }\n\n        return false;\n    }\n}\n\nexport default BookPlayer;\n"]}