define(["require","itemShortcuts","inputManager","connectionManager","playbackManager","imageLoader","layoutManager","browser","dom","loading","focusManager","serverNotifications","events","webcomponents"],(function(_require,_itemShortcuts,_inputManager,_connectionManager,_playbackManager,_imageLoader,_layoutManager,_browser,_dom,_loading,_focusManager,_serverNotifications,_events,_webcomponents){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var cache=new WeakMap;return _getRequireWildcardCache=function _getRequireWildcardCache(){return cache},cache}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache();if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}_itemShortcuts=_interopRequireDefault(_itemShortcuts),_inputManager=_interopRequireDefault(_inputManager),_connectionManager=_interopRequireDefault(_connectionManager),_playbackManager=_interopRequireDefault(_playbackManager),_imageLoader=_interopRequireDefault(_imageLoader),_layoutManager=_interopRequireDefault(_layoutManager),_browser=_interopRequireDefault(_browser),_dom=_interopRequireDefault(_dom),_loading=_interopRequireDefault(_loading),_focusManager=_interopRequireDefault(_focusManager),_serverNotifications=_interopRequireDefault(_serverNotifications),_events=_interopRequireDefault(_events);var ItemsContainerPrototype=Object.create(HTMLDivElement.prototype);function onClick(e){var multiSelect=this.multiSelect;multiSelect&&!1===multiSelect.onContainerClick.call(this,e)||_itemShortcuts.default.onClick.call(this,e)}function disableEvent(e){return e.preventDefault(),e.stopPropagation(),!1}function onContextMenu(e){var target=e.target,card=_dom.default.parentWithAttribute(target,"data-id");if(card&&card.getAttribute("data-serverid"))return _inputManager.default.handleCommand("menu",{sourceElement:card}),e.preventDefault(),e.stopPropagation(),!1}function onUserDataChanged(e,apiClient,userData){var itemsContainer=this;new Promise((function(_resolve,_reject){return _require(["cardBuilder"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref3){_ref3.default.onUserDataChanged(userData,itemsContainer)}));var eventsToMonitor=getEventsToMonitor(itemsContainer);(-1!==eventsToMonitor.indexOf("markfavorite")||-1!==eventsToMonitor.indexOf("markplayed"))&&itemsContainer.notifyRefreshNeeded()}function getEventsToMonitor(itemsContainer){var monitor=itemsContainer.getAttribute("data-monitor");return monitor?monitor.split(","):[]}function onTimerCreated(e,apiClient,data){var itemsContainer=this;if(-1===getEventsToMonitor(itemsContainer).indexOf("timers")){var programId=data.ProgramId,newTimerId=data.Id;new Promise((function(_resolve,_reject){return _require(["cardBuilder"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref4){_ref4.default.onTimerCreated(programId,newTimerId,itemsContainer)}))}else itemsContainer.notifyRefreshNeeded()}function onSeriesTimerCreated(e,apiClient,data){-1===getEventsToMonitor(this).indexOf("seriestimers")||this.notifyRefreshNeeded()}function onTimerCancelled(e,apiClient,data){var itemsContainer=this;-1===getEventsToMonitor(itemsContainer).indexOf("timers")?new Promise((function(_resolve,_reject){return _require(["cardBuilder"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref5){_ref5.default.onTimerCancelled(data.Id,itemsContainer)})):itemsContainer.notifyRefreshNeeded()}function onSeriesTimerCancelled(e,apiClient,data){var itemsContainer=this;-1===getEventsToMonitor(itemsContainer).indexOf("seriestimers")?new Promise((function(_resolve,_reject){return _require(["cardBuilder"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref6){_ref6.default.onSeriesTimerCancelled(data.Id,itemsContainer)})):itemsContainer.notifyRefreshNeeded()}function onLibraryChanged(e,apiClient,data){var eventsToMonitor=getEventsToMonitor(this);if(-1===eventsToMonitor.indexOf("seriestimers")&&-1===eventsToMonitor.indexOf("timers")){var itemsAdded=data.ItemsAdded||[],itemsRemoved=data.ItemsRemoved||[];if(itemsAdded.length||itemsRemoved.length){var parentId=this.getAttribute("data-parentid");if(parentId){var foldersAddedTo=data.FoldersAddedTo||[],foldersRemovedFrom=data.FoldersRemovedFrom||[],collectionFolders=data.CollectionFolders||[];if(-1===foldersAddedTo.indexOf(parentId)&&-1===foldersRemovedFrom.indexOf(parentId)&&-1===collectionFolders.indexOf(parentId))return}this.notifyRefreshNeeded()}}}function onPlaybackStopped(e,stopInfo){var state=stopInfo.state,eventsToMonitor=getEventsToMonitor(this);if(state.NowPlayingItem&&"Video"===state.NowPlayingItem.MediaType){if(-1!==eventsToMonitor.indexOf("videoplayback"))return void this.notifyRefreshNeeded(!0)}else if(state.NowPlayingItem&&"Audio"===state.NowPlayingItem.MediaType&&-1!==eventsToMonitor.indexOf("audioplayback"))return void this.notifyRefreshNeeded(!0)}function addNotificationEvent(instance,name,handler,owner){var localHandler=handler.bind(instance);owner=owner||_serverNotifications.default,_events.default.on(owner,name,localHandler),instance["event_"+name]=localHandler}function removeNotificationEvent(instance,name,owner){var handler=instance["event_"+name];handler&&(owner=owner||_serverNotifications.default,_events.default.off(owner,name,handler),instance["event_"+name]=null)}function clearRefreshInterval(itemsContainer,isPausing){itemsContainer.refreshInterval&&(clearInterval(itemsContainer.refreshInterval),itemsContainer.refreshInterval=null,isPausing||(itemsContainer.refreshIntervalEndTime=null))}function resetRefreshInterval(itemsContainer,intervalMs){clearRefreshInterval(itemsContainer),intervalMs||(intervalMs=parseInt(itemsContainer.getAttribute("data-refreshinterval")||"0")),intervalMs&&(itemsContainer.refreshInterval=setInterval(itemsContainer.notifyRefreshNeeded.bind(itemsContainer),intervalMs),itemsContainer.refreshIntervalEndTime=(new Date).getTime()+intervalMs)}function onDataFetched(result){var items=result.Items||result,parentContainer=this.parentContainer;parentContainer&&(items.length?parentContainer.classList.remove("hide"):parentContainer.classList.add("hide"));var focusId,hasActiveElement,activeElement=document.activeElement;this.contains(activeElement)&&(hasActiveElement=!0,focusId=activeElement.getAttribute("data-id")),this.innerHTML=this.getItemsHtml(items),_imageLoader.default.lazyChildren(this),hasActiveElement&&function setFocus(itemsContainer,focusId){if(focusId){var newElement=itemsContainer.querySelector('[data-id="'+focusId+'"]');if(newElement)try{return void _focusManager.default.focus(newElement)}catch(err){console.error(err)}}_focusManager.default.autoFocus(itemsContainer)}(this,focusId),resetRefreshInterval(this),this.afterRefresh&&this.afterRefresh(result)}ItemsContainerPrototype.enableMultiSelect=function(enabled){var current=this.multiSelect;if(enabled){if(!current){var self=this;new Promise((function(_resolve,_reject){return _require(["multiSelect"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref){var MultiSelect=_ref.default;self.multiSelect=new MultiSelect({container:self,bindOnClick:!1})}))}}else current&&(current.destroy(),this.multiSelect=null)},ItemsContainerPrototype.enableDragReordering=function(enabled){var current=this.sortable;if(enabled){if(!current){var self=this;new Promise((function(_resolve,_reject){return _require(["sortable"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref2){var Sortable=_ref2.default;self.sortable=new Sortable(self,{draggable:".listItem",handle:".listViewDragHandle",onEnd:function onEnd(evt){return function onDrop(evt,itemsContainer){var el=evt.item,newIndex=evt.newIndex,itemId=el.getAttribute("data-playlistitemid"),playlistId=el.getAttribute("data-playlistid");if(playlistId){var serverId=el.getAttribute("data-serverid"),apiClient=_connectionManager.default.getApiClient(serverId);_loading.default.show(),apiClient.ajax({url:apiClient.getUrl("Playlists/"+playlistId+"/Items/"+itemId+"/Move/"+newIndex),type:"POST"}).then((function(){_loading.default.hide()}),(function(){_loading.default.hide(),itemsContainer.refreshItems()}))}else{var oldIndex=evt.oldIndex;el.dispatchEvent(new CustomEvent("itemdrop",{detail:{oldIndex:oldIndex,newIndex:newIndex,playlistItemId:itemId},bubbles:!0,cancelable:!1}))}}(evt,self)}})}))}}else current&&(current.destroy(),this.sortable=null)},ItemsContainerPrototype.createdCallback=function(){this.classList.add("itemsContainer")},ItemsContainerPrototype.attachedCallback=function(){this.addEventListener("click",onClick),_browser.default.touch?this.addEventListener("contextmenu",disableEvent):"false"!==this.getAttribute("data-contextmenu")&&this.addEventListener("contextmenu",onContextMenu),(_layoutManager.default.desktop||_layoutManager.default.mobile)&&"false"!==this.getAttribute("data-multiselect")&&this.enableMultiSelect(!0),_layoutManager.default.tv&&this.classList.add("itemsContainer-tv"),_itemShortcuts.default.on(this,{click:!1}),addNotificationEvent(this,"UserDataChanged",onUserDataChanged),addNotificationEvent(this,"TimerCreated",onTimerCreated),addNotificationEvent(this,"SeriesTimerCreated",onSeriesTimerCreated),addNotificationEvent(this,"TimerCancelled",onTimerCancelled),addNotificationEvent(this,"SeriesTimerCancelled",onSeriesTimerCancelled),addNotificationEvent(this,"LibraryChanged",onLibraryChanged),addNotificationEvent(this,"playbackstop",onPlaybackStopped,_playbackManager.default),"true"===this.getAttribute("data-dragreorder")&&this.enableDragReordering(!0)},ItemsContainerPrototype.detachedCallback=function(){clearRefreshInterval(this),this.enableMultiSelect(!1),this.enableDragReordering(!1),this.removeEventListener("click",onClick),this.removeEventListener("contextmenu",onContextMenu),this.removeEventListener("contextmenu",disableEvent),_itemShortcuts.default.off(this,{click:!1}),removeNotificationEvent(this,"UserDataChanged"),removeNotificationEvent(this,"TimerCreated"),removeNotificationEvent(this,"SeriesTimerCreated"),removeNotificationEvent(this,"TimerCancelled"),removeNotificationEvent(this,"SeriesTimerCancelled"),removeNotificationEvent(this,"LibraryChanged"),removeNotificationEvent(this,"playbackstop",_playbackManager.default),this.fetchData=null,this.getItemsHtml=null,this.parentContainer=null},ItemsContainerPrototype.pause=function(){clearRefreshInterval(this,!0),this.paused=!0},ItemsContainerPrototype.resume=function(options){this.paused=!1;var refreshIntervalEndTime=this.refreshIntervalEndTime;if(refreshIntervalEndTime){var remainingMs=refreshIntervalEndTime-(new Date).getTime();remainingMs>0&&!this.needsRefresh?resetRefreshInterval(this,remainingMs):(this.needsRefresh=!0,this.refreshIntervalEndTime=null)}return this.needsRefresh||options&&options.refresh?this.refreshItems():Promise.resolve()},ItemsContainerPrototype.refreshItems=function(){return this.fetchData?this.paused?(this.needsRefresh=!0,Promise.resolve()):(this.needsRefresh=!1,this.fetchData().then(onDataFetched.bind(this))):Promise.resolve()},ItemsContainerPrototype.notifyRefreshNeeded=function(isInForeground){if(this.paused)this.needsRefresh=!0;else{var timeout=this.refreshTimeout;timeout&&clearTimeout(timeout),!0===isInForeground?this.refreshItems():this.refreshTimeout=setTimeout(this.refreshItems.bind(this),1e4)}},document.registerElement("emby-itemscontainer",{prototype:ItemsContainerPrototype,extends:"div"})}));
//# sourceMappingURL=emby-itemscontainer.js.map
