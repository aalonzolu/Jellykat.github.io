function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}define(["exports","jQuery","loading","events","globalize","serverNotifications","date-fns","dfnshelper","listViewStyle","emby-button"],(function(_exports,_jQuery,_loading,_events,_globalize,_serverNotifications,datefns,_dfnshelper,_listViewStyle,_embyButton){"use strict";function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var cache=new WeakMap;return _getRequireWildcardCache=function _getRequireWildcardCache(){return cache},cache}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function reloadList(page){ApiClient.getScheduledTasks({isHidden:!1}).then((function(tasks){!function populateList(page,tasks){var currentCategory;tasks=tasks.sort((function(a,b){return(a=a.Category+" "+a.Name)==(b=b.Category+" "+b.Name)?0:a<b?-1:1}));for(var html="",i=0;i<tasks.length;i++){var task=tasks[i];task.Category!=currentCategory&&((currentCategory=task.Category)&&(html+="</div>",html+="</div>"),html+='<div class="verticalSection verticalSection-extrabottompadding">',html+='<div class="sectionTitleContainer" style="margin-bottom:1em;">',html+='<h2 class="sectionTitle">',html+=currentCategory,html+="</h2>",0===i&&(html+='<a is="emby-linkbutton" class="raised button-alt headerHelpButton" target="_blank" href="https://docs.jellyfin.org/general/server/tasks.html">'+_globalize.default.translate("Help")+"</a>"),html+="</div>",html+='<div class="paperList">'),html+='<div class="listItem listItem-border scheduledTaskPaperIconItem" data-status="'+task.State+'">',html+="<a is='emby-linkbutton' style='margin:0;padding:0;' class='clearLink listItemIconContainer' href='scheduledtask.html?id="+task.Id+"'>",html+='<span class="material-icons listItemIcon schedule"></span>',html+="</a>",html+='<div class="listItemBody two-line">',html+="<a class='clearLink' style='margin:0;padding:0;display:block;text-align:left;' is='emby-linkbutton' href='scheduledtask.html?id="+task.Id+"'>",html+="<h3 class='listItemBodyText'>"+task.Name+"</h3>",html+="<div class='secondary listItemBodyText' id='taskProgress"+task.Id+"'>"+getTaskProgressHtml(task)+"</div>",html+="</a>",html+="</div>","Running"===task.State?html+='<button type="button" is="paper-icon-button-light" id="btnTask'+task.Id+'" class="btnStopTask" data-taskid="'+task.Id+'" title="'+_globalize.default.translate("ButtonStop")+'"><span class="material-icons stop"></span></button>':"Idle"===task.State&&(html+='<button type="button" is="paper-icon-button-light" id="btnTask'+task.Id+'" class="btnStartTask" data-taskid="'+task.Id+'" title="'+_globalize.default.translate("ButtonStart")+'"><span class="material-icons play_arrow"></span></button>'),html+="</div>"}tasks.length&&(html+="</div>",html+="</div>");page.querySelector(".divScheduledTasks").innerHTML=html}(page,tasks),_loading.default.hide()}))}function getTaskProgressHtml(task){var html="";if("Idle"===task.State){if(task.LastExecutionResult){var endtime=Date.parse(task.LastExecutionResult.EndTimeUtc),starttime=Date.parse(task.LastExecutionResult.StartTimeUtc);html+=_globalize.default.translate("LabelScheduledTaskLastRan",datefns.formatDistanceToNow(endtime,_dfnshelper.default.localeWithSuffix),datefns.formatDistance(starttime,endtime,{locale:_dfnshelper.default.getLocale()})),"Failed"===task.LastExecutionResult.Status?html+=" <span style='color:#FF0000;'>("+_globalize.default.translate("LabelFailed")+")</span>":"Cancelled"===task.LastExecutionResult.Status?html+=" <span style='color:#0026FF;'>("+_globalize.default.translate("LabelCancelled")+")</span>":"Aborted"===task.LastExecutionResult.Status&&(html+=" <span style='color:#FF0000;'>"+_globalize.default.translate("LabelAbortedByServerShutdown")+"</span>")}}else if("Running"===task.State){var progress=(task.CurrentProgressPercentage||0).toFixed(1);html+='<div style="display:flex;align-items:center;">',html+='<div class="taskProgressOuter" title="'+progress+'%" style="flex-grow:1;">',html+='<div class="taskProgressInner" style="width:'+progress+'%;">',html+="</div>",html+="</div>",html+="<span style='color:#00a4dc;margin-left:5px;'>"+progress+"%</span>",html+="</div>"}else html+="<span style='color:#FF0000;'>"+_globalize.default.translate("LabelStopping")+"</span>";return html}function setTaskButtonIcon(button,icon){var inner=button.querySelector(".material-icons");inner.classList.remove("stop","play_arrow"),inner.classList.add(icon)}function updateTaskButton(elem,state){"Running"===state?(elem.classList.remove("btnStartTask"),elem.classList.add("btnStopTask"),setTaskButtonIcon(elem,"stop"),elem.title=_globalize.default.translate("ButtonStop")):"Idle"===state&&(elem.classList.add("btnStartTask"),elem.classList.remove("btnStopTask"),setTaskButtonIcon(elem,"play_arrow"),elem.title=_globalize.default.translate("ButtonStart")),(0,_jQuery.default)(elem).parents(".listItem")[0].setAttribute("data-status",state)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=function _default(view,params){function onPollIntervalFired(){ApiClient.isMessageChannelOpen()||reloadList(view)}function onScheduledTasksUpdate(e,apiClient,info){apiClient.serverId()===serverId&&function updateTasks(tasks){for(var i=0;i<tasks.length;i++){var task=tasks[i];view.querySelector("#taskProgress"+task.Id).innerHTML=getTaskProgressHtml(task),updateTaskButton(view.querySelector("#btnTask"+task.Id),task.State)}}(info)}var pollInterval,serverId=ApiClient.serverId();(0,_jQuery.default)(".divScheduledTasks",view).on("click",".btnStartTask",(function(){var button=this,id=button.getAttribute("data-taskid");ApiClient.startScheduledTask(id).then((function(){updateTaskButton(button,"Running"),reloadList(view)}))})),(0,_jQuery.default)(".divScheduledTasks",view).on("click",".btnStopTask",(function(){var button=this,id=button.getAttribute("data-taskid");ApiClient.stopScheduledTask(id).then((function(){updateTaskButton(button,""),reloadList(view)}))})),view.addEventListener("viewbeforehide",(function(){_events.default.off(_serverNotifications.default,"ScheduledTasksInfo",onScheduledTasksUpdate),function stopInterval(){ApiClient.sendMessage("ScheduledTasksInfoStop"),pollInterval&&clearInterval(pollInterval)}()})),view.addEventListener("viewshow",(function(){_loading.default.show(),function startInterval(){ApiClient.sendMessage("ScheduledTasksInfoStart","1000,1000"),pollInterval&&clearInterval(pollInterval),pollInterval=setInterval(onPollIntervalFired,1e4)}(),reloadList(view),_events.default.on(_serverNotifications.default,"ScheduledTasksInfo",onScheduledTasksUpdate)}))},_jQuery=_interopRequireDefault(_jQuery),_loading=_interopRequireDefault(_loading),_events=_interopRequireDefault(_events),_globalize=_interopRequireDefault(_globalize),_serverNotifications=_interopRequireDefault(_serverNotifications),datefns=function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache();if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(datefns),_dfnshelper=_interopRequireDefault(_dfnshelper)}));
//# sourceMappingURL=scheduledtasks.js.map
