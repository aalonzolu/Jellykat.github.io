define(["require","exports","playbackManager","dom","inputManager","mouseManager","datetime","itemHelper","mediaInfo","focusManager","events","connectionManager","browser","globalize","apphost","layoutManager","userSettings","keyboardnavigation","scrollStyles","emby-slider","paper-icon-button-light","css!assets/css/videoosd"],(function(_require,_exports,_playbackManager,_dom,_inputManager,_mouseManager,_datetime,_itemHelper,_mediaInfo,_focusManager,_events,_connectionManager,_browser,_globalize,_apphost,_layoutManager,userSettings,_keyboardnavigation,_scrollStyles,_embySlider,_paperIconButtonLight,_videoosd){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var cache=new WeakMap;return _getRequireWildcardCache=function _getRequireWildcardCache(){return cache},cache}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache();if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function seriesImageUrl(item,options){if("Episode"!==item.Type)return null;if((options=options||{}).type=options.type||"Primary","Primary"===options.type&&item.SeriesPrimaryImageTag)return options.tag=item.SeriesPrimaryImageTag,_connectionManager.default.getApiClient(item.ServerId).getScaledImageUrl(item.SeriesId,options);if("Thumb"===options.type){if(item.SeriesThumbImageTag)return options.tag=item.SeriesThumbImageTag,_connectionManager.default.getApiClient(item.ServerId).getScaledImageUrl(item.SeriesId,options);if(item.ParentThumbImageTag)return options.tag=item.ParentThumbImageTag,_connectionManager.default.getApiClient(item.ServerId).getScaledImageUrl(item.ParentThumbItemId,options)}return null}function imageUrl(item,options){return(options=options||{}).type=options.type||"Primary",item.ImageTags&&item.ImageTags[options.type]?(options.tag=item.ImageTags[options.type],_connectionManager.default.getApiClient(item.ServerId).getScaledImageUrl(item.PrimaryImageItemId||item.Id,options)):"Primary"===options.type&&item.AlbumId&&item.AlbumPrimaryImageTag?(options.tag=item.AlbumPrimaryImageTag,_connectionManager.default.getApiClient(item.ServerId).getScaledImageUrl(item.AlbumId,options)):null}function getOpenedDialog(){return document.querySelector(".dialogContainer .dialog.opened")}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=function _default(view,params){function onVerticalSwipe(e,elem,data){var player=currentPlayer;if(player){var deltaY=data.currentDeltaY,windowSize=_dom.default.getWindowSize();if(supportsBrightnessChange&&data.clientX<windowSize.innerWidth/2)return void function doBrightnessTouch(deltaY,player,viewHeight){var delta=-deltaY/viewHeight*100,newValue=_playbackManager.default.getBrightness(player)+delta;newValue=Math.min(newValue,100),newValue=Math.max(newValue,0),_playbackManager.default.setBrightness(newValue,player)}(deltaY,player,windowSize.innerHeight);!function doVolumeTouch(deltaY,player,viewHeight){var delta=-deltaY/viewHeight*100,newValue=_playbackManager.default.getVolume(player)+delta;newValue=Math.min(newValue,100),newValue=Math.max(newValue,0),_playbackManager.default.setVolume(newValue,player)}(deltaY,player,windowSize.innerHeight)}}function updateRecordingButton(item){if(!item||"Program"!==item.Type)return recordingButtonManager&&(recordingButtonManager.destroy(),recordingButtonManager=null),void view.querySelector(".btnRecord").classList.add("hide");_connectionManager.default.getApiClient(item.ServerId).getCurrentUser().then((function(user){user.Policy.EnableLiveTvManagement&&new Promise((function(_resolve,_reject){return _require(["recordingButton"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref){var RecordingButton=_ref.default;recordingButtonManager?recordingButtonManager.refreshItem(item):(recordingButtonManager=new RecordingButton({item:item,button:view.querySelector(".btnRecord")}),view.querySelector(".btnRecord").classList.remove("hide"))}))}))}function updateDisplayItem(itemInfo){var item=itemInfo.originalItem;currentItem=item;var displayItem=itemInfo.displayItem||item;updateRecordingButton(displayItem),setPoster(displayItem,item);var parentName=displayItem.SeriesName||displayItem.Album;(displayItem.EpisodeTitle||displayItem.IsSeries)&&(parentName=displayItem.Name),function setTitle(item,parentName){Emby.Page.setTitle(parentName||"");var documentTitle=parentName||(item?item.Name:null);documentTitle&&(document.title=documentTitle)}(displayItem,parentName);var titleElement=view.querySelector(".osdTitle"),displayName=_itemHelper.default.getDisplayName(displayItem,{includeParentInfo:"Program"!==displayItem.Type,includeIndexNumber:"Program"!==displayItem.Type});displayName||(displayName=displayItem.Type),titleElement.innerHTML=displayName,displayName?titleElement.classList.remove("hide"):titleElement.classList.add("hide");var mediaInfoHtml=_mediaInfo.default.getPrimaryMediaInfoHtml(displayItem,{runtime:!1,subtitles:!1,tomatoes:!1,endsAt:!1,episodeTitle:!1,originalAirDate:"Program"!==displayItem.Type,episodeTitleIndexNumber:"Program"!==displayItem.Type,programIndicator:!1}),osdMediaInfo=view.querySelector(".osdMediaInfo");osdMediaInfo.innerHTML=mediaInfoHtml,mediaInfoHtml?osdMediaInfo.classList.remove("hide"):osdMediaInfo.classList.add("hide");var secondaryMediaInfo=view.querySelector(".osdSecondaryMediaInfo"),secondaryMediaInfoHtml=_mediaInfo.default.getSecondaryMediaInfoHtml(displayItem,{startDate:!1,programTime:!1});secondaryMediaInfo.innerHTML=secondaryMediaInfoHtml,secondaryMediaInfoHtml?secondaryMediaInfo.classList.remove("hide"):secondaryMediaInfo.classList.add("hide"),displayName?view.querySelector(".osdMainTextContainer").classList.remove("hide"):view.querySelector(".osdMainTextContainer").classList.add("hide"),enableProgressByTimeOfDay?(setDisplayTime(startTimeText,displayItem.StartDate),setDisplayTime(endTimeText,displayItem.EndDate),startTimeText.classList.remove("hide"),endTimeText.classList.remove("hide"),programStartDateMs=displayItem.StartDate?_datetime.default.parseISO8601Date(displayItem.StartDate).getTime():0,programEndDateMs=displayItem.EndDate?_datetime.default.parseISO8601Date(displayItem.EndDate).getTime():0):(startTimeText.classList.add("hide"),endTimeText.classList.add("hide"),startTimeText.innerHTML="",endTimeText.innerHTML="",programStartDateMs=0,programEndDateMs=0)}function getDisplayTimeWithoutAmPm(date,showSeconds){return showSeconds?_datetime.default.toLocaleTimeString(date,{hour:"numeric",minute:"2-digit",second:"2-digit"}).toLowerCase().replace("am","").replace("pm","").trim():_datetime.default.getDisplayTime(date).toLowerCase().replace("am","").replace("pm","").trim()}function setDisplayTime(elem,date){var html;date&&(html=getDisplayTimeWithoutAmPm(date=_datetime.default.parseISO8601Date(date))),elem.innerHTML=html||""}function updateNowPlayingInfo(player,state){var item=state.NowPlayingItem;if(currentItem=item,!item)return setPoster(null),updateRecordingButton(null),Emby.Page.setTitle(""),nowPlayingVolumeSlider.disabled=!0,nowPlayingPositionSlider.disabled=!0,btnFastForward.disabled=!0,btnRewind.disabled=!0,view.querySelector(".btnSubtitles").classList.add("hide"),view.querySelector(".btnAudio").classList.add("hide"),view.querySelector(".osdTitle").innerHTML="",void(view.querySelector(".osdMediaInfo").innerHTML="");enableProgressByTimeOfDay=function shouldEnableProgressByTimeOfDay(item){return!("TvChannel"!==item.Type||!item.CurrentProgram)}(item),function getDisplayItem(item){if("TvChannel"===item.Type){var apiClient=_connectionManager.default.getApiClient(item.ServerId);return apiClient.getItem(apiClient.getCurrentUserId(),item.Id).then((function(refreshedItem){return{originalItem:refreshedItem,displayItem:refreshedItem.CurrentProgram}}))}return Promise.resolve({originalItem:item})}(item).then(updateDisplayItem),nowPlayingVolumeSlider.disabled=!1,nowPlayingPositionSlider.disabled=!1,btnFastForward.disabled=!1,btnRewind.disabled=!1,_playbackManager.default.subtitleTracks(player).length?(view.querySelector(".btnSubtitles").classList.remove("hide"),toggleSubtitleSync()):(view.querySelector(".btnSubtitles").classList.add("hide"),toggleSubtitleSync("forceToHide")),_playbackManager.default.audioTracks(player).length>1?view.querySelector(".btnAudio").classList.remove("hide"):view.querySelector(".btnAudio").classList.add("hide")}function setPoster(item,secondaryItem){var osdPoster=view.querySelector(".osdPoster");if(item){var imgUrl=seriesImageUrl(item,{maxWidth:osdPoster.clientWidth,type:"Primary"})||seriesImageUrl(item,{maxWidth:osdPoster.clientWidth,type:"Thumb"})||imageUrl(item,{maxWidth:osdPoster.clientWidth,type:"Primary"});if(!imgUrl&&secondaryItem&&(imgUrl=seriesImageUrl(secondaryItem,{maxWidth:osdPoster.clientWidth,type:"Primary"})||seriesImageUrl(secondaryItem,{maxWidth:osdPoster.clientWidth,type:"Thumb"})||imageUrl(secondaryItem,{maxWidth:osdPoster.clientWidth,type:"Primary"})),imgUrl)return void(osdPoster.innerHTML='<img src="'+imgUrl+'" />')}osdPoster.innerHTML=""}var clickedElement,playPauseClickTimeout,currentPlayer,comingUpNextDisplayed,currentUpNextDialog,isEnabled,currentItem,recordingButtonManager,enableProgressByTimeOfDay,supportsBrightnessChange,currentVisibleMenu,statsOverlay,osdHideTimeout,lastPointerMoveData,mouseIsDown=!1;function showOsd(){!function slideDownToShow(elem){elem.classList.remove("osdHeader-hidden")}(headerElement),function showMainOsdControls(){if(!currentVisibleMenu){var elem=osdBottomElement;currentVisibleMenu="osd",clearHideAnimationEventListeners(elem),elem.classList.remove("hide"),elem.classList.remove("videoOsdBottom-hidden"),_layoutManager.default.mobile||setTimeout((function(){_focusManager.default.focus(elem.querySelector(".btnPause"))}),50),toggleSubtitleSync()}}(),resetIdle()}function hideOsd(){!function slideUpToHide(elem){elem.classList.add("osdHeader-hidden")}(headerElement),function hideMainOsdControls(){if("osd"===currentVisibleMenu){var elem=osdBottomElement;clearHideAnimationEventListeners(elem),elem.classList.add("videoOsdBottom-hidden"),_dom.default.addEventListener(elem,transitionEndEventName,onHideAnimationComplete,{once:!0}),currentVisibleMenu=null,toggleSubtitleSync("hide"),document.activeElement&&document.activeElement.blur()}}(),_mouseManager.default.hideCursor()}function stopOsdHideTimer(){osdHideTimeout&&(clearTimeout(osdHideTimeout),osdHideTimeout=null)}function clearHideAnimationEventListeners(elem){_dom.default.removeEventListener(elem,transitionEndEventName,onHideAnimationComplete,{once:!0})}function onHideAnimationComplete(e){var elem=e.target;elem==osdBottomElement&&(elem.classList.add("hide"),_dom.default.removeEventListener(elem,transitionEndEventName,onHideAnimationComplete,{once:!0}))}function resetIdle(){!currentVisibleMenu||mouseIsDown||getOpenedDialog()?stopOsdHideTimer():function startOsdHideTimer(){stopOsdHideTimer(),osdHideTimeout=setTimeout(hideOsd,3e3)}()}function onPointerMove(e){if("mouse"===(e.pointerType||(_layoutManager.default.mobile?"touch":"mouse"))){var eventX=e.screenX||0,eventY=e.screenY||0,obj=lastPointerMoveData;if(!obj)return void(lastPointerMoveData={x:eventX,y:eventY});if(Math.abs(eventX-obj.x)<10&&Math.abs(eventY-obj.y)<10)return;obj.x=eventX,obj.y=eventY,showOsd()}}function onInputCommand(e){var player=currentPlayer;switch(e.detail.command){case"left":"osd"===currentVisibleMenu?showOsd():currentVisibleMenu||(e.preventDefault(),_playbackManager.default.rewind(player));break;case"right":"osd"===currentVisibleMenu?showOsd():currentVisibleMenu||(e.preventDefault(),_playbackManager.default.fastForward(player));break;case"pageup":_playbackManager.default.nextChapter(player);break;case"pagedown":_playbackManager.default.previousChapter(player);break;case"up":case"down":case"select":case"menu":case"info":case"play":case"playpause":case"pause":case"fastforward":case"rewind":case"next":case"previous":showOsd();break;case"record":!function onRecordingCommand(){var btnRecord=view.querySelector(".btnRecord");btnRecord.classList.contains("hide")||btnRecord.click()}(),showOsd();break;case"togglestats":toggleStats()}}function updateFullscreenIcon(){var button=view.querySelector(".btnFullscreen"),icon=button.querySelector(".material-icons");icon.classList.remove("fullscreen_exit","fullscreen"),_playbackManager.default.isFullscreen(currentPlayer)?(button.setAttribute("title",_globalize.default.translate("ExitFullscreen")+" (f)"),icon.classList.add("fullscreen_exit")):(button.setAttribute("title",_globalize.default.translate("Fullscreen")+" (f)"),icon.classList.add("fullscreen"))}function onPlayerChange(){bindToPlayer(_playbackManager.default.getCurrentPlayer())}function onStateChanged(event,state){state.NowPlayingItem&&(isEnabled=!0,function updatePlayerStateInternal(event,player,state){var playState=state.PlayState||{};updatePlayPauseState(playState.IsPaused);var supportedCommands=_playbackManager.default.getSupportedCommands(player);currentPlayerSupportedCommands=supportedCommands,supportsBrightnessChange=-1!==supportedCommands.indexOf("SetBrightness"),updatePlayerVolumeState(player,playState.IsMuted,playState.VolumeLevel),nowPlayingPositionSlider&&!nowPlayingPositionSlider.dragging&&(nowPlayingPositionSlider.disabled=!playState.CanSeek);btnFastForward.disabled=!playState.CanSeek,btnRewind.disabled=!playState.CanSeek;var nowPlayingItem=state.NowPlayingItem||{};playbackStartTimeTicks=playState.PlaybackStartTimeTicks,updateTimeDisplay(playState.PositionTicks,nowPlayingItem.RunTimeTicks,playState.PlaybackStartTimeTicks,playState.BufferedRanges||[]),updateNowPlayingInfo(player,state),state.MediaSource&&state.MediaSource.SupportsTranscoding&&-1!==supportedCommands.indexOf("SetMaxStreamingBitrate")?view.querySelector(".btnVideoOsdSettings").classList.remove("hide"):view.querySelector(".btnVideoOsdSettings").classList.add("hide");var isProgressClear=state.MediaSource&&null==state.MediaSource.RunTimeTicks;nowPlayingPositionSlider.setIsClear(isProgressClear),nowPlayingItem.RunTimeTicks&&nowPlayingPositionSlider.setKeyboardSteps(1e6*userSettings.skipBackLength()/nowPlayingItem.RunTimeTicks,1e6*userSettings.skipForwardLength()/nowPlayingItem.RunTimeTicks);-1===supportedCommands.indexOf("ToggleFullscreen")||player.isLocalPlayer&&_layoutManager.default.tv&&_playbackManager.default.isFullscreen(player)?view.querySelector(".btnFullscreen").classList.add("hide"):view.querySelector(".btnFullscreen").classList.remove("hide");-1===supportedCommands.indexOf("PictureInPicture")?view.querySelector(".btnPip").classList.add("hide"):view.querySelector(".btnPip").classList.remove("hide");-1===supportedCommands.indexOf("AirPlay")?view.querySelector(".btnAirPlay").classList.add("hide"):view.querySelector(".btnAirPlay").classList.remove("hide");updateFullscreenIcon()}(0,this,state),function updatePlaylist(player){var btnPreviousTrack=view.querySelector(".btnPreviousTrack"),btnNextTrack=view.querySelector(".btnNextTrack");btnPreviousTrack.classList.remove("hide"),btnNextTrack.classList.remove("hide"),btnNextTrack.disabled=!1,btnPreviousTrack.disabled=!1}(),function enableStopOnBack(enabled){view.removeEventListener("viewbeforehide",onViewHideStopPlayback),enabled&&_playbackManager.default.isPlayingVideo(currentPlayer)&&view.addEventListener("viewbeforehide",onViewHideStopPlayback)}(!0))}function onPlayPauseStateChanged(e){isEnabled&&updatePlayPauseState(this.paused())}function onVolumeChanged(e){if(isEnabled){updatePlayerVolumeState(this,this.isMuted(),this.getVolume())}}function onPlaybackStart(e,state){console.debug("nowplaying event: "+e.type);onStateChanged.call(this,e,state),resetUpNextDialog()}function resetUpNextDialog(){comingUpNextDisplayed=!1;currentUpNextDialog&&(currentUpNextDialog.destroy(),currentUpNextDialog=null)}function onPlaybackStopped(e,state){currentRuntimeTicks=null,resetUpNextDialog(),console.debug("nowplaying event: "+e.type),"Video"!==state.NextMediaType&&(view.removeEventListener("viewbeforehide",onViewHideStopPlayback),Emby.Page.back())}function onMediaStreamsChanged(e){var state=_playbackManager.default.getPlayerState(this);onStateChanged.call(this,{type:"init"},state)}function onBeginFetch(){document.querySelector(".osdMediaStatus").classList.remove("hide")}function onEndFetch(){document.querySelector(".osdMediaStatus").classList.add("hide")}function bindToPlayer(player){if(player===currentPlayer||(releaseCurrentPlayer(),currentPlayer=player,player)){var state=_playbackManager.default.getPlayerState(player);onStateChanged.call(player,{type:"init"},state),_events.default.on(player,"playbackstart",onPlaybackStart),_events.default.on(player,"playbackstop",onPlaybackStopped),_events.default.on(player,"volumechange",onVolumeChanged),_events.default.on(player,"pause",onPlayPauseStateChanged),_events.default.on(player,"unpause",onPlayPauseStateChanged),_events.default.on(player,"timeupdate",onTimeUpdate),_events.default.on(player,"fullscreenchange",updateFullscreenIcon),_events.default.on(player,"mediastreamschange",onMediaStreamsChanged),_events.default.on(player,"beginFetch",onBeginFetch),_events.default.on(player,"endFetch",onEndFetch),resetUpNextDialog(),player.isFetching&&onBeginFetch()}}function releaseCurrentPlayer(){destroyStats(),destroySubtitleSync(),resetUpNextDialog();var player=currentPlayer;player&&(_events.default.off(player,"playbackstart",onPlaybackStart),_events.default.off(player,"playbackstop",onPlaybackStopped),_events.default.off(player,"volumechange",onVolumeChanged),_events.default.off(player,"pause",onPlayPauseStateChanged),_events.default.off(player,"unpause",onPlayPauseStateChanged),_events.default.off(player,"timeupdate",onTimeUpdate),_events.default.off(player,"fullscreenchange",updateFullscreenIcon),_events.default.off(player,"mediastreamschange",onMediaStreamsChanged),currentPlayer=null)}function onTimeUpdate(e){if(isEnabled&&currentItem){var now=(new Date).getTime();if(!(now-lastUpdateTime<700)){lastUpdateTime=now;currentRuntimeTicks=_playbackManager.default.duration(this);var currentTime=_playbackManager.default.currentTime(this);updateTimeDisplay(currentTime,currentRuntimeTicks,_playbackManager.default.playbackStartTime(this),_playbackManager.default.getBufferedRanges(this));var item=currentItem;!function refreshProgramInfoIfNeeded(player,item){if("TvChannel"===item.Type){var program=item.CurrentProgram;if(program&&program.EndDate)try{var endDate=_datetime.default.parseISO8601Date(program.EndDate);if((new Date).getTime()>=endDate.getTime()){console.debug("program info needs to be refreshed");var state=_playbackManager.default.getPlayerState(player);onStateChanged.call(player,{type:"init"},state)}}catch(e){console.error("error parsing date: "+program.EndDate)}}}(this,item),function showComingUpNextIfNeeded(player,currentItem,currentTimeTicks,runtimeTicks){if(runtimeTicks&&currentTimeTicks&&!comingUpNextDisplayed&&!currentVisibleMenu&&"Episode"===currentItem.Type&&userSettings.enableNextVideoInfoOverlay()){var timeRemainingTicks=runtimeTicks-currentTimeTicks;currentTimeTicks>=runtimeTicks-1e3*(runtimeTicks>=3e10?40:runtimeTicks>=24e9?35:30)*1e4&&runtimeTicks>=6e9&&timeRemainingTicks>=2e8&&function showComingUpNext(player){new Promise((function(_resolve,_reject){return _require(["upNextDialog"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref2){var UpNextDialog=_ref2.default;currentVisibleMenu||currentUpNextDialog||(currentVisibleMenu="upnext",comingUpNextDisplayed=!0,_playbackManager.default.nextItem(player).then((function(nextItem){currentUpNextDialog=new UpNextDialog({parent:view.querySelector(".upNextContainer"),player:player,nextItem:nextItem}),_events.default.on(currentUpNextDialog,"hide",onUpNextHidden)}),onUpNextHidden))}))}(player)}}(this,item,currentTime,currentRuntimeTicks)}}}function onUpNextHidden(){"upnext"===currentVisibleMenu&&(currentVisibleMenu=null)}function updatePlayPauseState(isPaused){var btnPlayPause=view.querySelector(".btnPause"),btnPlayPauseIcon=btnPlayPause.querySelector(".material-icons");btnPlayPauseIcon.classList.remove("play_arrow","pause"),isPaused?(btnPlayPauseIcon.classList.add("play_arrow"),btnPlayPause.setAttribute("title",_globalize.default.translate("Play")+" (k)")):(btnPlayPauseIcon.classList.add("pause"),btnPlayPause.setAttribute("title",_globalize.default.translate("ButtonPause")+" (k)"))}function getDisplayPercentByTimeOfDay(programStartDateMs,programRuntimeMs,currentTimeMs){return(currentTimeMs-programStartDateMs)/programRuntimeMs*100}function updateTimeDisplay(positionTicks,runtimeTicks,playbackStartTimeTicks,bufferedRanges){if(enableProgressByTimeOfDay){if(nowPlayingPositionSlider&&!nowPlayingPositionSlider.dragging)if(programStartDateMs&&programEndDateMs){var currentTimeMs=(playbackStartTimeTicks+(positionTicks||0))/1e4,programRuntimeMs=programEndDateMs-programStartDateMs;if(nowPlayingPositionSlider.value=getDisplayPercentByTimeOfDay(programStartDateMs,programRuntimeMs,currentTimeMs),bufferedRanges.length){var rangeStart=getDisplayPercentByTimeOfDay(programStartDateMs,programRuntimeMs,(playbackStartTimeTicks+(bufferedRanges[0].start||0))/1e4),rangeEnd=getDisplayPercentByTimeOfDay(programStartDateMs,programRuntimeMs,(playbackStartTimeTicks+(bufferedRanges[0].end||0))/1e4);nowPlayingPositionSlider.setBufferedRanges([{start:rangeStart,end:rangeEnd}])}else nowPlayingPositionSlider.setBufferedRanges([])}else nowPlayingPositionSlider.value=0,nowPlayingPositionSlider.setBufferedRanges([]);nowPlayingPositionText.innerHTML="",nowPlayingDurationText.innerHTML=""}else{if(nowPlayingPositionSlider&&!nowPlayingPositionSlider.dragging){if(runtimeTicks){var pct=positionTicks/runtimeTicks;pct*=100,nowPlayingPositionSlider.value=pct}else nowPlayingPositionSlider.value=0;runtimeTicks&&null!=positionTicks&&currentRuntimeTicks&&!enableProgressByTimeOfDay&&currentItem.RunTimeTicks&&"Recording"!==currentItem.Type?endsAtText.innerHTML="&nbsp;&nbsp;-&nbsp;&nbsp;"+_mediaInfo.default.getEndsAtFromPosition(runtimeTicks,positionTicks,!0):endsAtText.innerHTML=""}nowPlayingPositionSlider&&nowPlayingPositionSlider.setBufferedRanges(bufferedRanges,runtimeTicks,positionTicks),updateTimeText(nowPlayingPositionText,positionTicks),updateTimeText(nowPlayingDurationText,runtimeTicks,!0)}}function updatePlayerVolumeState(player,isMuted,volumeLevel){var supportedCommands=currentPlayerSupportedCommands,showMuteButton=!0,showVolumeSlider=!0;-1===supportedCommands.indexOf("Mute")&&(showMuteButton=!1),-1===supportedCommands.indexOf("SetVolume")&&(showVolumeSlider=!1),player.isLocalPlayer&&_apphost.default.supports("physicalvolumecontrol")&&(showMuteButton=!1,showVolumeSlider=!1);var buttonMute=view.querySelector(".buttonMute"),buttonMuteIcon=buttonMute.querySelector(".material-icons");buttonMuteIcon.classList.remove("volume_off","volume_up"),isMuted?(buttonMute.setAttribute("title",_globalize.default.translate("Unmute")+" (m)"),buttonMuteIcon.classList.add("volume_off")):(buttonMute.setAttribute("title",_globalize.default.translate("Mute")+" (m)"),buttonMuteIcon.classList.add("volume_up")),showMuteButton?buttonMute.classList.remove("hide"):buttonMute.classList.add("hide"),nowPlayingVolumeSlider&&(showVolumeSlider?nowPlayingVolumeSliderContainer.classList.remove("hide"):nowPlayingVolumeSliderContainer.classList.add("hide"),nowPlayingVolumeSlider.dragging||(nowPlayingVolumeSlider.value=volumeLevel||0))}function updateTimeText(elem,ticks,divider){if(null!=ticks){var html=_datetime.default.getDisplayRunningTime(ticks);divider&&(html="&nbsp;/&nbsp;"+html),elem.innerHTML=html}else elem.innerHTML=""}function onSettingsOption(selectedOption){if("stats"===selectedOption)toggleStats();else if("suboffset"===selectedOption){var player=currentPlayer;player&&(_playbackManager.default.enableShowingSubtitleOffset(player),toggleSubtitleSync())}}function toggleStats(){new Promise((function(_resolve,_reject){return _require(["playerStats"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref4){var PlayerStats=_ref4.default,player=currentPlayer;player&&(statsOverlay?statsOverlay.toggle():statsOverlay=new PlayerStats({player:player}))}))}function destroyStats(){statsOverlay&&(statsOverlay.destroy(),statsOverlay=null)}function toggleSubtitleSync(action){new Promise((function(_resolve,_reject){return _require(["subtitleSync"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref7){var SubtitleSync=_ref7.default,player=currentPlayer;subtitleSyncOverlay?subtitleSyncOverlay.toggle(action):player&&(subtitleSyncOverlay=new SubtitleSync(player))}))}function destroySubtitleSync(){subtitleSyncOverlay&&(subtitleSyncOverlay.destroy(),subtitleSyncOverlay=null)}function onKeyDown(e){clickedElement=e.target;var key=_keyboardnavigation.default.getKeyName(e),isKeyModified=e.ctrlKey||e.altKey||e.metaKey;if(!currentVisibleMenu&&32===e.keyCode)return _playbackManager.default.playPause(currentPlayer),void showOsd();if(_layoutManager.default.tv&&_keyboardnavigation.default.isNavigationKey(key))showOsd();else switch(key){case"Enter":showOsd();break;case"Escape":case"Back":"osd"!==currentVisibleMenu||getOpenedDialog()||(hideOsd(),e.stopPropagation());break;case"k":_playbackManager.default.playPause(currentPlayer),showOsd();break;case"ArrowUp":case"Up":_playbackManager.default.volumeUp(currentPlayer);break;case"ArrowDown":case"Down":_playbackManager.default.volumeDown(currentPlayer);break;case"l":case"ArrowRight":case"Right":_playbackManager.default.fastForward(currentPlayer),showOsd();break;case"j":case"ArrowLeft":case"Left":_playbackManager.default.rewind(currentPlayer),showOsd();break;case"f":e.ctrlKey||e.metaKey||(_playbackManager.default.toggleFullscreen(currentPlayer),showOsd());break;case"m":_playbackManager.default.toggleMute(currentPlayer),showOsd();break;case"p":case"P":e.shiftKey&&_playbackManager.default.previousTrack(currentPlayer);break;case"n":case"N":e.shiftKey&&_playbackManager.default.nextTrack(currentPlayer);break;case"NavigationLeft":case"GamepadDPadLeft":case"GamepadLeftThumbstickLeft":document.hasFocus()&&(_playbackManager.default.rewind(currentPlayer),showOsd());break;case"NavigationRight":case"GamepadDPadRight":case"GamepadLeftThumbstickRight":document.hasFocus()&&(_playbackManager.default.fastForward(currentPlayer),showOsd());break;case"Home":_playbackManager.default.seekPercent(0,currentPlayer);break;case"End":_playbackManager.default.seekPercent(100,currentPlayer);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":if(!isKeyModified){var percent=10*parseInt(key,10);_playbackManager.default.seekPercent(percent,currentPlayer)}break;case">":_playbackManager.default.increasePlaybackRate(currentPlayer);break;case"<":_playbackManager.default.decreasePlaybackRate(currentPlayer)}}function onKeyDownCapture(){resetIdle()}function onWindowMouseDown(e){clickedElement=e.target,mouseIsDown=!0,resetIdle()}function onWindowMouseUp(){mouseIsDown=!1,resetIdle()}function onWindowTouchStart(e){clickedElement=e.target,mouseIsDown=!0,resetIdle()}function onWindowTouchEnd(){mouseIsDown=!1,resetIdle()}function onWindowDragEnd(){mouseIsDown=!1,resetIdle()}function onViewHideStopPlayback(){if(_playbackManager.default.isPlayingVideo()){new Promise((function(_resolve,_reject){return _require(["shell"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref8){_ref8.default.disableFullscreen()})),clearTimeout(playPauseClickTimeout);var player=currentPlayer;view.removeEventListener("viewbeforehide",onViewHideStopPlayback),releaseCurrentPlayer(),_playbackManager.default.stop(player)}}new Promise((function(_resolve,_reject){return _require(["shell"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref9){_ref9.default.enableFullscreen()}));var subtitleSyncOverlay,self=this,currentPlayerSupportedCommands=[],currentRuntimeTicks=0,lastUpdateTime=0,programStartDateMs=0,programEndDateMs=0,playbackStartTimeTicks=0,nowPlayingVolumeSlider=view.querySelector(".osdVolumeSlider"),nowPlayingVolumeSliderContainer=view.querySelector(".osdVolumeSliderContainer"),nowPlayingPositionSlider=view.querySelector(".osdPositionSlider"),nowPlayingPositionText=view.querySelector(".osdPositionText"),nowPlayingDurationText=view.querySelector(".osdDurationText"),startTimeText=view.querySelector(".startTimeText"),endTimeText=view.querySelector(".endTimeText"),endsAtText=view.querySelector(".endsAtText"),btnRewind=view.querySelector(".btnRewind"),btnFastForward=view.querySelector(".btnFastForward"),transitionEndEventName=_dom.default.whichTransitionEvent(),headerElement=document.querySelector(".skinHeader"),osdBottomElement=document.querySelector(".videoOsdBottom-maincontrols");nowPlayingPositionSlider.enableKeyboardDragging(),nowPlayingVolumeSlider.enableKeyboardDragging(),_layoutManager.default.tv&&nowPlayingPositionSlider.classList.add("focusable");view.addEventListener("viewbeforeshow",(function(e){headerElement.classList.add("osdHeader"),Emby.Page.setTransparency("full")})),view.addEventListener("viewshow",(function(e){try{_events.default.on(_playbackManager.default,"playerchange",onPlayerChange),bindToPlayer(_playbackManager.default.getCurrentPlayer()),_dom.default.addEventListener(document,window.PointerEvent?"pointermove":"mousemove",onPointerMove,{passive:!0}),showOsd(),_inputManager.default.on(window,onInputCommand),document.addEventListener("keydown",onKeyDown),_dom.default.addEventListener(document,"keydown",onKeyDownCapture,{capture:!0,passive:!0}),_dom.default.addEventListener(window,window.PointerEvent?"pointerdown":"mousedown",onWindowMouseDown,{capture:!0,passive:!0}),_dom.default.addEventListener(window,window.PointerEvent?"pointerup":"mouseup",onWindowMouseUp,{capture:!0,passive:!0}),_dom.default.addEventListener(window,"touchstart",onWindowTouchStart,{capture:!0,passive:!0}),["touchend","touchcancel"].forEach((function(event){_dom.default.addEventListener(window,event,onWindowTouchEnd,{capture:!0,passive:!0})})),_dom.default.addEventListener(window,"dragend",onWindowDragEnd,{capture:!0,passive:!0})}catch(e){new Promise((function(_resolve,_reject){return _require(["appRouter"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref10){_ref10.default.goHome()}))}})),view.addEventListener("viewbeforehide",(function(){statsOverlay&&statsOverlay.enabled(!1),document.removeEventListener("keydown",onKeyDown),_dom.default.removeEventListener(document,"keydown",onKeyDownCapture,{capture:!0,passive:!0}),_dom.default.removeEventListener(window,window.PointerEvent?"pointerdown":"mousedown",onWindowMouseDown,{capture:!0,passive:!0}),_dom.default.removeEventListener(window,window.PointerEvent?"pointerup":"mouseup",onWindowMouseUp,{capture:!0,passive:!0}),_dom.default.removeEventListener(window,"touchstart",onWindowTouchStart,{capture:!0,passive:!0}),["touchend","touchcancel"].forEach((function(event){_dom.default.removeEventListener(window,event,onWindowTouchEnd,{capture:!0,passive:!0})})),_dom.default.removeEventListener(window,"dragend",onWindowDragEnd,{capture:!0,passive:!0}),stopOsdHideTimer(),headerElement.classList.remove("osdHeader"),headerElement.classList.remove("osdHeader-hidden"),_dom.default.removeEventListener(document,window.PointerEvent?"pointermove":"mousemove",onPointerMove,{passive:!0}),_inputManager.default.off(window,onInputCommand),_events.default.off(_playbackManager.default,"playerchange",onPlayerChange),releaseCurrentPlayer()})),view.querySelector(".btnFullscreen").addEventListener("click",(function(){_playbackManager.default.toggleFullscreen(currentPlayer)})),view.querySelector(".btnPip").addEventListener("click",(function(){_playbackManager.default.togglePictureInPicture(currentPlayer)})),view.querySelector(".btnAirPlay").addEventListener("click",(function(){_playbackManager.default.toggleAirPlay(currentPlayer)})),view.querySelector(".btnVideoOsdSettings").addEventListener("click",(function onSettingsButtonClick(e){var btn=this;new Promise((function(_resolve,_reject){return _require(["playerSettingsMenu"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref3){var playerSettingsMenu=_ref3.default,player=currentPlayer;if(player){var showSubOffset=_playbackManager.default.supportSubtitleOffset(player)&&_playbackManager.default.canHandleOffsetOnCurrentSubtitle(player);playerSettingsMenu.show({mediaType:"Video",player:player,positionTo:btn,stats:!0,suboffset:showSubOffset,onOption:onSettingsOption}).finally((function(){resetIdle()})),setTimeout(resetIdle,0)}}))})),view.addEventListener("viewhide",(function(){headerElement.classList.remove("hide")})),view.addEventListener("viewdestroy",(function(){self.touchHelper&&(self.touchHelper.destroy(),self.touchHelper=null),recordingButtonManager&&(recordingButtonManager.destroy(),recordingButtonManager=null),destroyStats(),destroySubtitleSync()}));var lastPointerDown=0;if(_dom.default.addEventListener(view,window.PointerEvent?"pointerdown":"click",(function(e){if(_dom.default.parentWithClass(e.target,["videoOsdBottom","upNextContainer"]))showOsd();else{var pointerType=e.pointerType||(_layoutManager.default.mobile?"touch":"mouse"),now=(new Date).getTime();switch(pointerType){case"touch":now-lastPointerDown>300&&(lastPointerDown=now,function toggleOsd(){"osd"===currentVisibleMenu?hideOsd():currentVisibleMenu||showOsd()}());break;case"mouse":e.button||(playPauseClickTimeout?(clearTimeout(playPauseClickTimeout),playPauseClickTimeout=0):playPauseClickTimeout=setTimeout((function(){_playbackManager.default.playPause(currentPlayer),showOsd(),playPauseClickTimeout=0}),300));break;default:_playbackManager.default.playPause(currentPlayer),showOsd()}}}),{passive:!0}),_browser.default.touch)_dom.default.addEventListener(view,"dblclick",(function onDoubleClick(e){var clientX=e.clientX;null!=clientX&&(clientX<_dom.default.getWindowSize().innerWidth/2?_playbackManager.default.rewind(currentPlayer):_playbackManager.default.fastForward(currentPlayer),e.preventDefault(),e.stopPropagation())}),{});else{_dom.default.addEventListener(view,"dblclick",(function(){_playbackManager.default.toggleFullscreen(currentPlayer)}),{passive:!0})}view.querySelector(".buttonMute").addEventListener("click",(function(){_playbackManager.default.toggleMute(currentPlayer)})),nowPlayingVolumeSlider.addEventListener("input",(function(e){_playbackManager.default.setVolume(e.target.value,currentPlayer)})),nowPlayingPositionSlider.addEventListener("change",(function(){var player=currentPlayer;if(player){var newPercent=parseFloat(this.value);if(enableProgressByTimeOfDay){var seekAirTimeTicks=newPercent/100*(programEndDateMs-programStartDateMs)*1e4;seekAirTimeTicks+=1e4*programStartDateMs,seekAirTimeTicks-=playbackStartTimeTicks,_playbackManager.default.seek(seekAirTimeTicks,player)}else _playbackManager.default.seekPercent(newPercent,player)}})),nowPlayingPositionSlider.getBubbleHtml=function(value){if(showOsd(),enableProgressByTimeOfDay){if(programStartDateMs&&programEndDateMs){var ms=programEndDateMs-programStartDateMs;return ms/=100,ms*=value,ms+=programStartDateMs,'<h1 class="sliderBubbleText">'+getDisplayTimeWithoutAmPm(new Date(parseInt(ms)),!0)+"</h1>"}return"--:--"}if(!currentRuntimeTicks)return"--:--";var ticks=currentRuntimeTicks;ticks/=100,ticks*=value;var item=currentItem;if(item&&item.Chapters&&item.Chapters.length&&item.Chapters[0].ImageTag){var html=function getChapterBubbleHtml(apiClient,item,chapters,positionTicks){for(var chapter,index=-1,i=0,length=chapters.length;i<length;i++){var currentChapter=chapters[i];positionTicks>=currentChapter.StartPositionTicks&&(chapter=currentChapter,index=i)}if(!chapter)return null;var src=function getImgUrl(item,chapter,index,maxWidth,apiClient){if(chapter.ImageTag)return apiClient.getScaledImageUrl(item.Id,{maxWidth:maxWidth,tag:chapter.ImageTag,type:"Chapter",index:index});return null}(item,chapter,index,400,apiClient);if(src){var html='<div class="chapterThumbContainer">';return html+='<img class="chapterThumb" src="'+src+'" />',html+='<div class="chapterThumbTextContainer">',html+='<div class="chapterThumbText chapterThumbText-dim">',html+=chapter.Name,html+="</div>",html+='<h2 class="chapterThumbText">',html+=_datetime.default.getDisplayRunningTime(positionTicks),html+="</h2>",(html+="</div>")+"</div>"}return null}(_connectionManager.default.getApiClient(item.ServerId),item,item.Chapters,ticks);if(html)return html}return'<h1 class="sliderBubbleText">'+_datetime.default.getDisplayRunningTime(ticks)+"</h1>"},view.querySelector(".btnPreviousTrack").addEventListener("click",(function(){_playbackManager.default.previousTrack(currentPlayer)})),view.querySelector(".btnPause").addEventListener("click",(function(){this.contains(clickedElement)&&_playbackManager.default.playPause(currentPlayer)})),view.querySelector(".btnNextTrack").addEventListener("click",(function(){_playbackManager.default.nextTrack(currentPlayer)})),btnRewind.addEventListener("click",(function(){_playbackManager.default.rewind(currentPlayer)})),btnFastForward.addEventListener("click",(function(){_playbackManager.default.fastForward(currentPlayer)})),view.querySelector(".btnAudio").addEventListener("click",(function showAudioTrackSelection(){var player=currentPlayer,audioTracks=_playbackManager.default.audioTracks(player),currentIndex=_playbackManager.default.getAudioStreamIndex(player),menuItems=audioTracks.map((function(stream){var opt={name:stream.DisplayTitle,id:stream.Index};return stream.Index===currentIndex&&(opt.selected=!0),opt})),positionTo=this;new Promise((function(_resolve,_reject){return _require(["actionsheet"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref5){_ref5.default.show({items:menuItems,title:_globalize.default.translate("Audio"),positionTo:positionTo}).then((function(id){var index=parseInt(id);index!==currentIndex&&_playbackManager.default.setAudioStreamIndex(index,player)})).finally((function(){resetIdle()})),setTimeout(resetIdle,0)}))})),view.querySelector(".btnSubtitles").addEventListener("click",(function showSubtitleTrackSelection(){var player=currentPlayer,streams=_playbackManager.default.subtitleTracks(player),currentIndex=_playbackManager.default.getSubtitleStreamIndex(player);null==currentIndex&&(currentIndex=-1);streams.unshift({Index:-1,DisplayTitle:_globalize.default.translate("Off")});var menuItems=streams.map((function(stream){var opt={name:stream.DisplayTitle,id:stream.Index};return stream.Index===currentIndex&&(opt.selected=!0),opt})),positionTo=this;new Promise((function(_resolve,_reject){return _require(["actionsheet"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref6){_ref6.default.show({title:_globalize.default.translate("Subtitles"),items:menuItems,positionTo:positionTo}).then((function(id){var index=parseInt(id);index!==currentIndex&&_playbackManager.default.setSubtitleStreamIndex(index,player),toggleSubtitleSync()})).finally((function(){resetIdle()})),setTimeout(resetIdle,0)}))})),_browser.default.touch&&new Promise((function(_resolve,_reject){return _require(["touchHelper"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref11){var TouchHelper=_ref11.default;self.touchHelper=new TouchHelper(view,{swipeYThreshold:30,triggerOnMove:!0,preventDefaultOnMove:!0,ignoreTagNames:["BUTTON","INPUT","TEXTAREA"]}),_events.default.on(self.touchHelper,"swipeup",onVerticalSwipe),_events.default.on(self.touchHelper,"swipedown",onVerticalSwipe)}))},_playbackManager=_interopRequireDefault(_playbackManager),_dom=_interopRequireDefault(_dom),_inputManager=_interopRequireDefault(_inputManager),_mouseManager=_interopRequireDefault(_mouseManager),_datetime=_interopRequireDefault(_datetime),_itemHelper=_interopRequireDefault(_itemHelper),_mediaInfo=_interopRequireDefault(_mediaInfo),_focusManager=_interopRequireDefault(_focusManager),_events=_interopRequireDefault(_events),_connectionManager=_interopRequireDefault(_connectionManager),_browser=_interopRequireDefault(_browser),_globalize=_interopRequireDefault(_globalize),_apphost=_interopRequireDefault(_apphost),_layoutManager=_interopRequireDefault(_layoutManager),userSettings=_interopRequireWildcard(userSettings),_keyboardnavigation=_interopRequireDefault(_keyboardnavigation)}));
//# sourceMappingURL=index.js.map
