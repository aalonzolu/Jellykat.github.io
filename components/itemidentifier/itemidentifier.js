define(["require","exports","dialogHelper","loading","connectionManager","globalize","scrollHelper","layoutManager","focusManager","browser","emby-input","emby-checkbox","paper-icon-button-light","css!./../formdialog","material-icons","cardStyle"],(function(_require,_exports,_dialogHelper,_loading,_connectionManager,_globalize,_scrollHelper,_layoutManager,_focusManager,_browser,_embyInput,_embyCheckbox,_paperIconButtonLight,_formdialog,_materialIcons,_cardStyle){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var cache=new WeakMap;return _getRequireWildcardCache=function _getRequireWildcardCache(){return cache},cache}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache();if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.show=show,_exports.showFindNew=showFindNew,_exports.default=void 0,_dialogHelper=_interopRequireDefault(_dialogHelper),_loading=_interopRequireDefault(_loading),_connectionManager=_interopRequireDefault(_connectionManager),_globalize=_interopRequireDefault(_globalize),_scrollHelper=_interopRequireDefault(_scrollHelper),_layoutManager=_interopRequireDefault(_layoutManager),_focusManager=_interopRequireDefault(_focusManager);var currentItem,currentItemType,currentServerId,currentResolve,currentReject,currentSearchResult,enableFocusTransform=!(_browser=_interopRequireDefault(_browser)).default.slow&&!_browser.default.edge,hasChanges=!1;function getApiClient(){return _connectionManager.default.getApiClient(currentServerId)}function searchForIdentificationResults(page){var i,length,value,lookupInfo={ProviderIds:{}},identifyField=page.querySelectorAll(".identifyField");for(i=0,length=identifyField.length;i<length;i++)(value=identifyField[i].value)&&("number"===identifyField[i].type&&(value=parseInt(value)),lookupInfo[identifyField[i].getAttribute("data-lookup")]=value);var hasId=!1,txtLookupId=page.querySelectorAll(".txtLookupId");for(i=0,length=txtLookupId.length;i<length;i++)(value=txtLookupId[i].value)&&(hasId=!0),lookupInfo.ProviderIds[txtLookupId[i].getAttribute("data-providerkey")]=value;if(hasId||lookupInfo.Name){lookupInfo={SearchInfo:lookupInfo},currentItem&&currentItem.Id?lookupInfo.ItemId=currentItem.Id:lookupInfo.IncludeDisabledProviders=!0,_loading.default.show();var apiClient=getApiClient();apiClient.ajax({type:"POST",url:apiClient.getUrl("Items/RemoteSearch/".concat(currentItemType)),data:JSON.stringify(lookupInfo),contentType:"application/json",dataType:"json"}).then((function(results){_loading.default.hide(),function showIdentificationSearchResults(page,results){var identificationSearchResults=page.querySelector(".identificationSearchResults");page.querySelector(".popupIdentifyForm").classList.add("hide"),identificationSearchResults.classList.remove("hide"),page.querySelector(".identifyOptionsForm").classList.add("hide"),page.querySelector(".dialogContentInner").classList.remove("dialog-content-centered");var i,length,html="";for(i=0,length=results.length;i<length;i++){var result=results[i];html+=getSearchResultHtml(result,i)}var elem=page.querySelector(".identificationSearchResultList");function onSearchImageClick(){var index=parseInt(this.getAttribute("data-index")),currentResult=results[index];null!=currentItem?function showIdentifyOptions(page,identifyResult){var identifyOptionsForm=page.querySelector(".identifyOptionsForm");page.querySelector(".popupIdentifyForm").classList.add("hide"),page.querySelector(".identificationSearchResults").classList.add("hide"),identifyOptionsForm.classList.remove("hide"),page.querySelector("#chkIdentifyReplaceImages").checked=!0,page.querySelector(".dialogContentInner").classList.add("dialog-content-centered"),currentSearchResult=identifyResult;var lines=[];lines.push(identifyResult.Name),identifyResult.ProductionYear&&lines.push(identifyResult.ProductionYear);var resultHtml=lines.join("<br/>");if(identifyResult.ImageUrl){var displayUrl=getSearchImageDisplayUrl(identifyResult.ImageUrl,identifyResult.SearchProviderName);resultHtml='<div style="display:flex;align-items:center;"><img src="'.concat(displayUrl,'" style="max-height:240px;" /><div style="margin-left:1em;">').concat(resultHtml,"</div>")}page.querySelector(".selectedSearchResult").innerHTML=resultHtml,_focusManager.default.focus(identifyOptionsForm.querySelector(".btnSubmit"))}(page,currentResult):function finishFindNewDialog(dlg,identifyResult){currentSearchResult=identifyResult,hasChanges=!0,_loading.default.hide(),_dialogHelper.default.close(dlg)}(page,currentResult)}elem.innerHTML=html;var searchImages=elem.querySelectorAll(".card");for(i=0,length=searchImages.length;i<length;i++)searchImages[i].addEventListener("click",onSearchImageClick);_layoutManager.default.tv&&_focusManager.default.autoFocus(identificationSearchResults)}(page,results)}))}else new Promise((function(_resolve,_reject){return _require(["toast"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref){(0,_ref.default)(_globalize.default.translate("PleaseEnterNameOrId"))}))}function getSearchResultHtml(result,index){var padderClass,html="",cssClass="card scalableCard";if("Episode"===currentItemType?(cssClass+=" backdropCard backdropCard-scalable",padderClass="cardPadder-backdrop"):"MusicAlbum"===currentItemType||"MusicArtist"===currentItemType?(cssClass+=" squareCard squareCard-scalable",padderClass="cardPadder-square"):(cssClass+=" portraitCard portraitCard-scalable",padderClass="cardPadder-portrait"),_layoutManager.default.tv&&(cssClass+=" show-focus",enableFocusTransform&&(cssClass+=" show-animation"))," cardBox-bottompadded",html+='<button type="button" class="'.concat(cssClass,'" data-index="').concat(index,'">'),html+='<div class="'.concat("cardBox cardBox-bottompadded",'">'),html+='<div class="cardScalable">',html+='<div class="'.concat(padderClass,'"></div>'),html+='<div class="cardContent searchImage">',result.ImageUrl){var displayUrl=getSearchImageDisplayUrl(result.ImageUrl,result.SearchProviderName);html+='<div class="cardImageContainer coveredImage" style="background-image:url(\''.concat(displayUrl,"');\"></div>")}else html+='<div class="cardImageContainer coveredImage defaultCardBackground defaultCardBackground1"><div class="cardText cardCenteredText">'.concat(result.Name,"</div></div>");html+="</div>",html+="</div>";var numLines=3;"MusicAlbum"===currentItemType&&numLines++;var lines=[result.Name];lines.push(result.SearchProviderName),result.AlbumArtist&&lines.push(result.AlbumArtist.Name),result.ProductionYear&&lines.push(result.ProductionYear);for(var i=0;i<numLines;i++)html+=0===i?'<div class="cardText cardText-first cardTextCentered">':'<div class="cardText cardText-secondary cardTextCentered">',html+=lines[i]||"&nbsp;",html+="</div>";return html+="</div>",html+="</button>"}function getSearchImageDisplayUrl(url,provider){return getApiClient().getUrl("Items/RemoteSearch/Image",{imageUrl:url,ProviderName:provider})}function showEditor(itemId){return _loading.default.show(),new Promise((function(_resolve,_reject){return _require(["text!./itemidentifier.template.html"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref2){var template=_ref2.default,apiClient=getApiClient();apiClient.getItem(apiClient.getCurrentUserId(),itemId).then((function(item){currentItemType=(currentItem=item).Type;var dialogOptions={size:"small",removeOnClose:!0,scrollY:!1};_layoutManager.default.tv&&(dialogOptions.size="fullscreen");var dlg=_dialogHelper.default.createDialog(dialogOptions);dlg.classList.add("formDialog"),dlg.classList.add("recordingDialog");var html="";html+=_globalize.default.translateHtml(template,"core"),dlg.innerHTML=html,dlg.addEventListener("close",onDialogClosed),_layoutManager.default.tv&&_scrollHelper.default.centerFocus.on(dlg.querySelector(".formDialogContent"),!1),item.Path?dlg.querySelector(".fldPath").classList.remove("hide"):dlg.querySelector(".fldPath").classList.add("hide"),dlg.querySelector(".txtPath").innerHTML=item.Path||"",_dialogHelper.default.open(dlg),dlg.querySelector(".popupIdentifyForm").addEventListener("submit",(function(e){return e.preventDefault(),searchForIdentificationResults(dlg),!1})),dlg.querySelector(".identifyOptionsForm").addEventListener("submit",(function(e){return e.preventDefault(),function submitIdentficationResult(page){_loading.default.show();var options={ReplaceAllImages:page.querySelector("#chkIdentifyReplaceImages").checked},apiClient=getApiClient();apiClient.ajax({type:"POST",url:apiClient.getUrl("Items/RemoteSearch/Apply/".concat(currentItem.Id),options),data:JSON.stringify(currentSearchResult),contentType:"application/json"}).then((function(){hasChanges=!0,_loading.default.hide(),_dialogHelper.default.close(page)}),(function(){_loading.default.hide(),_dialogHelper.default.close(page)}))}(dlg),!1})),dlg.querySelector(".btnCancel").addEventListener("click",(function(){_dialogHelper.default.close(dlg)})),dlg.classList.add("identifyDialog"),function showIdentificationForm(page,item){var apiClient=getApiClient();apiClient.getJSON(apiClient.getUrl("Items/".concat(item.Id,"/ExternalIdInfos"))).then((function(idList){for(var html="",i=0,length=idList.length;i<length;i++){var idInfo=idList[i],id="txtLookup".concat(idInfo.Key);html+='<div class="inputContainer">';var fullName=idInfo.Name;idInfo.Type&&(fullName="".concat(idInfo.Name," ").concat(_globalize.default.translate(idInfo.Type)));var idLabel=_globalize.default.translate("LabelDynamicExternalId",fullName);html+='<input is="emby-input" class="txtLookupId" data-providerkey="'.concat(idInfo.Key,'" id="').concat(id,'" label="').concat(idLabel,'"/>'),html+="</div>"}page.querySelector("#txtLookupName").value="","Person"===item.Type||"BoxSet"===item.Type?(page.querySelector(".fldLookupYear").classList.add("hide"),page.querySelector("#txtLookupYear").value=""):(page.querySelector(".fldLookupYear").classList.remove("hide"),page.querySelector("#txtLookupYear").value=""),page.querySelector(".identifyProviderIds").innerHTML=html,page.querySelector(".formDialogHeaderTitle").innerHTML=_globalize.default.translate("Identify")}))}(dlg,item),_loading.default.hide()}))}))}function onDialogClosed(){_loading.default.hide(),hasChanges?currentResolve():currentReject()}function showEditorFindNew(itemName,itemYear,itemType,resolveFunc){return currentItem=null,currentItemType=itemType,new Promise((function(_resolve,_reject){return _require(["text!./itemidentifier.template.html"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref3){var template=_ref3.default,dialogOptions={size:"small",removeOnClose:!0,scrollY:!1};_layoutManager.default.tv&&(dialogOptions.size="fullscreen");var dlg=_dialogHelper.default.createDialog(dialogOptions);dlg.classList.add("formDialog"),dlg.classList.add("recordingDialog");var html="";html+=_globalize.default.translateHtml(template,"core"),dlg.innerHTML=html,_layoutManager.default.tv&&_scrollHelper.default.centerFocus.on(dlg.querySelector(".formDialogContent"),!1),_dialogHelper.default.open(dlg),dlg.querySelector(".btnCancel").addEventListener("click",(function(){_dialogHelper.default.close(dlg)})),dlg.querySelector(".popupIdentifyForm").addEventListener("submit",(function(e){return e.preventDefault(),searchForIdentificationResults(dlg),!1})),dlg.addEventListener("close",(function(){_loading.default.hide(),resolveFunc(hasChanges?currentSearchResult:null)})),dlg.classList.add("identifyDialog"),function showIdentificationFormFindNew(dlg,itemName,itemYear,itemType){dlg.querySelector("#txtLookupName").value=itemName,"Person"===itemType||"BoxSet"===itemType?(dlg.querySelector(".fldLookupYear").classList.add("hide"),dlg.querySelector("#txtLookupYear").value=""):(dlg.querySelector(".fldLookupYear").classList.remove("hide"),dlg.querySelector("#txtLookupYear").value=itemYear);dlg.querySelector(".formDialogHeaderTitle").innerHTML=_globalize.default.translate("Search")}(dlg,itemName,itemYear,itemType)}))}function show(itemId,serverId){return new Promise((function(resolve,reject){currentResolve=resolve,currentReject=reject,currentServerId=serverId,hasChanges=!1,showEditor(itemId)}))}function showFindNew(itemName,itemYear,itemType,serverId){return new Promise((function(resolve){currentServerId=serverId,hasChanges=!1,showEditorFindNew(itemName,itemYear,itemType,resolve)}))}var _default={show:show,showFindNew:showFindNew};_exports.default=_default}));
//# sourceMappingURL=itemidentifier.js.map
