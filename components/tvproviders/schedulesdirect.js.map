{"version":3,"sources":["components/tvproviders/schedulesdirect.js"],"names":["define","_exports","_jQuery","_loading","_globalize","_embyCheckbox","_embyInput","_listViewStyle","_paperIconButtonLight","_embySelect","_embyButton","_flexStyles","_interopRequireDefault","obj","__esModule","default","Object","defineProperty","value","_default","page","providerId","options","reload","loading","show","ApiClient","getNamedConfiguration","then","config","info","ListingProviders","filter","i","Id","listingsId","ListingsId","val","querySelector","Username","ZipCode","Password","classList","remove","add","checked","EnableAllTuners","setCountry","getJSON","getUrl","result","length","countryList","region","countries","push","name","fullName","shortName","sort","a","b","html","map","c","join","Country","trigger","Dashboard","alert","message","globalize","translate","hide","refreshTunerDevices","providerInfo","devices","device","enabledTuners","EnabledTuners","checkedAttribute","indexOf","FriendlyName","getTunerName","Type","Url","innerHTML","TunerHosts","sha256","str","self","TextEncoder","Promise","resolve","buffer","encode","crypto","subtle","digest","hash","hex","hexCodes","view","DataView","byteLength","paddedValue","getUint32","toString","slice","toLowerCase","this","submit","click","init","hideCancelButton","showCancelButton","toggle","hideSubmitButton","showSubmitButton","on","submitLoginForm","passwordHash","Pw","id","ajax","type","url","ValidateLogin","data","JSON","stringify","contentType","dataType","processServerConfigurationUpdateResult","submitListingsForm","selectedListingsId","get","getAttribute","ValidateListings","showConfirmation","Events","refreshListings","Location","o","Name","addEventListener","e","target"],"mappings":"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","file":"schedulesdirect.js","sourcesContent":["import $ from 'jQuery';\nimport loading from 'loading';\nimport globalize from 'globalize';\nimport 'emby-checkbox';\nimport 'emby-input';\nimport 'listViewStyle';\nimport 'paper-icon-button-light';\nimport 'emby-select';\nimport 'emby-button';\nimport 'flexStyles';\n\nexport default function (page, providerId, options) {\n    function reload() {\n        loading.show();\n        ApiClient.getNamedConfiguration('livetv').then(function (config) {\n            const info = config.ListingProviders.filter(function (i) {\n                return i.Id === providerId;\n            })[0] || {};\n            listingsId = info.ListingsId;\n            $('#selectListing', page).val(info.ListingsId || '');\n            page.querySelector('.txtUser').value = info.Username || '';\n            page.querySelector('.txtPass').value = '';\n            page.querySelector('.txtZipCode').value = info.ZipCode || '';\n\n            if (info.Username && info.Password) {\n                page.querySelector('.listingsSection').classList.remove('hide');\n            } else {\n                page.querySelector('.listingsSection').classList.add('hide');\n            }\n\n            page.querySelector('.chkAllTuners').checked = info.EnableAllTuners;\n\n            if (info.EnableAllTuners) {\n                page.querySelector('.selectTunersSection').classList.add('hide');\n            } else {\n                page.querySelector('.selectTunersSection').classList.remove('hide');\n            }\n\n            setCountry(info);\n            refreshTunerDevices(page, info, config.TunerHosts);\n        });\n    }\n\n    function setCountry(info) {\n        ApiClient.getJSON(ApiClient.getUrl('LiveTv/ListingProviders/SchedulesDirect/Countries')).then(function (result) {\n            let i;\n            let length;\n            const countryList = [];\n\n            for (const region in result) {\n                const countries = result[region];\n\n                if (countries.length && region !== 'ZZZ') {\n                    for (i = 0, length = countries.length; i < length; i++) {\n                        countryList.push({\n                            name: countries[i].fullName,\n                            value: countries[i].shortName\n                        });\n                    }\n                }\n            }\n\n            countryList.sort(function (a, b) {\n                if (a.name > b.name) {\n                    return 1;\n                }\n\n                if (a.name < b.name) {\n                    return -1;\n                }\n\n                return 0;\n            });\n            $('#selectCountry', page).html(countryList.map(function (c) {\n                return '<option value=\"' + c.value + '\">' + c.name + '</option>';\n            }).join('')).val(info.Country || '');\n            $(page.querySelector('.txtZipCode')).trigger('change');\n        }, function () { // ApiClient.getJSON() error handler\n            Dashboard.alert({\n                message: globalize.translate('ErrorGettingTvLineups')\n            });\n        });\n        loading.hide();\n    }\n\n    function sha256(str) {\n        if (!self.TextEncoder) {\n            return Promise.resolve('');\n        }\n\n        const buffer = new TextEncoder('utf-8').encode(str);\n        return crypto.subtle.digest('SHA-256', buffer).then(function (hash) {\n            return hex(hash);\n        });\n    }\n\n    function hex(buffer) {\n        const hexCodes = [];\n        const view = new DataView(buffer);\n\n        for (let i = 0; i < view.byteLength; i += 4) {\n            const value = view.getUint32(i);\n            const stringValue = value.toString(16);\n            const paddedValue = ('00000000' + stringValue).slice(-'00000000'.length);\n            hexCodes.push(paddedValue);\n        }\n\n        return hexCodes.join('');\n    }\n\n    function submitLoginForm() {\n        loading.show();\n        sha256(page.querySelector('.txtPass').value).then(function (passwordHash) {\n            const info = {\n                Type: 'SchedulesDirect',\n                Username: page.querySelector('.txtUser').value,\n                EnableAllTuners: true,\n                Password: passwordHash,\n                Pw: page.querySelector('.txtPass').value\n            };\n            const id = providerId;\n\n            if (id) {\n                info.Id = id;\n            }\n\n            ApiClient.ajax({\n                type: 'POST',\n                url: ApiClient.getUrl('LiveTv/ListingProviders', {\n                    ValidateLogin: true\n                }),\n                data: JSON.stringify(info),\n                contentType: 'application/json',\n                dataType: 'json'\n            }).then(function (result) {\n                Dashboard.processServerConfigurationUpdateResult();\n                providerId = result.Id;\n                reload();\n            }, function () {\n                Dashboard.alert({ // ApiClient.ajax() error handler\n                    message: globalize.translate('ErrorSavingTvProvider')\n                });\n            });\n        });\n    }\n\n    function submitListingsForm() {\n        const selectedListingsId = $('#selectListing', page).val();\n\n        if (!selectedListingsId) {\n            return void Dashboard.alert({\n                message: globalize.translate('ErrorPleaseSelectLineup')\n            });\n        }\n\n        loading.show();\n        const id = providerId;\n        ApiClient.getNamedConfiguration('livetv').then(function (config) {\n            const info = config.ListingProviders.filter(function (i) {\n                return i.Id === id;\n            })[0];\n            info.ZipCode = page.querySelector('.txtZipCode').value;\n            info.Country = $('#selectCountry', page).val();\n            info.ListingsId = selectedListingsId;\n            info.EnableAllTuners = page.querySelector('.chkAllTuners').checked;\n            info.EnabledTuners = info.EnableAllTuners ? [] : $('.chkTuner', page).get().filter(function (i) {\n                return i.checked;\n            }).map(function (i) {\n                return i.getAttribute('data-id');\n            });\n            ApiClient.ajax({\n                type: 'POST',\n                url: ApiClient.getUrl('LiveTv/ListingProviders', {\n                    ValidateListings: true\n                }),\n                data: JSON.stringify(info),\n                contentType: 'application/json'\n            }).then(function (result) {\n                loading.hide();\n\n                if (options.showConfirmation) {\n                    Dashboard.processServerConfigurationUpdateResult();\n                }\n\n                Events.trigger(self, 'submitted');\n            }, function () {\n                loading.hide();\n                Dashboard.alert({\n                    message: globalize.translate('ErrorAddingListingsToSchedulesDirect')\n                });\n            });\n        });\n    }\n\n    function refreshListings(value) {\n        if (!value) {\n            return void $('#selectListing', page).html('');\n        }\n\n        loading.show();\n        ApiClient.ajax({\n            type: 'GET',\n            url: ApiClient.getUrl('LiveTv/ListingProviders/Lineups', {\n                Id: providerId,\n                Location: value,\n                Country: $('#selectCountry', page).val()\n            }),\n            dataType: 'json'\n        }).then(function (result) {\n            $('#selectListing', page).html(result.map(function (o) {\n                return '<option value=\"' + o.Id + '\">' + o.Name + '</option>';\n            }));\n\n            if (listingsId) {\n                $('#selectListing', page).val(listingsId);\n            }\n\n            loading.hide();\n        }, function (result) {\n            Dashboard.alert({\n                message: globalize.translate('ErrorGettingTvLineups')\n            });\n            refreshListings('');\n            loading.hide();\n        });\n    }\n\n    function getTunerName(providerId) {\n        switch (providerId = providerId.toLowerCase()) {\n            case 'm3u':\n                return 'M3U Playlist';\n            case 'hdhomerun':\n                return 'HDHomerun';\n            case 'satip':\n                return 'DVB';\n            default:\n                return 'Unknown';\n        }\n    }\n\n    function refreshTunerDevices(page, providerInfo, devices) {\n        let html = '';\n\n        for (let i = 0, length = devices.length; i < length; i++) {\n            const device = devices[i];\n            html += '<div class=\"listItem\">';\n            const enabledTuners = providerInfo.EnabledTuners || [];\n            const isChecked = providerInfo.EnableAllTuners || enabledTuners.indexOf(device.Id) !== -1;\n            const checkedAttribute = isChecked ? ' checked' : '';\n            html += '<label class=\"checkboxContainer listItemCheckboxContainer\"><input type=\"checkbox\" is=\"emby-checkbox\" data-id=\"' + device.Id + '\" class=\"chkTuner\" ' + checkedAttribute + '/><span></span></label>';\n            html += '<div class=\"listItemBody two-line\">';\n            html += '<div class=\"listItemBodyText\">';\n            html += device.FriendlyName || getTunerName(device.Type);\n            html += '</div>';\n            html += '<div class=\"listItemBodyText secondary\">';\n            html += device.Url;\n            html += '</div>';\n            html += '</div>';\n            html += '</div>';\n        }\n\n        page.querySelector('.tunerList').innerHTML = html;\n    }\n\n    let listingsId;\n    const self = this;\n\n    self.submit = function () {\n        page.querySelector('.btnSubmitListingsContainer').click();\n    };\n\n    self.init = function () {\n        options = options || {};\n\n        // Only hide the buttons if explicitly set to false; default to showing if undefined or null\n        // FIXME: rename this option to clarify logic\n        const hideCancelButton = options.showCancelButton === false;\n        page.querySelector('.btnCancel').classList.toggle('hide', hideCancelButton);\n\n        const hideSubmitButton = options.showSubmitButton === false;\n        page.querySelector('.btnSubmitListings').classList.toggle('hide', hideSubmitButton);\n\n        $('.formLogin', page).on('submit', function () {\n            submitLoginForm();\n            return false;\n        });\n        $('.formListings', page).on('submit', function () {\n            submitListingsForm();\n            return false;\n        });\n        $('.txtZipCode', page).on('change', function () {\n            refreshListings(this.value);\n        });\n        page.querySelector('.chkAllTuners').addEventListener('change', function (e) {\n            if (e.target.checked) {\n                page.querySelector('.selectTunersSection').classList.add('hide');\n            } else {\n                page.querySelector('.selectTunersSection').classList.remove('hide');\n            }\n        });\n        $('.createAccountHelp', page).html(globalize.translate('MessageCreateAccountAt', '<a is=\"emby-linkbutton\" class=\"button-link\" href=\"http://www.schedulesdirect.org\" target=\"_blank\">http://www.schedulesdirect.org</a>'));\n        reload();\n    };\n}\n"]}