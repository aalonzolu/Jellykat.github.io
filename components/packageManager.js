define(["exports","appSettings","pluginManager"],(function(_exports,_appSettings,_pluginManager){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _classPrivateFieldSet(receiver,privateMap,value){var descriptor=privateMap.get(receiver);if(!descriptor)throw new TypeError("attempted to set private field on non-instance");if(descriptor.set)descriptor.set.call(receiver,value);else{if(!descriptor.writable)throw new TypeError("attempted to set read only private field");descriptor.value=value}return value}function _classPrivateFieldGet(receiver,privateMap){var descriptor=privateMap.get(receiver);if(!descriptor)throw new TypeError("attempted to get private field on non-instance");return descriptor.get?descriptor.get.call(receiver):descriptor.value}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_appSettings=_interopRequireDefault(_appSettings),_pluginManager=_interopRequireDefault(_pluginManager);var _packagesList=new WeakMap,_settingsKey=new WeakMap,_default=new(function(){function PackageManager(){!function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,PackageManager),_packagesList.set(this,{writable:!0,value:[]}),_settingsKey.set(this,{writable:!0,value:"installedpackages1"})}return function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}(PackageManager,[{key:"init",value:function init(){var _this=this;console.groupCollapsed("loading packages");var manifestUrls=JSON.parse(_appSettings.default.get(_classPrivateFieldGet(this,_settingsKey))||"[]");return Promise.all(manifestUrls.map((function(url){return _this.loadPackage(url)}))).then((function(){return console.debug("finished loading packages"),Promise.resolve()})).catch((function(){return Promise.resolve()})).finally((function(){console.groupEnd("loading packages")}))}},{key:"install",value:function install(url){var _this2=this;return this.loadPackage(url,!0).then((function(pkg){var manifestUrls=JSON.parse(_appSettings.default.get(_classPrivateFieldGet(_this2,_settingsKey))||"[]");return manifestUrls.includes(url)||(manifestUrls.push(url),_appSettings.default.set(_classPrivateFieldGet(_this2,_settingsKey),JSON.stringify(manifestUrls))),pkg}))}},{key:"uninstall",value:function uninstall(name){var pkg=_classPrivateFieldGet(this,_packagesList).filter((function(p){return p.name===name}))[0];return pkg&&(_classPrivateFieldSet(this,_packagesList,_classPrivateFieldGet(this,_packagesList).filter((function(p){return p.name!==name}))),this.removeUrl(pkg.url)),Promise.resolve()}},{key:"mapPath",value:function mapPath(pkg,pluginUrl){var urlLower=pluginUrl.toLowerCase();if(urlLower.startsWith("http:")||urlLower.startsWith("https:")||urlLower.startsWith("file:"))return pluginUrl;var packageUrl=pkg.url;return packageUrl=packageUrl.substring(0,packageUrl.lastIndexOf("/")),packageUrl+="/",packageUrl+=pluginUrl}},{key:"addPackage",value:function addPackage(pkg){_classPrivateFieldSet(this,_packagesList,_classPrivateFieldGet(this,_packagesList).filter((function(p){return p.name!==pkg.name}))),_classPrivateFieldGet(this,_packagesList).push(pkg)}},{key:"removeUrl",value:function removeUrl(url){var manifestUrls=JSON.parse(_appSettings.default.get(_classPrivateFieldGet(this,_settingsKey))||"[]");manifestUrls=manifestUrls.filter((function(i){return i!==url})),_appSettings.default.set(_classPrivateFieldGet(this,_settingsKey),JSON.stringify(manifestUrls))}},{key:"loadPackage",value:function loadPackage(url){var _this3=this,throwError=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise((function(resolve,reject){var xhr=new XMLHttpRequest,originalUrl=url;url+=-1===url.indexOf("?")?"?":"&",url+="t="+(new Date).getTime(),xhr.open("GET",url,!0);var onError=function onError(){!0===throwError?reject():(_this3.removeUrl(originalUrl),resolve())};xhr.onload=function(){if(_this3.status<400){var pkg=JSON.parse(_this3.response);pkg.url=originalUrl,_this3.addPackage(pkg);var plugins=pkg.plugins||[];pkg.plugin&&plugins.push(pkg.plugin);var promises=plugins.map((function(pluginUrl){return _pluginManager.default.loadPlugin(_this3.mapPath(pkg,pluginUrl))}));Promise.all(promises).then(resolve,resolve)}else onError()},xhr.onerror=onError,xhr.send()}))}},{key:"packages",get:function get(){return _classPrivateFieldGet(this,_packagesList).slice(0)}}]),PackageManager}());_exports.default=_default}));
//# sourceMappingURL=packageManager.js.map
