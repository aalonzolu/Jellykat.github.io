define(["exports","events","globalize","playbackManager","connectionManager","syncPlayManager","playMethodHelper","layoutManager","paper-icon-button-light","css!./playerstats"],(function(_exports,_events,_globalize,_playbackManager,_connectionManager,_syncPlayManager,_playMethodHelper,_layoutManager,_paperIconButtonLight,_playerstats){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function onCloseButtonClick(){this.enabled(!1)}function translateReason(reason){return _globalize.default.translate(""+reason)}function getTranscodingStats(session,player,displayPlayMethod){var videoCodec,audioCodec,totalBitrate,audioChannels,sessionStats=[];return session.TranscodingInfo&&(videoCodec=session.TranscodingInfo.VideoCodec,audioCodec=session.TranscodingInfo.AudioCodec,totalBitrate=session.TranscodingInfo.Bitrate,audioChannels=session.TranscodingInfo.AudioChannels),videoCodec&&sessionStats.push({label:_globalize.default.translate("LabelVideoCodec"),value:session.TranscodingInfo.IsVideoDirect?videoCodec.toUpperCase()+" (direct)":videoCodec.toUpperCase()}),audioCodec&&sessionStats.push({label:_globalize.default.translate("LabelAudioCodec"),value:session.TranscodingInfo.IsAudioDirect?audioCodec.toUpperCase()+" (direct)":audioCodec.toUpperCase()}),audioChannels&&sessionStats.push({label:_globalize.default.translate("LabelAudioChannels"),value:audioChannels}),"Transcode"===displayPlayMethod&&(totalBitrate&&sessionStats.push({label:_globalize.default.translate("LabelBitrate"),value:getDisplayBitrate(totalBitrate)}),session.TranscodingInfo.CompletionPercentage&&sessionStats.push({label:_globalize.default.translate("LabelTranscodingProgress"),value:session.TranscodingInfo.CompletionPercentage.toFixed(1)+"%"}),session.TranscodingInfo.Framerate&&sessionStats.push({label:_globalize.default.translate("LabelTranscodingFramerate"),value:session.TranscodingInfo.Framerate+" fps"}),session.TranscodingInfo.TranscodeReasons&&session.TranscodingInfo.TranscodeReasons.length&&sessionStats.push({label:_globalize.default.translate("LabelReasonForTranscoding"),value:session.TranscodingInfo.TranscodeReasons.map(translateReason).join("<br/>")})),sessionStats}function getDisplayBitrate(bitrate){return bitrate>1e6?(bitrate/1e6).toFixed(1)+" Mbps":Math.floor(bitrate/1e3)+" kbps"}function getMediaSourceStats(session,player,displayPlayMethod){var size,sessionStats=[],mediaSource=_playbackManager.default.currentMediaSource(player)||{},totalBitrate=mediaSource.Bitrate,mediaFileSize=mediaSource.Size;mediaSource.Container&&sessionStats.push({label:_globalize.default.translate("LabelProfileContainer"),value:mediaSource.Container}),mediaFileSize&&sessionStats.push({label:_globalize.default.translate("LabelSize"),value:(size=mediaFileSize,size>=1073741824?parseFloat((size/1073741824).toFixed(1))+" GiB":size>=1048576?parseFloat((size/1048576).toFixed(1))+" MiB":Math.floor(size/1024)+" KiB")}),totalBitrate&&sessionStats.push({label:_globalize.default.translate("LabelBitrate"),value:getDisplayBitrate(totalBitrate)});var videoStream=(mediaSource.MediaStreams||[]).filter((function(s){return"Video"===s.Type}))[0]||{},videoCodec=videoStream.Codec,audioStreamIndex=_playbackManager.default.getAudioStreamIndex(player),audioStream=_playbackManager.default.audioTracks(player).filter((function(s){return"Audio"===s.Type&&s.Index===audioStreamIndex}))[0]||{},audioCodec=audioStream.Codec,audioChannels=audioStream.Channels,videoInfos=[];videoCodec&&videoInfos.push(videoCodec.toUpperCase()),videoStream.Profile&&videoInfos.push(videoStream.Profile),videoInfos.length&&sessionStats.push({label:_globalize.default.translate("LabelVideoCodec"),value:videoInfos.join(" ")}),videoStream.BitRate&&sessionStats.push({label:_globalize.default.translate("LabelVideoBitrate"),value:getDisplayBitrate(videoStream.BitRate)});var audioInfos=[];return audioCodec&&audioInfos.push(audioCodec.toUpperCase()),audioStream.Profile&&audioInfos.push(audioStream.Profile),audioInfos.length&&sessionStats.push({label:_globalize.default.translate("LabelAudioCodec"),value:audioInfos.join(" ")}),audioStream.BitRate&&sessionStats.push({label:_globalize.default.translate("LabelAudioBitrate"),value:getDisplayBitrate(audioStream.BitRate)}),audioChannels&&sessionStats.push({label:_globalize.default.translate("LabelAudioChannels"),value:audioChannels}),audioStream.SampleRate&&sessionStats.push({label:_globalize.default.translate("LabelAudioSampleRate"),value:audioStream.SampleRate+" Hz"}),audioStream.BitDepth&&sessionStats.push({label:_globalize.default.translate("LabelAudioBitDepth"),value:audioStream.BitDepth}),sessionStats}function getStats(instance,player){var statsPromise=player.getStats?player.getStats():Promise.resolve({}),sessionPromise=function getSession(instance,player){if((new Date).getTime()-(instance.lastSessionTime||0)<1e4)return Promise.resolve(instance.lastSession);var apiClient=_connectionManager.default.getApiClient(_playbackManager.default.currentItem(player).ServerId);return apiClient.getSessions({deviceId:apiClient.deviceId()}).then((function(sessions){return instance.lastSession=sessions[0]||{},instance.lastSessionTime=(new Date).getTime(),Promise.resolve(instance.lastSession)}),(function(){return Promise.resolve({})}))}(instance,player);return Promise.all([statsPromise,sessionPromise]).then((function(responses){var playerStats=responses[0].categories||[],session=responses[1],displayPlayMethod=_playMethodHelper.default.getDisplayPlayMethod(session),baseCategory={stats:[],name:"Playback Info"};baseCategory.stats.unshift({label:_globalize.default.translate("LabelPlayMethod"),value:displayPlayMethod}),baseCategory.stats.unshift({label:_globalize.default.translate("LabelPlayer"),value:player.name});var categories=[];categories.push(baseCategory);for(var i=0,length=playerStats.length;i<length;i++){var category=playerStats[i];"audio"===category.type?category.name="Audio Info":"video"===category.type&&(category.name="Video Info"),categories.push(category)}session.TranscodingInfo&&categories.push({stats:getTranscodingStats(session,0,displayPlayMethod),name:"Transcode"===displayPlayMethod?"Transcoding Info":"Direct Stream Info"}),categories.push({stats:getMediaSourceStats(0,player),name:"Original Media Info"});var syncStats,stats,apiClient=_connectionManager.default.getApiClient(_playbackManager.default.currentItem(player).ServerId);return _syncPlayManager.default.isSyncPlayEnabled()&&apiClient.isMinServerVersion("10.6.0")&&categories.push({stats:(syncStats=[],stats=_syncPlayManager.default.getStats(),syncStats.push({label:_globalize.default.translate("LabelSyncPlayTimeOffset"),value:stats.TimeOffset+_globalize.default.translate("MillisecondsUnit")}),syncStats.push({label:_globalize.default.translate("LabelSyncPlayPlaybackDiff"),value:stats.PlaybackDiff+_globalize.default.translate("MillisecondsUnit")}),syncStats.push({label:_globalize.default.translate("LabelSyncPlaySyncMethod"),value:stats.SyncMethod}),syncStats),name:"SyncPlay Info"}),Promise.resolve(categories)}))}function bindEvents(instance,player){var localOnTimeUpdate=function localOnTimeUpdate(){!function renderPlayerStats(instance,player){var now=(new Date).getTime();now-(instance.lastRender||0)<700||(instance.lastRender=now,getStats(instance,player).then((function(stats){var elem=instance.element;elem&&function renderStats(elem,categories){elem.querySelector(".playerStats-stats").innerHTML=categories.map((function(category){var categoryHtml="",stats=category.stats;stats.length&&category.name&&(categoryHtml+='<div class="playerStats-stat playerStats-stat-header">',categoryHtml+='<div class="playerStats-stat-label">',categoryHtml+=category.name,categoryHtml+="</div>",categoryHtml+='<div class="playerStats-stat-value">',categoryHtml+=category.subText||"",categoryHtml+="</div>",categoryHtml+="</div>");for(var i=0,length=stats.length;i<length;i++){categoryHtml+='<div class="playerStats-stat">';var stat=stats[i];categoryHtml+='<div class="playerStats-stat-label">',categoryHtml+=stat.label,categoryHtml+="</div>",categoryHtml+='<div class="playerStats-stat-value">',categoryHtml+=stat.value,categoryHtml+="</div>",categoryHtml+="</div>"}return categoryHtml})).join("")}(elem,stats)})))}(instance,player)};instance.onTimeUpdate=localOnTimeUpdate,_events.default.on(player,"timeupdate",localOnTimeUpdate)}function unbindEvents(instance,player){var localOnTimeUpdate=instance.onTimeUpdate;localOnTimeUpdate&&_events.default.off(player,"timeupdate",localOnTimeUpdate)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_events=_interopRequireDefault(_events),_globalize=_interopRequireDefault(_globalize),_playbackManager=_interopRequireDefault(_playbackManager),_connectionManager=_interopRequireDefault(_connectionManager),_syncPlayManager=_interopRequireDefault(_syncPlayManager),_playMethodHelper=_interopRequireDefault(_playMethodHelper),_layoutManager=_interopRequireDefault(_layoutManager);var _default=function(){function PlayerStats(options){!function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,PlayerStats),this.options=options,function init(instance){var button,parent=document.createElement("div");parent.classList.add("playerStats"),_layoutManager.default.tv&&parent.classList.add("playerStats-tv"),parent.classList.add("hide"),button=_layoutManager.default.tv?"":'<button type="button" is="paper-icon-button-light" class="playerStats-closeButton"><span class="material-icons close"></span></button>';var contentClass=_layoutManager.default.tv?"playerStats-content playerStats-content-tv":"playerStats-content";parent.innerHTML='<div class="'+contentClass+'">'+button+'<div class="playerStats-stats"></div></div>',(button=parent.querySelector(".playerStats-closeButton"))&&button.addEventListener("click",onCloseButtonClick.bind(instance)),document.body.appendChild(parent),instance.element=parent}(this),this.enabled(!0)}return function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}(PlayerStats,[{key:"enabled",value:function enabled(_enabled){if(null==_enabled)return this._enabled;var options=this.options;options&&(this._enabled=_enabled,_enabled?(this.element.classList.remove("hide"),bindEvents(this,options.player)):(this.element.classList.add("hide"),unbindEvents(this,options.player)))}},{key:"toggle",value:function toggle(){this.enabled(!this.enabled())}},{key:"destroy",value:function destroy(){var options=this.options;options&&(this.options=null,unbindEvents(this,options.player));var elem=this.element;elem&&(elem.parentNode.removeChild(elem),this.element=null)}}]),PlayerStats}();_exports.default=_default}));
//# sourceMappingURL=playerstats.js.map
