define(["require","exports","browser","apphost","loading","connectionManager","globalize","dom","css!./multiSelect"],(function(_require,_exports,_browser,_apphost,_loading,_connectionManager,_globalize,_dom,_multiSelect){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var cache=new WeakMap;return _getRequireWildcardCache=function _getRequireWildcardCache(){return cache},cache}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache();if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=function _default(options){var touchTarget,touchStartTimeout,touchStartX,touchStartY,container=options.container;function onTapHold(e){var card=_dom.default.parentWithClass(e.target,"card");return card&&showSelections(card),e.preventDefault(),e.stopPropagation&&e.stopPropagation(),!1}function getTouches(e){return e.changedTouches||e.targetTouches||e.touches}function onTouchStart(e){var touch=getTouches(e)[0];if(touchTarget=null,touchStartX=0,touchStartY=0,touch){touchStartX=touch.clientX,touchStartY=touch.clientY;var element=touch.target;if(element){var card=_dom.default.parentWithClass(element,"card");card&&(touchStartTimeout&&(clearTimeout(touchStartTimeout),touchStartTimeout=null),touchTarget=card,touchStartTimeout=setTimeout(onTouchStartTimerFired,550))}}}function onTouchMove(e){if(touchTarget){var deltaX,deltaY,touch=getTouches(e)[0];if(touch){var touchEndX=touch.clientX||0,touchEndY=touch.clientY||0;deltaX=Math.abs(touchEndX-(touchStartX||0)),deltaY=Math.abs(touchEndY-(touchStartY||0))}else deltaX=100,deltaY=100;(deltaX>=5||deltaY>=5)&&onMouseOut(e)}}function onTouchEnd(e){onMouseOut(e)}function onMouseDown(e){touchStartTimeout&&(clearTimeout(touchStartTimeout),touchStartTimeout=null),touchTarget=e.target,touchStartTimeout=setTimeout(onTouchStartTimerFired,550)}function onMouseOut(e){touchStartTimeout&&(clearTimeout(touchStartTimeout),touchStartTimeout=null),touchTarget=null}function onTouchStartTimerFired(){if(touchTarget){var card=_dom.default.parentWithClass(touchTarget,"card");touchTarget=null,card&&showSelections(card)}}(function initTapHold(element){_browser.default.touch&&!_browser.default.safari?element.addEventListener("contextmenu",onTapHold):(_dom.default.addEventListener(element,"touchstart",onTouchStart,{passive:!0}),_dom.default.addEventListener(element,"touchmove",onTouchMove,{passive:!0}),_dom.default.addEventListener(element,"touchend",onTouchEnd,{passive:!0}),_dom.default.addEventListener(element,"touchcancel",onTouchEnd,{passive:!0}),_dom.default.addEventListener(element,"mousedown",onMouseDown,{passive:!0}),_dom.default.addEventListener(element,"mouseleave",onMouseOut,{passive:!0}),_dom.default.addEventListener(element,"mouseup",onMouseOut,{passive:!0}))})(container),!1!==options.bindOnClick&&container.addEventListener("click",onContainerClick);this.onContainerClick=onContainerClick,this.destroy=function(){container.removeEventListener("click",onContainerClick),container.removeEventListener("contextmenu",onTapHold);var element=container;_dom.default.removeEventListener(element,"touchstart",onTouchStart,{passive:!0}),_dom.default.removeEventListener(element,"touchmove",onTouchMove,{passive:!0}),_dom.default.removeEventListener(element,"touchend",onTouchEnd,{passive:!0}),_dom.default.removeEventListener(element,"mousedown",onMouseDown,{passive:!0}),_dom.default.removeEventListener(element,"mouseleave",onMouseOut,{passive:!0}),_dom.default.removeEventListener(element,"mouseup",onMouseOut,{passive:!0})}},_browser=_interopRequireDefault(_browser),_apphost=_interopRequireDefault(_apphost),_loading=_interopRequireDefault(_loading),_connectionManager=_interopRequireDefault(_connectionManager),_globalize=_interopRequireDefault(_globalize),_dom=_interopRequireDefault(_dom);var currentSelectionCommandsPanel,selectedItems=[],selectedElements=[];function hideSelections(){var selectionCommandsPanel=currentSelectionCommandsPanel;if(selectionCommandsPanel){selectionCommandsPanel.parentNode.removeChild(selectionCommandsPanel),currentSelectionCommandsPanel=null,selectedItems=[],selectedElements=[];for(var elems=document.querySelectorAll(".itemSelectionPanel"),i=0,length=elems.length;i<length;i++){var parent=elems[i].parentNode;parent.removeChild(elems[i]),parent.classList.remove("withMultiSelect")}}}function updateItemSelection(chkItemSelect,selected){var id=_dom.default.parentWithAttribute(chkItemSelect,"data-id").getAttribute("data-id");selected?selectedItems.filter((function(i){return i===id})).length||(selectedItems.push(id),selectedElements.push(chkItemSelect)):(selectedItems=selectedItems.filter((function(i){return i!==id})),selectedElements=selectedElements.filter((function(i){return i!==chkItemSelect})));if(selectedItems.length){var itemSelectionCount=document.querySelector(".itemSelectionCount");itemSelectionCount&&(itemSelectionCount.innerHTML=selectedItems.length)}else hideSelections()}function onSelectionChange(e){updateItemSelection(this,this.checked)}function showSelection(item,isChecked){var itemSelectionPanel=item.querySelector(".itemSelectionPanel");if(!itemSelectionPanel){(itemSelectionPanel=document.createElement("div")).classList.add("itemSelectionPanel");var parent=item.querySelector(".cardBox")||item.querySelector(".cardContent");parent.classList.add("withMultiSelect"),parent.appendChild(itemSelectionPanel);var cssClass="chkItemSelect";isChecked&&!_browser.default.firefox&&(cssClass+=" checkedInitial");var checkedAttribute=isChecked?" checked":"";itemSelectionPanel.innerHTML='<label class="checkboxContainer"><input type="checkbox" is="emby-checkbox" data-outlineclass="multiSelectCheckboxOutline" class="'.concat(cssClass,'"').concat(checkedAttribute,"/><span></span></label>"),itemSelectionPanel.querySelector(".chkItemSelect").addEventListener("change",onSelectionChange)}}function deleteItems(apiClient,itemIds){return new Promise((function(resolve,reject){var msg=_globalize.default.translate("ConfirmDeleteItem"),title=_globalize.default.translate("HeaderDeleteItem");itemIds.length>1&&(msg=_globalize.default.translate("ConfirmDeleteItems"),title=_globalize.default.translate("HeaderDeleteItems")),new Promise((function(_resolve,_reject){return _require(["confirm"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref2){(0,_ref2.default)(msg,title).then((function(){var promises=itemIds.map((function(itemId){apiClient.deleteItem(itemId)}));Promise.all(promises).then(resolve,(function(){(function alertText(options){return new Promise((function(resolve,reject){new Promise((function(_resolve,_reject){return _require(["alert"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref){(0,_ref.default)(options).then(resolve,resolve)}))}))})(_globalize.default.translate("ErrorDeletingItem")).then(reject,reject)}))}),reject)}))}))}function showMenuForSelectedItems(e){var apiClient=_connectionManager.default.currentApiClient();apiClient.getCurrentUser().then((function(user){var menuItems=[];menuItems.push({name:_globalize.default.translate("AddToCollection"),id:"addtocollection",icon:"add"}),menuItems.push({name:_globalize.default.translate("AddToPlaylist"),id:"playlist",icon:"playlist_add"}),user.Policy.EnableContentDeletion&&menuItems.push({name:_globalize.default.translate("Delete"),id:"delete",icon:"delete"}),user.Policy.EnableContentDownloading&&_apphost.default.supports("filedownload")&&menuItems.push({name:_globalize.default.translate("Download"),id:"download",icon:"file_download"}),user.Policy.IsAdministrator&&menuItems.push({name:_globalize.default.translate("GroupVersions"),id:"groupvideos",icon:"call_merge"}),menuItems.push({name:_globalize.default.translate("MarkPlayed"),id:"markplayed",icon:"check_box"}),menuItems.push({name:_globalize.default.translate("MarkUnplayed"),id:"markunplayed",icon:"check_box_outline_blank"}),menuItems.push({name:_globalize.default.translate("RefreshMetadata"),id:"refresh",icon:"refresh"}),new Promise((function(_resolve,_reject){return _require(["actionsheet"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref3){_ref3.default.show({items:menuItems,positionTo:e.target,callback:function callback(id){var items=selectedItems.slice(0),serverId=apiClient.serverInfo().Id;switch(id){case"addtocollection":new Promise((function(_resolve,_reject){return _require(["collectionEditor"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref4){new(0,_ref4.default)({items:items,serverId:serverId})})),hideSelections(),dispatchNeedsRefresh();break;case"playlist":new Promise((function(_resolve,_reject){return _require(["playlistEditor"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref5){new(0,_ref5.default)({items:items,serverId:serverId})})),hideSelections(),dispatchNeedsRefresh();break;case"delete":deleteItems(apiClient,items).then(dispatchNeedsRefresh),hideSelections(),dispatchNeedsRefresh();break;case"groupvideos":!function combineVersions(apiClient,selection){if(selection.length<2)return void new Promise((function(_resolve,_reject){return _require(["alert"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref7){(0,_ref7.default)({text:_globalize.default.translate("PleaseSelectTwoItems")})}));_loading.default.show(),apiClient.ajax({type:"POST",url:apiClient.getUrl("Videos/MergeVersions",{Ids:selection.join(",")})}).then((function(){_loading.default.hide(),hideSelections(),dispatchNeedsRefresh()}))}(apiClient,items);break;case"markplayed":items.forEach((function(itemId){apiClient.markPlayed(apiClient.getCurrentUserId(),itemId)})),hideSelections(),dispatchNeedsRefresh();break;case"markunplayed":items.forEach((function(itemId){apiClient.markUnplayed(apiClient.getCurrentUserId(),itemId)})),hideSelections(),dispatchNeedsRefresh();break;case"refresh":new Promise((function(_resolve,_reject){return _require(["refreshDialog"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref6){new(0,_ref6.default)({itemIds:items,serverId:serverId}).show()})),hideSelections(),dispatchNeedsRefresh()}}})}))}))}function dispatchNeedsRefresh(){var elems=[];[].forEach.call(selectedElements,(function(i){var container=_dom.default.parentWithAttribute(i,"is","emby-itemscontainer");container&&!elems.includes(container)&&elems.push(container)}));for(var i=0,length=elems.length;i<length;i++)elems[i].notifyRefreshNeeded(!0)}function showSelections(initialCard){new Promise((function(_resolve,_reject){return _require(["emby-checkbox"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(){for(var cards=document.querySelectorAll(".card"),i=0,length=cards.length;i<length;i++)showSelection(cards[i],initialCard===cards[i]);!function showSelectionCommands(){var selectionCommandsPanel=currentSelectionCommandsPanel;if(!selectionCommandsPanel){(selectionCommandsPanel=document.createElement("div")).classList.add("selectionCommandsPanel"),document.body.appendChild(selectionCommandsPanel),currentSelectionCommandsPanel=selectionCommandsPanel;var html="";html+='<button is="paper-icon-button-light" class="btnCloseSelectionPanel autoSize"><span class="material-icons close"></span></button>',html+='<h1 class="itemSelectionCount"></h1>';html+='<button is="paper-icon-button-light" class="btnSelectionPanelOptions autoSize" style="margin-left:auto;"><span class="material-icons '.concat("more_vert",'"></span></button>'),selectionCommandsPanel.innerHTML=html,selectionCommandsPanel.querySelector(".btnCloseSelectionPanel").addEventListener("click",hideSelections);var btnSelectionPanelOptions=selectionCommandsPanel.querySelector(".btnSelectionPanelOptions");_dom.default.addEventListener(btnSelectionPanelOptions,"click",showMenuForSelectedItems,{passive:!0})}}(),updateItemSelection(initialCard,!0)}))}function onContainerClick(e){var target=e.target;if(selectedItems.length){var card=_dom.default.parentWithClass(target,"card");if(card){var itemSelectionPanel=card.querySelector(".itemSelectionPanel");if(itemSelectionPanel)return function onItemSelectionPanelClick(e,itemSelectionPanel){if(!_dom.default.parentWithClass(e.target,"chkItemSelect")){var chkItemSelect=itemSelectionPanel.querySelector(".chkItemSelect");if(chkItemSelect)if(chkItemSelect.classList.contains("checkedInitial"))chkItemSelect.classList.remove("checkedInitial");else{var newValue=!chkItemSelect.checked;chkItemSelect.checked=newValue,updateItemSelection(chkItemSelect,newValue)}}return e.preventDefault(),e.stopPropagation(),!1}(e,itemSelectionPanel)}return e.preventDefault(),e.stopPropagation(),!1}}document.addEventListener("viewbeforehide",hideSelections)}));
//# sourceMappingURL=multiSelect.js.map
