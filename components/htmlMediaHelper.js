define(["exports","appSettings","browser","events"],(function(_exports,_appSettings,_browser,_events){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var recoverDecodingErrorDate,recoverSwapAudioCodecDate;function handleHlsJsMediaError(instance,reject){var hlsPlayer=instance._hlsPlayer;if(hlsPlayer){var now=Date.now();window.performance&&window.performance.now&&(now=performance.now()),!recoverDecodingErrorDate||now-recoverDecodingErrorDate>3e3?(recoverDecodingErrorDate=now,console.debug("try to recover media Error ..."),hlsPlayer.recoverMediaError()):!recoverSwapAudioCodecDate||now-recoverSwapAudioCodecDate>3e3?(recoverSwapAudioCodecDate=now,console.debug("try to swap Audio Codec and recover media Error ..."),hlsPlayer.swapAudioCodec(),hlsPlayer.recoverMediaError()):(console.error("cannot recover, last media error recovery failed ..."),reject?reject():onErrorInternal(instance,"mediadecodeerror"))}}function onErrorInternal(instance,type){instance.destroyCustomTrack&&instance.destroyCustomTrack(instance._mediaElement),_events.default.trigger(instance,"error",[{type:type}])}function isValidDuration(duration){return!(!duration||isNaN(duration)||duration===Number.POSITIVE_INFINITY||duration===Number.NEGATIVE_INFINITY)}function setCurrentTimeIfNeeded(element,seconds){Math.abs(element.currentTime||0,seconds)<=1&&(element.currentTime=seconds)}function onSuccessfulPlay(elem,onErrorFn){elem.addEventListener("error",onErrorFn)}function playWithPromise(elem,onErrorFn){try{var promise=elem.play();return promise&&promise.then?promise.catch((function(e){var errorName=(e.name||"").toLowerCase();return"notallowederror"===errorName||"aborterror"===errorName?(onSuccessfulPlay(elem,onErrorFn),Promise.resolve()):Promise.reject()})):(onSuccessfulPlay(elem,onErrorFn),Promise.resolve())}catch(err){return console.error("error calling video.play: "+err),Promise.reject()}}function destroyCastPlayer(instance){var player=instance._castPlayer;if(player){try{player.unload()}catch(err){console.error(err)}instance._castPlayer=null}}function destroyHlsPlayer(instance){var player=instance._hlsPlayer;if(player){try{player.destroy()}catch(err){console.error(err)}instance._hlsPlayer=null}}function destroyFlvPlayer(instance){var player=instance._flvPlayer;if(player){try{player.unload(),player.detachMediaElement(),player.destroy()}catch(err){console.error(err)}instance._flvPlayer=null}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.getSavedVolume=function getSavedVolume(){return _appSettings.default.get("volume")||1},_exports.saveVolume=function saveVolume(value){value&&_appSettings.default.set("volume",value)},_exports.getCrossOriginValue=function getCrossOriginValue(mediaSource){if(mediaSource.IsRemote)return null;return"anonymous"},_exports.enableHlsJsPlayer=function enableHlsJsPlayer(runTimeTicks,mediaType){if(null==window.MediaSource)return!1;if(_browser.default.iOS)return!1;if(_browser.default.tizen||_browser.default.web0s)return!1;if(function canPlayNativeHls(){var media=document.createElement("video");if(media.canPlayType("application/x-mpegURL").replace(/no/,"")||media.canPlayType("application/vnd.apple.mpegURL").replace(/no/,""))return!0;return!1}()){if(_browser.default.android&&"Audio"===mediaType)return!0;if(_browser.default.edge,runTimeTicks)return!1}return!0},_exports.handleHlsJsMediaError=handleHlsJsMediaError,_exports.onErrorInternal=onErrorInternal,_exports.isValidDuration=isValidDuration,_exports.seekOnPlaybackStart=function seekOnPlaybackStart(instance,element,ticks,onMediaReady){var seconds=(ticks||0)/1e7;if(seconds)if(element.duration>=seconds)setCurrentTimeIfNeeded(element,seconds),onMediaReady&&onMediaReady();else{var events=["durationchange","loadeddata","play","loadedmetadata"],onMediaChange=function onMediaChange(e){0===element.currentTime&&element.duration>=seconds&&(console.debug("seeking to ".concat(seconds," on ").concat(e.type," event")),setCurrentTimeIfNeeded(element,seconds),events.map((function(name){element.removeEventListener(name,onMediaChange)})),onMediaReady&&onMediaReady())};events.map((function(name){return element.addEventListener(name,onMediaChange)}))}},_exports.applySrc=function applySrc(elem,src,options){if(window.Windows&&options.mediaSource&&options.mediaSource.IsLocal)return Windows.Storage.StorageFile.getFileFromPathAsync(options.url).then((function(file){var playlist=new Windows.Media.Playback.MediaPlaybackList,source1=Windows.Media.Core.MediaSource.createFromStorageFile(file),startTime=(options.playerStartPositionTicks||0)/1e4;return playlist.items.append(new Windows.Media.Playback.MediaPlaybackItem(source1,startTime)),elem.src=URL.createObjectURL(playlist,{oneTimeOnly:!0}),Promise.resolve()}));elem.src=src;return Promise.resolve()},_exports.playWithPromise=playWithPromise,_exports.destroyCastPlayer=destroyCastPlayer,_exports.destroyHlsPlayer=destroyHlsPlayer,_exports.destroyFlvPlayer=destroyFlvPlayer,_exports.bindEventsToHlsPlayer=function bindEventsToHlsPlayer(instance,hls,elem,onErrorFn,resolve,reject){hls.on(Hls.Events.MANIFEST_PARSED,(function(){playWithPromise(elem,onErrorFn).then(resolve,(function(){reject&&(reject(),reject=null)}))})),hls.on(Hls.Events.ERROR,(function(event,data){switch(console.error("HLS Error: Type: "+data.type+" Details: "+(data.details||"")+" Fatal: "+(data.fatal||!1)),data.type){case Hls.ErrorTypes.NETWORK_ERROR:if(data.response&&data.response.code&&data.response.code>=400)return console.debug("hls.js response error code: "+data.response.code),hls.destroy(),void(reject?(reject("servererror"),reject=null):onErrorInternal(instance,"servererror"))}if(data.fatal)switch(data.type){case Hls.ErrorTypes.NETWORK_ERROR:data.response&&0===data.response.code?(console.debug("hls.js response error code: "+data.response.code),hls.destroy(),reject?(reject("network"),reject=null):onErrorInternal(instance,"network")):(console.debug("fatal network error encountered, try to recover"),hls.startLoad());break;case Hls.ErrorTypes.MEDIA_ERROR:console.debug("fatal media error encountered, try to recover");var currentReject=reject;reject=null,handleHlsJsMediaError(instance,currentReject);break;default:console.debug("Cannot recover from hls error - destroy and trigger error"),hls.destroy(),reject?(reject(),reject=null):onErrorInternal(instance,"mediadecodeerror")}}))},_exports.onEndedInternal=function onEndedInternal(instance,elem,onErrorFn){elem.removeEventListener("error",onErrorFn),elem.src="",elem.innerHTML="",elem.removeAttribute("src"),destroyHlsPlayer(instance),destroyFlvPlayer(instance),destroyCastPlayer(instance);var stopInfo={src:instance._currentSrc};_events.default.trigger(instance,"stopped",[stopInfo]),instance._currentTime=null,instance._currentSrc=null,instance._currentPlayOptions=null},_exports.getBufferedRanges=function getBufferedRanges(instance,elem){var offset,ranges=[],seekable=elem.buffered||[],currentPlayOptions=instance._currentPlayOptions;currentPlayOptions&&(offset=currentPlayOptions.transcodingOffsetTicks);offset=offset||0;for(var i=0,length=seekable.length;i<length;i++){var start=seekable.start(i),end=seekable.end(i);isValidDuration(start)||(start=0),isValidDuration(end)?ranges.push({start:1e7*start+offset,end:1e7*end+offset}):end=0}return ranges},_appSettings=_interopRequireDefault(_appSettings),_browser=_interopRequireDefault(_browser),_events=_interopRequireDefault(_events)}));
//# sourceMappingURL=htmlMediaHelper.js.map
