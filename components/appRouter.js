define(["require","exports","apphost","appSettings","backdrop","browser","connectionManager","events","globalize","itemHelper","loading","page","viewManager"],(function(_require,_exports,_apphost,_appSettings,_backdrop,_browser,_connectionManager,_events,_globalize,_itemHelper,_loading,_page,_viewManager){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var cache=new WeakMap;return _getRequireWildcardCache=function _getRequireWildcardCache(){return cache},cache}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache();if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_apphost=_interopRequireDefault(_apphost),_appSettings=_interopRequireDefault(_appSettings),_backdrop=_interopRequireDefault(_backdrop),_browser=_interopRequireDefault(_browser),_connectionManager=_interopRequireDefault(_connectionManager),_events=_interopRequireDefault(_events),_globalize=_interopRequireDefault(_globalize),_itemHelper=_interopRequireDefault(_itemHelper),_loading=_interopRequireDefault(_loading),_page=_interopRequireDefault(_page),_viewManager=_interopRequireDefault(_viewManager);var _default=new(function(){function AppRouter(){var _this=this;!function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,AppRouter),_defineProperty(this,"allRoutes",[]),_defineProperty(this,"backdropContainer",void 0),_defineProperty(this,"backgroundContainer",void 0),_defineProperty(this,"currentRouteInfo",void 0),_defineProperty(this,"currentViewLoadRequest",void 0),_defineProperty(this,"firstConnectionResult",void 0),_defineProperty(this,"forcedLogoutMsg",void 0),_defineProperty(this,"handleAnchorClick",_page.default.clickHandler),_defineProperty(this,"isDummyBackToHome",void 0),_defineProperty(this,"msgTimeout",void 0),_defineProperty(this,"popstateOccurred",!1),_defineProperty(this,"resolveOnNextShow",void 0),_defineProperty(this,"startPages",["home","login","selectserver"]),window.addEventListener("popstate",(function(){_this.popstateOccurred=!0})),document.addEventListener("viewshow",(function(){var resolve=_this.resolveOnNextShow;resolve&&(_this.resolveOnNextShow=null,resolve())})),this.baseRoute=window.location.href.split("?")[0].replace(this.getRequestFile(),""),this.baseRoute=this.baseRoute.split("#")[0],this.baseRoute.endsWith("/")&&!this.baseRoute.endsWith("://")&&(this.baseRoute=this.baseRoute.substring(0,this.baseRoute.length-1)),this.setBaseRoute()}return function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}(AppRouter,[{key:"setBaseRoute",value:function setBaseRoute(){var baseRoute=window.location.pathname.replace(this.getRequestFile(),"");baseRoute.lastIndexOf("/")===baseRoute.length-1&&(baseRoute=baseRoute.substring(0,baseRoute.length-1)),console.debug("setting page base to "+baseRoute),_page.default.base(baseRoute)}},{key:"addRoute",value:function addRoute(path,newRoute){(0,_page.default)(path,this.getHandler(newRoute)),this.allRoutes.push(newRoute)}},{key:"showLocalLogin",value:function showLocalLogin(serverId){Dashboard.navigate("login.html?serverid="+serverId)}},{key:"showVideoOsd",value:function showVideoOsd(){return Dashboard.navigate("video")}},{key:"showSelectServer",value:function showSelectServer(){Dashboard.navigate(AppInfo.isNativeApp?"selectserver.html":"login.html")}},{key:"showWelcome",value:function showWelcome(){Dashboard.navigate(AppInfo.isNativeApp?"selectserver.html":"login.html")}},{key:"showSettings",value:function showSettings(){Dashboard.navigate("mypreferencesmenu.html")}},{key:"showNowPlaying",value:function showNowPlaying(){this.show("queue")}},{key:"beginConnectionWizard",value:function beginConnectionWizard(){var _this2=this;_backdrop.default.clearBackdrop(),_loading.default.show(),_connectionManager.default.connect({enableAutoLogin:_appSettings.default.enableAutoLogin()}).then((function(result){_this2.handleConnectionResult(result)}))}},{key:"param",value:function param(name,url){name=name.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");var results=new RegExp("[\\?&]"+name+"=([^&#]*)","i").exec(url||getWindowLocationSearch());return null==results?"":decodeURIComponent(results[1].replace(/\+/g," "))}},{key:"back",value:function back(){_page.default.back()}},{key:"show",value:function show(path,options){var _this3=this;return 0!==path.indexOf("/")&&-1===path.indexOf("://")&&(path="/"+path),path=path.replace(this.baseUrl(),""),this.currentRouteInfo&&this.currentRouteInfo.path===path&&"home"!==this.currentRouteInfo.route.type?(_loading.default.hide(),Promise.resolve()):new Promise((function(resolve){_this3.resolveOnNextShow=resolve,_page.default.show(path,options)}))}},{key:"showDirect",value:function showDirect(path){return new Promise((function(resolve){this.resolveOnNextShow=resolve,_page.default.show(this.baseUrl()+path)}))}},{key:"start",value:function start(options){var _this4=this;_loading.default.show(),this.initApiClients(),_events.default.on(_apphost.default,"beforeexit",this.onBeforeExit),_events.default.on(_apphost.default,"resume",this.onAppResume),_connectionManager.default.connect({enableAutoLogin:_appSettings.default.enableAutoLogin()}).then((function(result){_this4.firstConnectionResult=result,options=options||{},(0,_page.default)({click:!1!==options.click,hashbang:!1!==options.hashbang})})).catch().then((function(){_loading.default.hide()}))}},{key:"baseUrl",value:function baseUrl(){return this.baseRoute}},{key:"canGoBack",value:function canGoBack(){var curr=this.current();return!!curr&&(!(!document.querySelector(".dialogContainer")&&-1!==this.startPages.indexOf(curr.type))&&window.history.length>1)}},{key:"current",value:function current(){return this.currentRouteInfo?this.currentRouteInfo.route:null}},{key:"invokeShortcut",value:function invokeShortcut(id){0===id.indexOf("library-")?(id=(id=id.replace("library-","")).split("_"),this.showItem(id[0],id[1])):0===id.indexOf("item-")?(id=(id=id.replace("item-","")).split("_"),this.showItem(id[0],id[1])):(id=id.split("_"),this.show(this.getRouteUrl(id[0],{serverId:id[1]})))}},{key:"showItem",value:function showItem(item,serverId,options){var _this5=this;if("string"==typeof item){var apiClient=serverId?_connectionManager.default.getApiClient(serverId):_connectionManager.default.currentApiClient();apiClient.getItem(apiClient.getCurrentUserId(),item).then((function(itemObject){_this5.showItem(itemObject,options)}))}else{2===arguments.length&&(options=arguments[1]);var url=this.getRouteUrl(item,options);this.show(url,{item:item})}}},{key:"setTransparency",value:function setTransparency(level){this.backdropContainer||(this.backdropContainer=document.querySelector(".backdropContainer")),this.backgroundContainer||(this.backgroundContainer=document.querySelector(".backgroundContainer")),"full"===level||2===level?(_backdrop.default.clearBackdrop(!0),document.documentElement.classList.add("transparentDocument"),this.backgroundContainer.classList.add("backgroundContainer-transparent"),this.backdropContainer.classList.add("hide")):"backdrop"===level||1===level?(_backdrop.default.externalBackdrop(!0),document.documentElement.classList.add("transparentDocument"),this.backgroundContainer.classList.add("backgroundContainer-transparent"),this.backdropContainer.classList.add("hide")):(_backdrop.default.externalBackdrop(!1),document.documentElement.classList.remove("transparentDocument"),this.backgroundContainer.classList.remove("backgroundContainer-transparent"),this.backdropContainer.classList.remove("hide"))}},{key:"getRoutes",value:function getRoutes(){return this.allRoutes}},{key:"pushState",value:function pushState(state,title,url){state.navigate=!1,window.history.pushState(state,title,url)}},{key:"enableNativeHistory",value:function enableNativeHistory(){return!1}},{key:"handleConnectionResult",value:function handleConnectionResult(result){var _this6=this;switch(result.State){case"SignedIn":_loading.default.hide(),Emby.Page.goHome();break;case"ServerSignIn":result.ApiClient.getPublicUsers().then((function(users){users.length?_this6.showLocalLogin(result.Servers[0].Id):_this6.showLocalLogin(result.Servers[0].Id,!0)}));break;case"ServerSelection":this.showSelectServer();break;case"ConnectSignIn":this.showWelcome();break;case"ServerUpdateNeeded":new Promise((function(_resolve,_reject){return _require(["alert"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref){(0,_ref.default)({text:_globalize.default.translate("ServerUpdateNeeded","https://github.com/jellyfin/jellyfin"),html:_globalize.default.translate("ServerUpdateNeeded",'<a href="https://github.com/jellyfin/jellyfin">https://github.com/jellyfin/jellyfin</a>')}).then((function(){_this6.showSelectServer()}))}))}}},{key:"loadContentUrl",value:function loadContentUrl(ctx,next,route,request){var url,_this7=this;-1===(url=route.contentPath&&"function"==typeof route.contentPath?route.contentPath(ctx.querystring):route.contentPath||route.path).indexOf("://")&&(0!==url.indexOf("/")&&(url="/"+url),url=this.baseUrl()+url),ctx.querystring&&route.enableContentQueryString&&(url+="?"+ctx.querystring),new Promise((function(_resolve,_reject){return _require(["".concat("text!"+url)],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref2){var html=_ref2.default;_this7.loadContent(ctx,route,html,request)}))}},{key:"handleRoute",value:function handleRoute(ctx,next,route){var _this8=this;this.authenticate(ctx,route,(function(){_this8.initRoute(ctx,next,route)}))}},{key:"initRoute",value:function initRoute(ctx,next,route){var _this9=this,onInitComplete=function onInitComplete(controllerFactory){_this9.sendRouteToViewManager(ctx,next,route,controllerFactory)};route.controller?new Promise((function(_resolve,_reject){return _require(["".concat("controllers/"+route.controller)],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then(onInitComplete):onInitComplete()}},{key:"cancelCurrentLoadRequest",value:function cancelCurrentLoadRequest(){var currentRequest=this.currentViewLoadRequest;currentRequest&&(currentRequest.cancel=!0)}},{key:"sendRouteToViewManager",value:function sendRouteToViewManager(ctx,next,route,controllerFactory){var _this10=this;if(this.isDummyBackToHome&&"home"===route.type)this.isDummyBackToHome=!1;else{this.cancelCurrentLoadRequest();var isBackNav=ctx.isBack,currentRequest={url:this.baseUrl()+ctx.path,transition:route.transition,isBack:isBackNav,state:ctx.state,type:route.type,fullscreen:route.fullscreen,controllerFactory:controllerFactory,options:{supportsThemeMedia:route.supportsThemeMedia||!1,enableMediaControl:!1!==route.enableMediaControl},autoFocus:route.autoFocus};this.currentViewLoadRequest=currentRequest;var onNewViewNeeded=function onNewViewNeeded(){"string"==typeof route.path?_this10.loadContentUrl(ctx,next,route,currentRequest):next()};isBackNav?_viewManager.default.tryRestoreView(currentRequest,(function(){_this10.currentRouteInfo={route:route,path:ctx.path}})).catch((function(result){result&&result.cancelled||onNewViewNeeded()})):onNewViewNeeded()}}},{key:"onForcedLogoutMessageTimeout",value:function onForcedLogoutMessageTimeout(){var msg=this.forcedLogoutMsg;this.forcedLogoutMsg=null,msg&&new Promise((function(_resolve,_reject){return _require(["alert"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(alert){alert(msg)}))}},{key:"showForcedLogoutMessage",value:function showForcedLogoutMessage(msg){this.forcedLogoutMsg=msg,this.msgTimeout&&clearTimeout(this.msgTimeout),this.msgTimeout=setTimeout(this.onForcedLogoutMessageTimeout,100)}},{key:"onRequestFail",value:function onRequestFail(e,data){403===data.status&&("ParentalControl"===data.errorCode&&(!this.currentRouteInfo||(this.currentRouteInfo.route.anonymous||this.currentRouteInfo.route.startup)||(this.showForcedLogoutMessage(_globalize.default.translate("AccessRestrictedTryAgainLater")),this.showLocalLogin(this.serverId()))))}},{key:"onBeforeExit",value:function onBeforeExit(){_browser.default.web0s&&_page.default.restorePreviousState()}},{key:"normalizeImageOptions",value:function normalizeImageOptions(options){var setQuality;(options.maxWidth||options.width||options.maxHeight||options.height)&&(setQuality=!0),setQuality&&!options.quality&&(options.quality=90)}},{key:"getMaxBandwidth",value:function getMaxBandwidth(){if(navigator.connection){var max=navigator.connection.downlinkMax;if(max&&max>0&&max<Number.POSITIVE_INFINITY)return max/=8,max*=1e6,max*=.7,parseInt(max,10)}return null}},{key:"getMaxBandwidthIOS",value:function getMaxBandwidthIOS(){return 8e5}},{key:"onApiClientCreated",value:function onApiClientCreated(e,newApiClient){newApiClient.normalizeImageOptions=this.normalizeImageOptions,_browser.default.iOS?newApiClient.getMaxBandwidth=this.getMaxBandwidthIOS:newApiClient.getMaxBandwidth=this.getMaxBandwidth,_events.default.off(newApiClient,"requestfail",this.onRequestFail),_events.default.on(newApiClient,"requestfail",this.onRequestFail)}},{key:"initApiClient",value:function initApiClient(apiClient,instance){instance.onApiClientCreated({},apiClient)}},{key:"initApiClients",value:function initApiClients(){var _this11=this;_connectionManager.default.getApiClients().forEach((function(apiClient){_this11.initApiClient(apiClient,_this11)})),_events.default.on(_connectionManager.default,"apiclientcreated",this.onApiClientCreated)}},{key:"onAppResume",value:function onAppResume(){var apiClient=_connectionManager.default.currentApiClient();apiClient&&apiClient.ensureWebSocket()}},{key:"authenticate",value:function authenticate(ctx,route,callback){var firstResult=this.firstConnectionResult;if(!firstResult||(this.firstConnectionResult=null,"SignedIn"===firstResult.State||route.anonymous)){var apiClient=_connectionManager.default.currentApiClient(),pathname=ctx.pathname.toLowerCase();console.debug("appRouter - processing path request "+pathname);var isCurrentRouteStartup=!this.currentRouteInfo||this.currentRouteInfo.route.startup,shouldExitApp=ctx.isBack&&route.isDefaultRoute&&isCurrentRouteStartup;if(!(shouldExitApp||apiClient&&apiClient.isLoggedIn()||route.anonymous))return console.debug("appRouter - route does not allow anonymous access, redirecting to login"),void this.beginConnectionWizard();if(shouldExitApp)return _apphost.default.supports("exit")?void _apphost.default.exit():void 0;if(apiClient&&apiClient.isLoggedIn()){if(console.debug("appRouter - user is authenticated"),route.isDefaultRoute)return console.debug("appRouter - loading skin home page"),void Emby.Page.goHome();if(route.roles)return void this.validateRoles(apiClient,route.roles).then((function(){callback()}),this.beginConnectionWizard)}console.debug("appRouter - proceeding to "+pathname),callback()}else this.handleConnectionResult(firstResult)}},{key:"validateRoles",value:function validateRoles(apiClient,roles){var _this12=this;return Promise.all(roles.split(",").map((function(role){return _this12.validateRole(apiClient,role)})))}},{key:"validateRole",value:function validateRole(apiClient,role){return"admin"===role?apiClient.getCurrentUser().then((function(user){return user.Policy.IsAdministrator?Promise.resolve():Promise.reject()})):Promise.resolve()}},{key:"loadContent",value:function loadContent(ctx,route,html,request){html=_globalize.default.translateHtml(html,route.dictionary),request.view=html,_viewManager.default.loadView(request),this.currentRouteInfo={route:route,path:ctx.path},ctx.handled=!0}},{key:"getRequestFile",value:function getRequestFile(){var path=window.location.pathname||"",index=path.lastIndexOf("/");return(path=-1!==index?path.substring(index):"/"+path)&&"/"!==path||(path="/index.html"),path}},{key:"getHandler",value:function getHandler(route){var _this13=this;return function(ctx,next){ctx.isBack=_this13.popstateOccurred,_this13.handleRoute(ctx,next,route),_this13.popstateOccurred=!1}}},{key:"getWindowLocationSearch",value:function getWindowLocationSearch(){var currentPath=this.currentRouteInfo&&this.currentRouteInfo.path||"",index=currentPath.indexOf("?"),search="";return-1!==index&&(search=currentPath.substring(index)),search||""}},{key:"showGuide",value:function showGuide(){Dashboard.navigate("livetv.html?tab=1")}},{key:"goHome",value:function goHome(){Dashboard.navigate("home.html")}},{key:"showSearch",value:function showSearch(){Dashboard.navigate("search.html")}},{key:"showLiveTV",value:function showLiveTV(){Dashboard.navigate("livetv.html")}},{key:"showRecordedTV",value:function showRecordedTV(){Dashboard.navigate("livetv.html?tab=3")}},{key:"showFavorites",value:function showFavorites(){Dashboard.navigate("home.html?tab=1")}},{key:"setTitle",value:function setTitle(title){LibraryMenu.setTitle(title)}},{key:"getRouteUrl",value:function getRouteUrl(item,options){if(!item)throw new Error("item cannot be null");if(item.url)return item.url;var url,context=options?options.context:null,id=item.Id||item.ItemId;options||(options={});var itemType=item.Type||(options?options.itemType:null),serverId=item.ServerId||options.serverId;if("settings"===item)return"mypreferencesmenu.html";if("wizard"===item)return"wizardstart.html";if("manageserver"===item)return"dashboard.html";if("recordedtv"===item)return"livetv.html?tab=3&serverId="+options.serverId;if("nextup"===item)return"list.html?type=nextup&serverId="+options.serverId;if("list"===item){var _url="list.html?serverId="+options.serverId+"&type="+options.itemTypes;return options.isFavorite&&(_url+="&IsFavorite=true"),_url}if("livetv"===item)return"programs"===options.section?"livetv.html?tab=0&serverId="+options.serverId:"guide"===options.section?"livetv.html?tab=1&serverId="+options.serverId:"movies"===options.section?"list.html?type=Programs&IsMovie=true&serverId="+options.serverId:"shows"===options.section?"list.html?type=Programs&IsSeries=true&IsMovie=false&IsNews=false&serverId="+options.serverId:"sports"===options.section?"list.html?type=Programs&IsSports=true&serverId="+options.serverId:"kids"===options.section?"list.html?type=Programs&IsKids=true&serverId="+options.serverId:"news"===options.section?"list.html?type=Programs&IsNews=true&serverId="+options.serverId:"onnow"===options.section?"list.html?type=Programs&IsAiring=true&serverId="+options.serverId:"dvrschedule"===options.section?"livetv.html?tab=4&serverId="+options.serverId:"seriesrecording"===options.section?"livetv.html?tab=5&serverId="+options.serverId:"livetv.html?serverId="+options.serverId;if("SeriesTimer"==itemType)return"details?seriesTimerId="+id+"&serverId="+serverId;if("livetv"==item.CollectionType)return"livetv.html";if("Genre"===item.Type)return url="list.html?genreId="+item.Id+"&serverId="+serverId,"livetv"===context&&(url+="&type=Programs"),options.parentId&&(url+="&parentId="+options.parentId),url;if("MusicGenre"===item.Type)return url="list.html?musicGenreId="+item.Id+"&serverId="+serverId,options.parentId&&(url+="&parentId="+options.parentId),url;if("Studio"===item.Type)return url="list.html?studioId="+item.Id+"&serverId="+serverId,options.parentId&&(url+="&parentId="+options.parentId),url;if("folders"!==context&&!_itemHelper.default.isLocalItem(item)){if("movies"==item.CollectionType)return url="movies.html?topParentId="+item.Id,options&&"latest"===options.section&&(url+="&tab=1"),url;if("tvshows"==item.CollectionType)return url="tv.html?topParentId="+item.Id,options&&"latest"===options.section&&(url+="&tab=2"),url;if("music"==item.CollectionType)return"music.html?topParentId="+item.Id}return["Playlist","TvChannel","Program","BoxSet","MusicAlbum","MusicGenre","Person","Recording","MusicArtist"].indexOf(itemType)>=0?"details?id="+id+"&serverId="+serverId:"Series"==itemType||"Season"==itemType||"Episode"==itemType?"details?id="+id+(context?"&context="+context:"")+"&serverId="+serverId:item.IsFolder?id?"list.html?parentId="+id+"&serverId="+serverId:"#":"details?id="+id+"&serverId="+serverId}}]),AppRouter}());_exports.default=_default}));
//# sourceMappingURL=appRouter.js.map
