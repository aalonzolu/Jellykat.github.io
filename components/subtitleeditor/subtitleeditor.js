define(["require","exports","dialogHelper","layoutManager","globalize","userSettings","connectionManager","loading","focusManager","dom","emby-select","listViewStyle","paper-icon-button-light","css!./../formdialog","material-icons","css!./subtitleeditor","emby-button","flexStyles"],(function(_require,_exports,_dialogHelper,_layoutManager,_globalize,userSettings,_connectionManager,_loading,_focusManager,_dom,_embySelect,_listViewStyle,_paperIconButtonLight,_formdialog,_materialIcons,_subtitleeditor,_embyButton,_flexStyles){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var cache=new WeakMap;return _getRequireWildcardCache=function _getRequireWildcardCache(){return cache},cache}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache();if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}var currentItem,hasChanges;function downloadRemoteSubtitles(context,id){var url="Items/"+currentItem.Id+"/RemoteSearch/Subtitles/"+id,apiClient=_connectionManager.default.getApiClient(currentItem.ServerId);apiClient.ajax({type:"POST",url:apiClient.getUrl(url)}).then((function(){hasChanges=!0,new Promise((function(_resolve,_reject){return _require(["toast"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref){(0,_ref.default)(_globalize.default.translate("MessageDownloadQueued"))})),_focusManager.default.autoFocus(context)}))}function searchForSubtitles(context,language){userSettings.set("subtitleeditor-language",language),_loading.default.show();var apiClient=_connectionManager.default.getApiClient(currentItem.ServerId),url=apiClient.getUrl("Items/"+currentItem.Id+"/RemoteSearch/Subtitles/"+language);apiClient.getJSON(url).then((function(results){!function renderSearchResults(context,results){var lastProvider="",html="";if(!results.length)return context.querySelector(".noSearchResults").classList.remove("hide"),context.querySelector(".subtitleResults").innerHTML="",void _loading.default.hide();context.querySelector(".noSearchResults").classList.add("hide");for(var i=0,length=results.length;i<length;i++){var result=results[i],provider=result.ProviderName;provider!==lastProvider&&(i>0&&(html+="</div>"),html+="<h2>"+provider+"</h2>",html+="<div>",lastProvider=provider);var tagName=_layoutManager.default.tv?"button":"div",className=_layoutManager.default.tv?"listItem listItem-border btnOptions":"listItem listItem-border";_layoutManager.default.tv&&(className+=" listItem-focusscale listItem-button"),html+="<"+tagName+' class="'+className+'" data-subid="'+result.Id+'">',html+='<span class="listItemIcon material-icons closed_caption"></span>',html+='<div class="listItemBody '+(result.Comment||result.IsHashMatch?"three-line":"two-line")+'">',html+="<div>"+result.Name+"</div>",html+='<div class="secondary listItemBodyText">',result.Format&&(html+='<span style="margin-right:1em;">'+_globalize.default.translate("FormatValue",result.Format)+"</span>"),null!=result.DownloadCount&&(html+="<span>"+_globalize.default.translate("DownloadsValue",result.DownloadCount)+"</span>"),html+="</div>",result.Comment&&(html+='<div class="secondary listItemBodyText">'+result.Comment+"</div>"),result.IsHashMatch&&(html+='<div class="secondary listItemBodyText"><div class="inline-flex align-items-center justify-content-center" style="background:#3388cc;color:#fff;padding: .3em 1em;border-radius:1000em;">'+_globalize.default.translate("PerfectMatch")+"</div></div>"),html+="</div>",_layoutManager.default.tv||(html+='<button type="button" is="paper-icon-button-light" data-subid="'+result.Id+'" class="btnDownload listItemButton"><span class="material-icons file_download"></span></button>'),html+="</"+tagName+">"}results.length&&(html+="</div>"),context.querySelector(".subtitleResults").innerHTML=html,_loading.default.hide()}(context,results)}))}function reload(context,apiClient,itemId){function onGetItem(item){currentItem=item,function fillSubtitleList(context,item){var subs=(item.MediaStreams||[]).filter((function(s){return"Subtitle"===s.Type})),html="";subs.length&&(html+="<h2>"+_globalize.default.translate("MySubtitles")+"</h2>",html+="<div>",html+=subs.map((function(s){var itemHtml="",tagName=_layoutManager.default.tv?"button":"div",className=_layoutManager.default.tv&&s.Path?"listItem listItem-border btnDelete":"listItem listItem-border";return _layoutManager.default.tv&&(className+=" listItem-focusscale listItem-button"),itemHtml+="<"+tagName+' class="'+(className+=" listItem-noborder")+'" data-index="'+s.Index+'">',itemHtml+='<span class="listItemIcon material-icons closed_caption"></span>',itemHtml+='<div class="listItemBody two-line">',itemHtml+="<div>",itemHtml+=s.DisplayTitle||"",itemHtml+="</div>",s.Path&&(itemHtml+='<div class="secondary listItemBodyText">'+s.Path+"</div>"),itemHtml+="</a>",itemHtml+="</div>",_layoutManager.default.tv||s.Path&&(itemHtml+='<button is="paper-icon-button-light" data-index="'+s.Index+'" title="'+_globalize.default.translate("Delete")+'" class="btnDelete listItemButton"><span class="material-icons delete"></span></button>'),itemHtml+="</"+tagName+">"})).join(""),html+="</div>");var elem=context.querySelector(".subtitleList");subs.length?elem.classList.remove("hide"):elem.classList.add("hide"),elem.innerHTML=html}(context,item);var file=item.Path||"",index=Math.max(file.lastIndexOf("/"),file.lastIndexOf("\\"));index>-1&&(file=file.substring(index+1)),file?(context.querySelector(".pathValue").innerHTML=file,context.querySelector(".originalFile").classList.remove("hide")):(context.querySelector(".pathValue").innerHTML="",context.querySelector(".originalFile").classList.add("hide")),_loading.default.hide()}context.querySelector(".noSearchResults").classList.add("hide"),"string"==typeof itemId?apiClient.getItem(apiClient.getCurrentUserId(),itemId).then(onGetItem):onGetItem(itemId)}function onSearchSubmit(e){var lang=this.querySelector("#selectLanguage",this).value;return searchForSubtitles(_dom.default.parentWithClass(this,"formDialogContent"),lang),e.preventDefault(),!1}function onSubtitleListClick(e){var btnDelete=_dom.default.parentWithClass(e.target,"btnDelete");if(btnDelete){var index=btnDelete.getAttribute("data-index");!function deleteLocalSubtitle(context,index){var msg=_globalize.default.translate("MessageAreYouSureDeleteSubtitles");new Promise((function(_resolve,_reject){return _require(["confirm"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref2){(0,_ref2.default)({title:_globalize.default.translate("ConfirmDeletion"),text:msg,confirmText:_globalize.default.translate("Delete"),primary:"delete"}).then((function(){_loading.default.show();var itemId=currentItem.Id,url="Videos/"+itemId+"/Subtitles/"+index,apiClient=_connectionManager.default.getApiClient(currentItem.ServerId);apiClient.ajax({type:"DELETE",url:apiClient.getUrl(url)}).then((function(){hasChanges=!0,reload(context,apiClient,itemId)}))}))}))}(_dom.default.parentWithClass(btnDelete,"subtitleEditorDialog"),index)}}function onSubtitleResultsClick(e){var subtitleId,btnOptions=_dom.default.parentWithClass(e.target,"btnOptions");btnOptions&&(subtitleId=btnOptions.getAttribute("data-subid"),function showDownloadOptions(button,context,subtitleId){var items=[];items.push({name:_globalize.default.translate("Download"),id:"download"}),new Promise((function(_resolve,_reject){return _require(["actionsheet"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref3){_ref3.default.show({items:items,positionTo:button}).then((function(id){switch(id){case"download":downloadRemoteSubtitles(context,subtitleId)}}))}))}(btnOptions,_dom.default.parentWithClass(btnOptions,"subtitleEditorDialog"),subtitleId));var btnDownload=_dom.default.parentWithClass(e.target,"btnDownload");btnDownload&&(subtitleId=btnDownload.getAttribute("data-subid"),downloadRemoteSubtitles(_dom.default.parentWithClass(btnDownload,"subtitleEditorDialog"),subtitleId))}function centerFocus(elem,horiz,on){new Promise((function(_resolve,_reject){return _require(["scrollHelper"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref4){var scrollHelper=_ref4.default,fn=on?"on":"off";scrollHelper.centerFocus[fn](elem,horiz)}))}function showEditorInternal(itemId,serverId,template){hasChanges=!1;var apiClient=_connectionManager.default.getApiClient(serverId);return apiClient.getItem(apiClient.getCurrentUserId(),itemId).then((function(item){var dialogOptions={removeOnClose:!0,scrollY:!1};_layoutManager.default.tv?dialogOptions.size="fullscreen":dialogOptions.size="small";var dlg=_dialogHelper.default.createDialog(dialogOptions);dlg.classList.add("formDialog"),dlg.classList.add("subtitleEditorDialog"),dlg.innerHTML=_globalize.default.translateHtml(template,"core"),dlg.querySelector(".originalSubtitleFileLabel").innerHTML=_globalize.default.translate("File"),dlg.querySelector(".subtitleSearchForm").addEventListener("submit",onSearchSubmit);var btnSubmit=dlg.querySelector(".btnSubmit");_layoutManager.default.tv?(centerFocus(dlg.querySelector(".formDialogContent"),!1,!0),dlg.querySelector(".btnSearchSubtitles").classList.add("hide")):btnSubmit.classList.add("hide");var editorContent=dlg.querySelector(".formDialogContent");return dlg.querySelector(".subtitleList").addEventListener("click",onSubtitleListClick),dlg.querySelector(".subtitleResults").addEventListener("click",onSubtitleResultsClick),apiClient.getCultures().then((function(languages){!function fillLanguages(context,apiClient,languages){var selectLanguage=context.querySelector("#selectLanguage");selectLanguage.innerHTML=languages.map((function(l){return'<option value="'+l.ThreeLetterISOLanguageName+'">'+l.DisplayName+"</option>"}));var lastLanguage=userSettings.get("subtitleeditor-language");lastLanguage?selectLanguage.value=lastLanguage:apiClient.getCurrentUser().then((function(user){var lang=user.Configuration.SubtitleLanguagePreference;lang&&(selectLanguage.value=lang)}))}(editorContent,apiClient,languages)})),dlg.querySelector(".btnCancel").addEventListener("click",(function(){_dialogHelper.default.close(dlg)})),new Promise((function(resolve,reject){dlg.addEventListener("close",(function(){_layoutManager.default.tv&&centerFocus(dlg.querySelector(".formDialogContent"),!1,!1),hasChanges?resolve():reject()})),_dialogHelper.default.open(dlg),reload(editorContent,apiClient,item)}))}))}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_dialogHelper=_interopRequireDefault(_dialogHelper),_layoutManager=_interopRequireDefault(_layoutManager),_globalize=_interopRequireDefault(_globalize),userSettings=_interopRequireWildcard(userSettings),_connectionManager=_interopRequireDefault(_connectionManager),_loading=_interopRequireDefault(_loading),_focusManager=_interopRequireDefault(_focusManager),_dom=_interopRequireDefault(_dom);var _default={show:function showEditor(itemId,serverId){return _loading.default.show(),new Promise((function(resolve,reject){new Promise((function(_resolve,_reject){return _require(["text!./subtitleeditor.template.html"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref5){var template=_ref5.default;showEditorInternal(itemId,serverId,template).then(resolve,reject)}))}))}};_exports.default=_default}));
//# sourceMappingURL=subtitleeditor.js.map
