define(["exports","events","globalize"],(function(_exports,_events,_globalize){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _classPrivateMethodGet(receiver,privateSet,fn){if(!privateSet.has(receiver))throw new TypeError("attempted to get private field on non-instance");return fn}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_events=_interopRequireDefault(_events),_globalize=_interopRequireDefault(_globalize);var cacheParam=(new Date).getTime(),_loadStrings=new WeakSet,_definePluginRoute=new WeakSet,_registerPlugin=new WeakSet,_register=new WeakSet,_mapRoute=new WeakSet,PluginManager=function(){function PluginManager(){!function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,PluginManager),_mapRoute.add(this),_register.add(this),_registerPlugin.add(this),_definePluginRoute.add(this),_loadStrings.add(this),function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}(this,"pluginsList",[])}return function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}(PluginManager,[{key:"loadPlugin",value:function loadPlugin(pluginSpec){var _this=this;if("string"==typeof pluginSpec)return console.debug("Loading plugin (via deprecated requirejs method): "+pluginSpec),new Promise((function(resolve,reject){require([pluginSpec],(function(pluginFactory){var plugin=pluginFactory.default?new pluginFactory.default:new pluginFactory;_this.pluginsList.filter((function(p){return p.id===plugin.id}))[0]&&resolve(pluginSpec),plugin.installUrl=pluginSpec;var separatorIndex=Math.max(pluginSpec.lastIndexOf("/"),pluginSpec.lastIndexOf("\\"));plugin.baseUrl=pluginSpec.substring(0,separatorIndex);var paths={};paths[plugin.id]=plugin.baseUrl,requirejs.config({waitSeconds:0,paths:paths}),_classPrivateMethodGet(_this,_registerPlugin,_registerPlugin2).call(_this,plugin).then(resolve).catch(reject)}))}));if(pluginSpec.then)return pluginSpec.then((function(pluginBuilder){return pluginBuilder()})).then((function(plugin){return console.debug("Plugin loaded: ".concat(plugin.id)),_classPrivateMethodGet(_this,_registerPlugin,_registerPlugin2).call(_this,plugin)}));var err=new TypeError("Plugins have to be a Promise that resolves to a plugin builder function or a RequireJS url (deprecated)");return console.error(err),Promise.reject(err)}},{key:"ofType",value:function ofType(type){return this.pluginsList.filter((function(o){return o.type===type}))}},{key:"mapPath",value:function mapPath(plugin,path,addCacheParam){"string"==typeof plugin&&(plugin=this.pluginsList.filter((function(p){return(p.id||p.packageName)===plugin}))[0]);var url=plugin.baseUrl+"/"+path;return addCacheParam&&(url+=url.includes("?")?"&":"?",url+="v="+cacheParam),url}},{key:"plugins",get:function get(){return this.pluginsList}}]),PluginManager}(),_loadStrings2=function _loadStrings2(plugin){var strings=plugin.getTranslations?plugin.getTranslations():[];return _globalize.default.loadStrings({name:plugin.id||plugin.packageName,strings:strings})},_definePluginRoute2=function _definePluginRoute2(route,plugin){route.contentPath=this.mapPath(plugin,route.path),route.path=_classPrivateMethodGet(this,_mapRoute,_mapRoute2).call(this,plugin,route),Emby.App.defineRoute(route,plugin.id)},_registerPlugin2=function _registerPlugin2(plugin){var _this2=this;return _classPrivateMethodGet(this,_register,_register2).call(this,plugin),plugin.getRoutes&&plugin.getRoutes().forEach((function(route){_classPrivateMethodGet(_this2,_definePluginRoute,_definePluginRoute2).call(_this2,route,plugin)})),"skin"===plugin.type?Promise.resolve(plugin):new Promise((function(resolve,reject){_classPrivateMethodGet(_this2,_loadStrings,_loadStrings2).call(_this2,plugin).then((function(){resolve(plugin)})).catch(reject)}))},_register2=function _register2(obj){this.pluginsList.push(obj),_events.default.trigger(this,"registered",[obj])},_mapRoute2=function _mapRoute2(plugin,route){return"string"==typeof plugin&&(plugin=this.pluginsList.filter((function(p){return(p.id||p.packageName)===plugin}))[0]),(route=route.path||route).toLowerCase().startsWith("http")?route:"/plugins/"+plugin.id+"/"+route},_default=new PluginManager;_exports.default=_default}));
//# sourceMappingURL=pluginManager.js.map
