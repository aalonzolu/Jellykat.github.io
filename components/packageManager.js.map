{"version":3,"sources":["components/packageManager.js"],"names":["define","_exports","_appSettings","_pluginManager","_interopRequireDefault","obj","__esModule","default","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","_classPrivateFieldSet","receiver","privateMap","value","get","TypeError","set","call","_classPrivateFieldGet","_packagesList","WeakMap","_settingsKey","_default","PackageManager","_classCallCheck","instance","Constructor","this","_createClass","protoProps","staticProps","prototype","init","_this","console","groupCollapsed","manifestUrls","JSON","parse","appSettings","Promise","all","map","url","loadPackage","then","debug","resolve","catch","finally","groupEnd","install","_this2","pkg","includes","push","stringify","uninstall","name","filter","p","removeUrl","mapPath","pluginUrl","urlLower","toLowerCase","startsWith","packageUrl","substring","lastIndexOf","addPackage","_this3","throwError","arguments","undefined","reject","xhr","XMLHttpRequest","originalUrl","indexOf","Date","getTime","open","onError","onload","status","response","plugins","plugin","promises","pluginManager","loadPlugin","onerror","send","slice"],"mappings":"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","file":"packageManager.js","sourcesContent":["import appSettings from 'appSettings';\nimport pluginManager from 'pluginManager';\n/* eslint-disable indent */\n\n    class PackageManager {\n        #packagesList = [];\n        #settingsKey = 'installedpackages1';\n\n        init() {\n            console.groupCollapsed('loading packages');\n            var manifestUrls = JSON.parse(appSettings.get(this.#settingsKey) || '[]');\n\n            return Promise.all(manifestUrls.map((url) => {\n                return this.loadPackage(url);\n            }))\n            .then(() => {\n                console.debug('finished loading packages');\n                return Promise.resolve();\n            })\n            .catch(() => {\n                return Promise.resolve();\n            }).finally(() => {\n                console.groupEnd('loading packages');\n            });\n        }\n\n        get packages() {\n            return this.#packagesList.slice(0);\n        }\n\n        install(url) {\n            return this.loadPackage(url, true).then((pkg) => {\n                var manifestUrls = JSON.parse(appSettings.get(this.#settingsKey) || '[]');\n\n                if (!manifestUrls.includes(url)) {\n                    manifestUrls.push(url);\n                    appSettings.set(this.#settingsKey, JSON.stringify(manifestUrls));\n                }\n\n                return pkg;\n            });\n        }\n\n        uninstall(name) {\n            var pkg = this.#packagesList.filter((p) => {\n                return p.name === name;\n            })[0];\n\n            if (pkg) {\n                this.#packagesList = this.#packagesList.filter((p) => {\n                    return p.name !== name;\n                });\n\n                this.removeUrl(pkg.url);\n            }\n\n            return Promise.resolve();\n        }\n\n        mapPath(pkg, pluginUrl) {\n            var urlLower = pluginUrl.toLowerCase();\n            if (urlLower.startsWith('http:') || urlLower.startsWith('https:') || urlLower.startsWith('file:')) {\n                return pluginUrl;\n            }\n\n            var packageUrl = pkg.url;\n            packageUrl = packageUrl.substring(0, packageUrl.lastIndexOf('/'));\n\n            packageUrl += '/';\n            packageUrl += pluginUrl;\n\n            return packageUrl;\n        }\n\n        addPackage(pkg) {\n            this.#packagesList = this.#packagesList.filter((p) => {\n                return p.name !== pkg.name;\n            });\n\n            this.#packagesList.push(pkg);\n        }\n\n        removeUrl(url) {\n            var manifestUrls = JSON.parse(appSettings.get(this.#settingsKey) || '[]');\n\n            manifestUrls = manifestUrls.filter((i) => {\n                return i !== url;\n            });\n\n            appSettings.set(this.#settingsKey, JSON.stringify(manifestUrls));\n        }\n\n        loadPackage(url, throwError = false) {\n            return new Promise((resolve, reject) => {\n                var xhr = new XMLHttpRequest();\n                var originalUrl = url;\n                url += url.indexOf('?') === -1 ? '?' : '&';\n                url += 't=' + new Date().getTime();\n\n                xhr.open('GET', url, true);\n\n                var onError = () => {\n                    if (throwError === true) {\n                        reject();\n                    } else {\n                        this.removeUrl(originalUrl);\n                        resolve();\n                    }\n                };\n\n                xhr.onload = () => {\n                    if (this.status < 400) {\n                        var pkg = JSON.parse(this.response);\n                        pkg.url = originalUrl;\n\n                        this.addPackage(pkg);\n\n                        var plugins = pkg.plugins || [];\n                        if (pkg.plugin) {\n                            plugins.push(pkg.plugin);\n                        }\n                        var promises = plugins.map((pluginUrl) => {\n                            return pluginManager.loadPlugin(this.mapPath(pkg, pluginUrl));\n                        });\n                        Promise.all(promises).then(resolve, resolve);\n                    } else {\n                        onError();\n                    }\n                };\n\n                xhr.onerror = onError;\n\n                xhr.send();\n            });\n        }\n    }\n\n/* eslint-enable indent */\n\nexport default new PackageManager();\n"]}