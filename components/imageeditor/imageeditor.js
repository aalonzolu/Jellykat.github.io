define(["require","exports","dialogHelper","connectionManager","loading","dom","layoutManager","focusManager","globalize","scrollHelper","imageLoader","browser","apphost","cardStyle","formDialogStyle","emby-button","paper-icon-button-light","css!./imageeditor"],(function(_require,_exports,_dialogHelper,_connectionManager,_loading,_dom,_layoutManager,_focusManager,_globalize,_scrollHelper,_imageLoader,_browser,_apphost,_cardStyle,_formDialogStyle,_embyButton,_paperIconButtonLight,_imageeditor){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var cache=new WeakMap;return _getRequireWildcardCache=function _getRequireWildcardCache(){return cache},cache}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache();if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.show=show,_exports.default=void 0,_dialogHelper=_interopRequireDefault(_dialogHelper),_connectionManager=_interopRequireDefault(_connectionManager),_loading=_interopRequireDefault(_loading),_dom=_interopRequireDefault(_dom),_layoutManager=_interopRequireDefault(_layoutManager),_focusManager=_interopRequireDefault(_focusManager),_globalize=_interopRequireDefault(_globalize),_scrollHelper=_interopRequireDefault(_scrollHelper),_imageLoader=_interopRequireDefault(_imageLoader),_browser=_interopRequireDefault(_browser),_apphost=_interopRequireDefault(_apphost);var currentItem,enableFocusTransform=!_browser.default.slow&&!_browser.default.edge,hasChanges=!1;function reload(page,item,focusContext){var apiClient;_loading.default.show(),item?(apiClient=_connectionManager.default.getApiClient(item.ServerId),reloadItem(page,item,apiClient,focusContext)):(apiClient=_connectionManager.default.getApiClient(currentItem.ServerId)).getItem(apiClient.getCurrentUserId(),currentItem.Id).then((function(item){reloadItem(page,item,apiClient,focusContext)}))}function addListeners(container,className,eventName,fn){container.addEventListener(eventName,(function(e){var elem=_dom.default.parentWithClass(e.target,className);elem&&fn.call(elem,e)}))}function reloadItem(page,item,apiClient,focusContext){currentItem=item,apiClient.getRemoteImageProviders(function getBaseRemoteOptions(){var options={};return options.itemId=currentItem.Id,options}()).then((function(providers){for(var btnBrowseAllImages=page.querySelectorAll(".btnBrowseAllImages"),i=0,length=btnBrowseAllImages.length;i<length;i++)providers.length?btnBrowseAllImages[i].classList.remove("hide"):btnBrowseAllImages[i].classList.add("hide");apiClient.getItemImageInfos(currentItem.Id).then((function(imageInfos){!function renderStandardImages(page,apiClient,item,imageInfos,imageProviders){var images=imageInfos.filter((function(i){return"Screenshot"!==i.ImageType&&"Backdrop"!==i.ImageType&&"Chapter"!==i.ImageType}));renderImages(page,item,apiClient,images,imageProviders,page.querySelector("#images"))}(page,apiClient,item,imageInfos,providers),function renderBackdrops(page,apiClient,item,imageInfos,imageProviders){var images=imageInfos.filter((function(i){return"Backdrop"===i.ImageType})).sort((function(a,b){return a.ImageIndex-b.ImageIndex}));images.length?(page.querySelector("#backdropsContainer",page).classList.remove("hide"),renderImages(page,item,apiClient,images,imageProviders,page.querySelector("#backdrops"))):page.querySelector("#backdropsContainer",page).classList.add("hide")}(page,apiClient,item,imageInfos,providers),function renderScreenshots(page,apiClient,item,imageInfos,imageProviders){var images=imageInfos.filter((function(i){return"Screenshot"===i.ImageType})).sort((function(a,b){return a.ImageIndex-b.ImageIndex}));images.length?(page.querySelector("#screenshotsContainer",page).classList.remove("hide"),renderImages(page,item,apiClient,images,imageProviders,page.querySelector("#screenshots"))):page.querySelector("#screenshotsContainer",page).classList.add("hide")}(page,apiClient,item,imageInfos,providers),_loading.default.hide(),_layoutManager.default.tv&&_focusManager.default.autoFocus(focusContext||page)}))}))}function getCardHtml(image,index,numImages,apiClient,imageProviders,imageSize,tagName,enableFooterButtons){var html="",cssClass="card scalableCard imageEditorCard";return cssClass+=" backdropCard backdropCard-scalable","button"===tagName?(cssClass+=" btnImageCard",_layoutManager.default.tv&&(cssClass+=" show-focus",enableFocusTransform&&(cssClass+=" show-animation")),html+='<button type="button" class="'+cssClass+'"'):html+='<div class="'+cssClass+'"',html+=' data-id="'+currentItem.Id+'" data-serverid="'+apiClient.serverId()+'" data-index="'+index+'" data-numimages="'+numImages+'" data-imagetype="'+image.ImageType+'" data-providers="'+imageProviders.length+'"',html+=">",html+='<div class="cardBox visualCardBox">',html+='<div class="cardScalable visualCardBox-cardScalable" style="background-color:transparent;">',html+='<div class="cardPadder-backdrop"></div>',html+='<div class="cardContent">',html+='<div class="cardImageContainer" style="background-image:url(\''+function getImageUrl(item,apiClient,type,index,options){return(options=options||{}).type=type,options.index=index,options.tag="Backdrop"===type?item.BackdropImageTags[index]:"Screenshot"===type?item.ScreenshotImageTags[index]:"Primary"===type&&item.PrimaryImageTag||item.ImageTags[type],apiClient.getScaledImageUrl(item.Id||item.ItemId,options)}(currentItem,apiClient,image.ImageType,image.ImageIndex,{maxWidth:imageSize})+"');background-position:center center;background-size:contain;\"></div>",html+="</div>",html+="</div>",html+='<div class="cardFooter visualCardBox-cardFooter">',html+='<h3 class="cardText cardTextCentered" style="margin:0;">'+_globalize.default.translate(""+image.ImageType)+"</h3>",html+='<div class="cardText cardText-secondary cardTextCentered">',image.Width&&image.Height?html+=image.Width+" X "+image.Height:html+="&nbsp;",html+="</div>",enableFooterButtons&&(html+='<div class="cardText cardTextCentered">',"Backdrop"===image.ImageType||"Screenshot"===image.ImageType?(html+=index>0?'<button type="button" is="paper-icon-button-light" class="btnMoveImage autoSize" data-imagetype="'+image.ImageType+'" data-index="'+image.ImageIndex+'" data-newindex="'+(image.ImageIndex-1)+'" title="'+_globalize.default.translate("MoveLeft")+'"><span class="material-icons chevron_left"></span></button>':'<button type="button" is="paper-icon-button-light" class="autoSize" disabled title="'+_globalize.default.translate("MoveLeft")+'"><span class="material-icons chevron_left"></span></button>',html+=index<numImages-1?'<button type="button" is="paper-icon-button-light" class="btnMoveImage autoSize" data-imagetype="'+image.ImageType+'" data-index="'+image.ImageIndex+'" data-newindex="'+(image.ImageIndex+1)+'" title="'+_globalize.default.translate("MoveRight")+'"><span class="material-icons chevron_right"></span></button>':'<button type="button" is="paper-icon-button-light" class="autoSize" disabled title="'+_globalize.default.translate("MoveRight")+'"><span class="material-icons chevron_right"></span></button>'):imageProviders.length&&(html+='<button type="button" is="paper-icon-button-light" data-imagetype="'+image.ImageType+'" class="btnSearchImages autoSize" title="'+_globalize.default.translate("Search")+'"><span class="material-icons search"></span></button>'),html+='<button type="button" is="paper-icon-button-light" data-imagetype="'+image.ImageType+'" data-index="'+(null!=image.ImageIndex?image.ImageIndex:"null")+'" class="btnDeleteImage autoSize" title="'+_globalize.default.translate("Delete")+'"><span class="material-icons delete"></span></button>',html+="</div>"),html+="</div>",html+="</div>",html+="</"+tagName+">"}function deleteImage(context,itemId,type,index,apiClient,enableConfirmation){var afterConfirm=function afterConfirm(){apiClient.deleteItemImage(itemId,type,index).then((function(){hasChanges=!0,reload(context)}))};enableConfirmation?new Promise((function(_resolve,_reject){return _require(["confirm"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref){(0,_ref.default)({text:_globalize.default.translate("ConfirmDeleteImage"),confirmText:_globalize.default.translate("Delete"),primary:"delete"}).then(afterConfirm)})):afterConfirm()}function moveImage(context,apiClient,itemId,type,index,newIndex,focusContext){apiClient.updateItemImageIndex(itemId,type,index,newIndex).then((function(){hasChanges=!0,reload(context,null,focusContext)}),(function(){new Promise((function(_resolve,_reject){return _require(["alert"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref2){(0,_ref2.default)(_globalize.default.translate("ErrorDefault"))}))}))}function renderImages(page,item,apiClient,images,imageProviders,elem){var html="",imageSize=300,windowSize=_dom.default.getWindowSize();windowSize.innerWidth>=1280&&(imageSize=Math.round(windowSize.innerWidth/4));for(var tagName=_layoutManager.default.tv?"button":"div",enableFooterButtons=!_layoutManager.default.tv,i=0,length=images.length;i<length;i++){html+=getCardHtml(images[i],i,length,apiClient,imageProviders,imageSize,tagName,enableFooterButtons)}elem.innerHTML=html,_imageLoader.default.lazyChildren(elem)}function showImageDownloader(page,imageType){new Promise((function(_resolve,_reject){return _require(["imageDownloader"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref3){_ref3.default.show(currentItem.Id,currentItem.ServerId,currentItem.Type,imageType).then((function(){hasChanges=!0,reload(page)}))}))}function initEditor(context,options){for(var uploadButtons=context.querySelectorAll(".btnOpenUploadMenu"),isFileInputSupported=_apphost.default.supports("fileinput"),i=0,length=uploadButtons.length;i<length;i++)isFileInputSupported?uploadButtons[i].classList.remove("hide"):uploadButtons[i].classList.add("hide");addListeners(context,"btnOpenUploadMenu","click",(function(){var imageType=this.getAttribute("data-imagetype");new Promise((function(_resolve,_reject){return _require(["imageUploader"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref5){_ref5.default.show({theme:options.theme,imageType:imageType,itemId:currentItem.Id,serverId:currentItem.ServerId}).then((function(hasChanged){hasChanged&&(hasChanges=!0,reload(context))}))}))})),addListeners(context,"btnSearchImages","click",(function(){showImageDownloader(context,this.getAttribute("data-imagetype"))})),addListeners(context,"btnBrowseAllImages","click",(function(){showImageDownloader(context,this.getAttribute("data-imagetype")||"Primary")})),addListeners(context,"btnImageCard","click",(function(){!function showActionSheet(context,imageCard){var itemId=imageCard.getAttribute("data-id"),serverId=imageCard.getAttribute("data-serverid"),apiClient=_connectionManager.default.getApiClient(serverId),type=imageCard.getAttribute("data-imagetype"),index=parseInt(imageCard.getAttribute("data-index")),providerCount=parseInt(imageCard.getAttribute("data-providers")),numImages=parseInt(imageCard.getAttribute("data-numimages"));new Promise((function(_resolve,_reject){return _require(["actionsheet"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref4){var actionSheet=_ref4.default,commands=[];commands.push({name:_globalize.default.translate("Delete"),id:"delete"}),"Backdrop"!==type&&"Screenshot"!==type||(index>0&&commands.push({name:_globalize.default.translate("MoveLeft"),id:"moveleft"}),index<numImages-1&&commands.push({name:_globalize.default.translate("MoveRight"),id:"moveright"})),providerCount&&commands.push({name:_globalize.default.translate("Search"),id:"search"}),actionSheet.show({items:commands,positionTo:imageCard}).then((function(id){switch(id){case"delete":deleteImage(context,itemId,type,index,apiClient,!1);break;case"search":showImageDownloader(context,type);break;case"moveleft":moveImage(context,apiClient,itemId,type,index,index-1,_dom.default.parentWithClass(imageCard,"itemsContainer"));break;case"moveright":moveImage(context,apiClient,itemId,type,index,index+1,_dom.default.parentWithClass(imageCard,"itemsContainer"))}}))}))}(context,this)})),addListeners(context,"btnDeleteImage","click",(function(){var type=this.getAttribute("data-imagetype"),index=this.getAttribute("data-index");index="null"===index?null:parseInt(index);var apiClient=_connectionManager.default.getApiClient(currentItem.ServerId);deleteImage(context,currentItem.Id,type,index,apiClient,!0)})),addListeners(context,"btnMoveImage","click",(function(){var type=this.getAttribute("data-imagetype"),index=this.getAttribute("data-index"),newIndex=this.getAttribute("data-newindex"),apiClient=_connectionManager.default.getApiClient(currentItem.ServerId);moveImage(context,apiClient,currentItem.Id,type,index,newIndex,_dom.default.parentWithClass(this,"itemsContainer"))}))}function show(options){return new Promise((function(resolve,reject){hasChanges=!1,function showEditor(options,resolve,reject){var itemId=options.itemId,serverId=options.serverId;_loading.default.show(),new Promise((function(_resolve,_reject){return _require(["text!./imageeditor.template.html"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref6){var template=_ref6.default,apiClient=_connectionManager.default.getApiClient(serverId);apiClient.getItem(apiClient.getCurrentUserId(),itemId).then((function(item){var dialogOptions={removeOnClose:!0};_layoutManager.default.tv?dialogOptions.size="fullscreen":dialogOptions.size="small";var dlg=_dialogHelper.default.createDialog(dialogOptions);dlg.classList.add("formDialog"),dlg.innerHTML=_globalize.default.translateHtml(template,"core"),_layoutManager.default.tv&&_scrollHelper.default.centerFocus.on(dlg,!1),initEditor(dlg,options),dlg.addEventListener("close",(function(){_layoutManager.default.tv&&_scrollHelper.default.centerFocus.off(dlg,!1),_loading.default.hide(),hasChanges?resolve():reject()})),_dialogHelper.default.open(dlg),reload(dlg,item),dlg.querySelector(".btnCancel").addEventListener("click",(function(){_dialogHelper.default.close(dlg)}))}))}))}(options,resolve,reject)}))}var _default={show:show};_exports.default=_default}));
//# sourceMappingURL=imageeditor.js.map
