{"version":3,"sources":["components/images/imageLoader.js"],"names":["_typeof","obj","Symbol","iterator","constructor","prototype","define","_exports","lazyLoader","userSettings","blurhash","_style","_getRequireWildcardCache","WeakMap","cache","_interopRequireWildcard","__esModule","default","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","hasOwnProperty","call","desc","set","_createForOfIteratorHelper","o","allowArrayLike","it","Array","isArray","_unsupportedIterableToArray","minLen","_arrayLikeToArray","n","toString","slice","name","from","test","length","i","F","s","done","value","e","_e","f","TypeError","err","normalCompletion","didErr","step","next","_e2","return","arr","len","arr2","lazyImage","elem","source","arguments","undefined","getAttribute","fillImageElement","itemBlurhashing","target","blurhashstr","isBlurhashValid","pixels","decode","console","error","classList","add","canvas","document","createElement","width","height","ctx","getContext","imgData","createImageData","data","putImageData","requestAnimationFrame","enableFastFadein","parentNode","insertBefore","removeAttribute","fillImage","entry","Error","intersectionRatio","emptyImageElement","url","tagName","style","backgroundImage","replace","backgroundColor","setAttribute","remove","preloaderImg","Image","src","addEventListener","contains","lazyChildren","enableBlurhash","_step","_iterator","querySelectorAll","lazyElem","getPrimaryImageAspectRatio","items","values","ratio","PrimaryImageAspectRatio","sort","a","b","result","half","Math","floor","abs","fillImages","elems","setLazyImage","element","_default"],"mappings":"AAAA,SAASA,QAAQC,KAAmV,OAAtOD,QAArD,mBAAXE,QAAoD,iBAApBA,OAAOC,SAAmC,SAASH,QAAQC,KAAO,cAAcA,KAA2B,SAASD,QAAQC,KAAO,OAAOA,KAAyB,mBAAXC,QAAyBD,IAAIG,cAAgBF,QAAUD,MAAQC,OAAOG,UAAY,gBAAkBJ,MAAyBA,KAEnXK,OAAO,CAAC,UAAW,aAAc,eAAgB,WAAY,gBAAgB,SAAUC,SAAUC,WAAYC,aAAcC,SAAUC,QACnI,aAgBA,SAASC,2BAA6B,GAAuB,mBAAZC,QAAwB,OAAO,KAAM,IAAIC,MAAQ,IAAID,QAA6F,OAAlFD,yBAA2B,SAASA,2BAA6B,OAAOE,OAAiBA,MAE1M,SAASC,wBAAwBd,KAAO,GAAIA,KAAOA,IAAIe,WAAc,OAAOf,IAAO,GAAY,OAARA,KAAiC,WAAjBD,QAAQC,MAAoC,mBAARA,IAAsB,MAAO,CAAEgB,QAAShB,KAAS,IAAIa,MAAQF,2BAA4B,GAAIE,OAASA,MAAMI,IAAIjB,KAAQ,OAAOa,MAAMK,IAAIlB,KAAQ,IAAImB,OAAS,GAAQC,sBAAwBC,OAAOC,gBAAkBD,OAAOE,yBAA0B,IAAK,IAAIC,OAAOxB,IAAO,GAAIqB,OAAOjB,UAAUqB,eAAeC,KAAK1B,IAAKwB,KAAM,CAAE,IAAIG,KAAOP,sBAAwBC,OAAOE,yBAAyBvB,IAAKwB,KAAO,KAAUG,OAASA,KAAKT,KAAOS,KAAKC,KAAQP,OAAOC,eAAeH,OAAQK,IAAKG,MAAgBR,OAAOK,KAAOxB,IAAIwB,KAAyE,OAA7DL,OAAOH,QAAUhB,IAASa,OAASA,MAAMe,IAAI5B,IAAKmB,QAAkBA,OAEhuB,SAASU,2BAA2BC,EAAGC,gBAAkB,IAAIC,GAAI,GAAsB,oBAAX/B,QAAgD,MAAtB6B,EAAE7B,OAAOC,UAAmB,CAAE,GAAI+B,MAAMC,QAAQJ,KAAOE,GAE7J,SAASG,4BAA4BL,EAAGM,QAAU,IAAKN,EAAG,OAAQ,GAAiB,iBAANA,EAAgB,OAAOO,kBAAkBP,EAAGM,QAAS,IAAIE,EAAIjB,OAAOjB,UAAUmC,SAASb,KAAKI,GAAGU,MAAM,GAAI,GAAc,WAANF,GAAkBR,EAAE3B,cAAamC,EAAIR,EAAE3B,YAAYsC,MAAM,GAAU,QAANH,GAAqB,QAANA,EAAa,OAAOL,MAAMS,KAAKZ,GAAI,GAAU,cAANQ,GAAqB,2CAA2CK,KAAKL,GAAI,OAAOD,kBAAkBP,EAAGM,QAFpPD,CAA4BL,KAAOC,gBAAkBD,GAAyB,iBAAbA,EAAEc,OAAqB,CAAMZ,KAAIF,EAAIE,IAAI,IAAIa,EAAI,EAAOC,EAAI,SAASA,MAAQ,MAAO,CAAEC,EAAGD,EAAGR,EAAG,SAASA,IAAM,OAAIO,GAAKf,EAAEc,OAAe,CAAEI,MAAM,GAAe,CAAEA,MAAM,EAAOC,MAAOnB,EAAEe,OAAWK,EAAG,SAASA,EAAEC,IAAM,MAAMA,IAAOC,EAAGN,GAAO,MAAM,IAAIO,UAAU,yIAA4I,IAA6CC,IAAzCC,kBAAmB,EAAMC,QAAS,EAAY,MAAO,CAAET,EAAG,SAASA,IAAMf,GAAKF,EAAE7B,OAAOC,aAAgBoC,EAAG,SAASA,IAAM,IAAImB,KAAOzB,GAAG0B,OAAsC,OAA9BH,iBAAmBE,KAAKT,KAAaS,MAASP,EAAG,SAASA,EAAES,KAAOH,QAAS,EAAMF,IAAMK,KAAQP,EAAG,SAASA,IAAM,IAAWG,kBAAiC,MAAbvB,GAAG4B,QAAgB5B,GAAG4B,SAAY,QAAU,GAAIJ,OAAQ,MAAMF,OAIl9B,SAASjB,kBAAkBwB,IAAKC,MAAkB,MAAPA,KAAeA,IAAMD,IAAIjB,UAAQkB,IAAMD,IAAIjB,QAAQ,IAAK,IAAIC,EAAI,EAAGkB,KAAO,IAAI9B,MAAM6B,KAAMjB,EAAIiB,IAAKjB,IAAOkB,KAAKlB,GAAKgB,IAAIhB,GAAM,OAAOkB,KArBvK,SAASC,UAAUC,MAA8C,IAAxCC,OAAwCC,UAAAvB,OAAA,QAAAwB,IAAAD,UAAA,GAAAA,UAAA,GAA/BF,KAAKI,aAAa,YAClDH,QAILI,iBAAiBL,KAAMC,QAG3B,SAASK,gBAAgBC,OAAQC,aAC7B,GAAIhE,SAASiE,gBAAgBD,aAAc,CAIvC,IAEIE,OACJ,IACIA,OAASlE,SAASmE,OAAOH,YAJf,GACC,IAIb,MAAOnB,KAGL,OAFAuB,QAAQC,MAAM,0BAA2BxB,UACzCkB,OAAOO,UAAUC,IAAI,oBAGzB,IAAMC,OAASC,SAASC,cAAc,UACtCF,OAAOG,MAXO,GAYdH,OAAOI,OAXQ,GAYf,IAAMC,IAAML,OAAOM,WAAW,MACxBC,QAAUF,IAAIG,gBAdN,GACC,IAefD,QAAQE,KAAK9D,IAAI+C,QACjBW,IAAIK,aAAaH,QAAS,EAAG,GAE7BI,uBAAsB,WAClBX,OAAOF,UAAUC,IAAI,mBACjBxE,aAAaqF,mBACbZ,OAAOF,UAAUC,IAAI,6BAErBC,OAAOF,UAAUC,IAAI,wBAGzBR,OAAOsB,WAAWC,aAAad,OAAQT,QACvCA,OAAOO,UAAUC,IAAI,cACrBR,OAAOwB,gBAAgB,qBAK5B,SAASC,UAAUC,OACtB,IAAKA,MACD,MAAM,IAAIC,MAAM,wBAEpB,IAAM3B,OAAS0B,MAAM1B,OACjBN,YAASE,EAGTF,OADAM,OACSA,OAAOH,aAAa,YAEpB6B,MAGTA,MAAME,kBAAoB,EACtBlC,QAAQI,iBAAiBE,OAAQN,QAC7BA,QACR0B,uBAAsB,YAsC9B,SAASS,kBAAkBpC,MACvB,IAAIqC,IAEiB,QAAjBrC,KAAKsC,SACLD,IAAMrC,KAAKuC,MAAMC,gBAAgBjE,MAAM,GAAI,GAAGkE,QAAQ,KAAM,IAC5DzC,KAAKuC,MAAMC,gBAAkB,OAC7BxC,KAAKuC,MAAMG,gBAAkB,OAE7BL,IAAMrC,KAAKI,aAAa,OACxBJ,KAAK2C,aAAa,MAAO,KAE7B3C,KAAK2C,aAAa,WAAYN,KAE9BrC,KAAKc,UAAU8B,OAAO,yBAA0B,qBAChD5C,KAAKc,UAAUC,IAAI,eAnDXqB,CAAkB7B,WAK9B,SAASF,iBAAiBL,KAAMqC,KAC5B,QAAYlC,IAARkC,IACA,MAAM,IAAIjD,UAAU,2BAGxB,IAAMyD,aAAe,IAAIC,MACzBD,aAAaE,IAAMV,IAEnBrC,KAAKc,UAAUC,IAAI,eAEnB8B,aAAaG,iBAAiB,QAAQ,WAClCrB,uBAAsB,WACG,QAAjB3B,KAAKsC,SACLtC,KAAKuC,MAAMC,gBAAkB,QAAUH,IAAM,KACzCrC,KAAKc,UAAUmC,SAAS,gBACxBjD,KAAKuC,MAAMG,gBAAkB,SAGjC1C,KAAK2C,aAAa,MAAON,KAE7BrC,KAAK+B,gBAAgB,YAErB/B,KAAKc,UAAU8B,OAAO,eAClBrG,aAAaqF,mBACb5B,KAAKc,UAAUC,IAAI,0BAEnBf,KAAKc,UAAUC,IAAI,2BAuB5B,SAASmC,aAAalD,MACzB,GAAIzD,aAAa4G,iBAAkB,CAAA,IAAAC,MAAAC,UAAAzF,2BACRoC,KAAKsD,iBAAiB,UADd,IAC/B,IAAAD,UAAAvE,MAAAsE,MAAAC,UAAAhF,KAAAU,MAAuD,CAAA,IAA5CwE,SAA4CH,MAAApE,MAC7CwB,YAAc+C,SAASnD,aAAa,kBACrCmD,SAASzC,UAAUmC,SAAS,aAAc,qBAAuBzC,YAClEF,gBAAgBiD,SAAU/C,aAClBA,aAAgB+C,SAASzC,UAAUmC,SAAS,eACpDM,SAASzC,UAAUC,IAAI,qBANA,MAAA1B,KAAAgE,UAAApE,EAAAI,KAAA,QAAAgE,UAAAlE,KAUnC7C,WAAW4G,aAAalD,KAAMgC,WAG3B,SAASwB,2BAA2BC,OAGvC,IAFA,IAAIC,OAAS,GAEJ9E,EAAI,EAAGD,OAAS8E,MAAM9E,OAAQC,EAAID,OAAQC,IAAK,CACpD,IAAI+E,MAAQF,MAAM7E,GAAGgF,yBAA2B,EAE3CD,QAILD,OAAOA,OAAO/E,QAAUgF,OAG5B,IAAKD,OAAO/E,OACR,OAAO,KAIX+E,OAAOG,MAAK,SAAUC,EAAGC,GACrB,OAAOD,EAAIC,KAGf,IAEIC,OAFAC,KAAOC,KAAKC,MAAMT,OAAO/E,OAAS,GAKlCqF,OADAN,OAAO/E,OAAS,EACP+E,OAAOO,OAENP,OAAOO,KAAO,GAAKP,OAAOO,OAAS,EAKjD,GAAIC,KAAKE,IADO,EAAI,EACKJ,SAAW,IAChC,OAFY,EAAI,EAOpB,GAAIE,KAAKE,IADQ,GAAK,EACIJ,SAAW,GACjC,OAFa,GAAK,EAMtB,GAAIE,KAAKE,IAAI,EAAIJ,SAAW,IACxB,OAAO,EAKX,OAAIE,KAAKE,IADO,EAAI,EACKJ,SAAW,IADpB,EAAI,EAKbA,OAGJ,SAASK,WAAWC,OACvB,IAAK,IAAI1F,EAAI,EAAGD,OAAS2F,MAAM3F,OAAQC,EAAID,OAAQC,IAAK,CAEpDoD,UADWsC,MAAM,KAKlB,SAASC,aAAaC,QAASnC,KAClCmC,QAAQ1D,UAAUC,IAAI,QACtByD,QAAQ7B,aAAa,WAAYN,KACjCtC,UAAUyE,SAzMhBpH,OAAOC,eAAehB,SAAU,aAAc,CAC5C2C,OAAO,IAET3C,SAAS0D,UAAYA,UACrB1D,SAAS2F,UAAYA,UACrB3F,SAAS6G,aAAeA,aACxB7G,SAASmH,2BAA6BA,2BACtCnH,SAASgI,WAAaA,WACtBhI,SAASkI,aAAeA,aACxBlI,SAASU,aAAU,EAdrBT,WAAAO,wBAAAP,YACAC,aAAAM,wBAAAN,cACAC,SAAAK,wBAAAL,UA0PE,IAAIiI,SA1CS,CACXF,aAAcA,aACdF,WAAYA,WACZrC,UAAWA,UACXjC,UAAWA,UACXmD,aAAcA,aACdM,2BAA4BA,4BA4C9BnH,SAASU,QAAU0H","file":"imageLoader.js","sourcesContent":["import * as lazyLoader from 'lazyLoader';\nimport * as userSettings from 'userSettings';\nimport * as blurhash from 'blurhash';\nimport 'css!./style';\n/* eslint-disable indent */\n\n    export function lazyImage(elem, source = elem.getAttribute('data-src')) {\n        if (!source) {\n            return;\n        }\n\n        fillImageElement(elem, source);\n    }\n\n    function itemBlurhashing(target, blurhashstr) {\n        if (blurhash.isBlurhashValid(blurhashstr)) {\n            // Although the default values recommended by Blurhash developers is 32x32, a size of 18x18 seems to be the sweet spot for us,\n            // improving the performance and reducing the memory usage, while retaining almost full blur quality.\n            // Lower values had more visible pixelation\n            const width = 18;\n            const height = 18;\n            let pixels;\n            try {\n                pixels = blurhash.decode(blurhashstr, width, height);\n            } catch (err) {\n                console.error('Blurhash decode error: ', err);\n                target.classList.add('non-blurhashable');\n                return;\n            }\n            const canvas = document.createElement('canvas');\n            canvas.width = width;\n            canvas.height = height;\n            const ctx = canvas.getContext('2d');\n            const imgData = ctx.createImageData(width, height);\n\n            imgData.data.set(pixels);\n            ctx.putImageData(imgData, 0, 0);\n\n            requestAnimationFrame(() => {\n                canvas.classList.add('blurhash-canvas');\n                if (userSettings.enableFastFadein()) {\n                    canvas.classList.add('lazy-blurhash-fadein-fast');\n                } else {\n                    canvas.classList.add('lazy-blurhash-fadein');\n                }\n\n                target.parentNode.insertBefore(canvas, target);\n                target.classList.add('blurhashed');\n                target.removeAttribute('data-blurhash');\n            });\n        }\n    }\n\n    export function fillImage(entry) {\n        if (!entry) {\n            throw new Error('entry cannot be null');\n        }\n        const target = entry.target;\n        var source = undefined;\n\n        if (target) {\n            source = target.getAttribute('data-src');\n        } else {\n            source = entry;\n        }\n\n        if (entry.intersectionRatio > 0) {\n            if (source) fillImageElement(target, source);\n        } else if (!source) {\n            requestAnimationFrame(() => {\n                emptyImageElement(target);\n            });\n        }\n    }\n\n    function fillImageElement(elem, url) {\n        if (url === undefined) {\n            throw new TypeError('url cannot be undefined');\n        }\n\n        const preloaderImg = new Image();\n        preloaderImg.src = url;\n\n        elem.classList.add('lazy-hidden');\n\n        preloaderImg.addEventListener('load', () => {\n            requestAnimationFrame(() => {\n                if (elem.tagName !== 'IMG') {\n                    elem.style.backgroundImage = \"url('\" + url + \"')\";\n                    if (elem.classList.contains('blurhashed')) {\n                        elem.style.backgroundColor = '#fff';\n                    }\n                } else {\n                    elem.setAttribute('src', url);\n                }\n                elem.removeAttribute('data-src');\n\n                elem.classList.remove('lazy-hidden');\n                if (userSettings.enableFastFadein()) {\n                    elem.classList.add('lazy-image-fadein-fast');\n                } else {\n                    elem.classList.add('lazy-image-fadein');\n                }\n            });\n        });\n    }\n\n    function emptyImageElement(elem) {\n        var url;\n\n        if (elem.tagName !== 'IMG') {\n            url = elem.style.backgroundImage.slice(4, -1).replace(/\"/g, '');\n            elem.style.backgroundImage = 'none';\n            elem.style.backgroundColor = null;\n        } else {\n            url = elem.getAttribute('src');\n            elem.setAttribute('src', '');\n        }\n        elem.setAttribute('data-src', url);\n\n        elem.classList.remove('lazy-image-fadein-fast', 'lazy-image-fadein');\n        elem.classList.add('lazy-hidden');\n    }\n\n    export function lazyChildren(elem) {\n        if (userSettings.enableBlurhash()) {\n            for (const lazyElem of elem.querySelectorAll('.lazy')) {\n                const blurhashstr = lazyElem.getAttribute('data-blurhash');\n                if (!lazyElem.classList.contains('blurhashed', 'non-blurhashable') && blurhashstr) {\n                    itemBlurhashing(lazyElem, blurhashstr);\n                } else if (!blurhashstr && !lazyElem.classList.contains('blurhashed')) {\n                    lazyElem.classList.add('non-blurhashable');\n                }\n            }\n        }\n        lazyLoader.lazyChildren(elem, fillImage);\n    }\n\n    export function getPrimaryImageAspectRatio(items) {\n        var values = [];\n\n        for (var i = 0, length = items.length; i < length; i++) {\n            var ratio = items[i].PrimaryImageAspectRatio || 0;\n\n            if (!ratio) {\n                continue;\n            }\n\n            values[values.length] = ratio;\n        }\n\n        if (!values.length) {\n            return null;\n        }\n\n        // Use the median\n        values.sort(function (a, b) {\n            return a - b;\n        });\n\n        var half = Math.floor(values.length / 2);\n\n        var result;\n\n        if (values.length % 2) {\n            result = values[half];\n        } else {\n            result = (values[half - 1] + values[half]) / 2.0;\n        }\n\n        // If really close to 2:3 (poster image), just return 2:3\n        var aspect2x3 = 2 / 3;\n        if (Math.abs(aspect2x3 - result) <= 0.15) {\n            return aspect2x3;\n        }\n\n        // If really close to 16:9 (episode image), just return 16:9\n        var aspect16x9 = 16 / 9;\n        if (Math.abs(aspect16x9 - result) <= 0.2) {\n            return aspect16x9;\n        }\n\n        // If really close to 1 (square image), just return 1\n        if (Math.abs(1 - result) <= 0.15) {\n            return 1;\n        }\n\n        // If really close to 4:3 (poster image), just return 2:3\n        var aspect4x3 = 4 / 3;\n        if (Math.abs(aspect4x3 - result) <= 0.15) {\n            return aspect4x3;\n        }\n\n        return result;\n    }\n\n    export function fillImages(elems) {\n        for (var i = 0, length = elems.length; i < length; i++) {\n            var elem = elems[0];\n            fillImage(elem);\n        }\n    }\n\n    export function setLazyImage(element, url) {\n        element.classList.add('lazy');\n        element.setAttribute('data-src', url);\n        lazyImage(element);\n    }\n\n/* eslint-enable indent */\nexport default {\n    setLazyImage: setLazyImage,\n    fillImages: fillImages,\n    fillImage: fillImage,\n    lazyImage: lazyImage,\n    lazyChildren: lazyChildren,\n    getPrimaryImageAspectRatio: getPrimaryImageAspectRatio\n};\n"]}