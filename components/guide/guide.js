define(["require","exports","inputManager","browser","globalize","connectionManager","scrollHelper","serverNotifications","loading","datetime","focusManager","playbackManager","userSettings","imageLoader","events","layoutManager","itemShortcuts","dom","css!./guide.css","programStyles","material-icons","scrollStyles","emby-programcell","emby-button","paper-icon-button-light","emby-tabs","emby-scroller","flexStyles","webcomponents"],(function(_require,_exports,_inputManager,_browser,_globalize,_connectionManager,_scrollHelper,_serverNotifications,_loading,_datetime,_focusManager,_playbackManager,userSettings,_imageLoader,_events,_layoutManager,_itemShortcuts,_dom,_guide,_programStyles,_materialIcons,_scrollStyles,_embyProgramcell,_embyButton,_paperIconButtonLight,_embyTabs,_embyScroller,_flexStyles,_webcomponents){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _createForOfIteratorHelper(o,allowArrayLike){var it;if("undefined"==typeof Symbol||null==o[Symbol.iterator]){if(Array.isArray(o)||(it=function _unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function F(){};return{s:F,n:function n(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function e(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function s(){it=o[Symbol.iterator]()},n:function n(){var step=it.next();return normalCompletion=step.done,step},e:function e(_e2){didErr=!0,err=_e2},f:function f(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var cache=new WeakMap;return _getRequireWildcardCache=function _getRequireWildcardCache(){return cache},cache}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache();if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function updateProgramCellOnScroll(cell,scrollPct){var left=cell.posLeft;left||(left=parseFloat(cell.style.left.replace("%","")),cell.posLeft=left);var width=cell.posWidth;width||(width=parseFloat(cell.style.width.replace("%","")),cell.posWidth=width);var right=left+width,pctOfWidth=(Math.max(Math.min(scrollPct,right),left)-left)/width*100,guideProgramName=cell.guideProgramName;guideProgramName||(guideProgramName=cell.querySelector(".guideProgramName"),cell.guideProgramName=guideProgramName);var caret=cell.caret;caret||(caret=cell.querySelector(".guide-programNameCaret"),cell.caret=caret),guideProgramName&&(pctOfWidth>0&&pctOfWidth<=100?(guideProgramName.style.transform="translateX("+pctOfWidth+"%)",caret.classList.remove("hide")):(guideProgramName.style.transform="none",caret.classList.add("hide")))}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_inputManager=_interopRequireDefault(_inputManager),_browser=_interopRequireDefault(_browser),_globalize=_interopRequireDefault(_globalize),_connectionManager=_interopRequireDefault(_connectionManager),_scrollHelper=_interopRequireDefault(_scrollHelper),_serverNotifications=_interopRequireDefault(_serverNotifications),_loading=_interopRequireDefault(_loading),_datetime=_interopRequireDefault(_datetime),_focusManager=_interopRequireDefault(_focusManager),_playbackManager=_interopRequireDefault(_playbackManager),userSettings=_interopRequireWildcard(userSettings),_imageLoader=_interopRequireDefault(_imageLoader),_events=_interopRequireDefault(_events),_layoutManager=_interopRequireDefault(_layoutManager),_itemShortcuts=_interopRequireDefault(_itemShortcuts),_dom=_interopRequireDefault(_dom);var isUpdatingProgramCellScroll=!1;function updateProgramCellsOnScroll(programGrid,programCells){isUpdatingProgramCellScroll||(isUpdatingProgramCellScroll=!0,requestAnimationFrame((function(){var _step,scrollLeft=programGrid.scrollLeft,scrollPct=scrollLeft?scrollLeft/programGrid.scrollWidth*100:0,_iterator=_createForOfIteratorHelper(programCells);try{for(_iterator.s();!(_step=_iterator.n()).done;){updateProgramCellOnScroll(_step.value,scrollPct)}}catch(err){_iterator.e(err)}finally{_iterator.f()}isUpdatingProgramCellScroll=!1})))}function onProgramGridClick(e){if(_layoutManager.default.tv){var programCell=_dom.default.parentWithClass(e.target,"programCell");if(programCell){var startDate=programCell.getAttribute("data-startdate"),endDate=programCell.getAttribute("data-enddate");startDate=_datetime.default.parseISO8601Date(startDate,{toLocal:!0}).getTime(),endDate=_datetime.default.parseISO8601Date(endDate,{toLocal:!0}).getTime();var now=(new Date).getTime();if(now>=startDate&&now<endDate){var channelId=programCell.getAttribute("data-channelid"),serverId=programCell.getAttribute("data-serverid");e.preventDefault(),e.stopPropagation(),_playbackManager.default.play({ids:[channelId],serverId:serverId})}}}}var _default=function Guide(options){var self=this,items={};self.options=options,self.categoryOptions={categories:[]};var currentDate,autoRefreshInterval,programCells,lastFocusDirection,programGrid,currentStartIndex=0,currentChannelLimit=0;function restartAutoRefresh(){stopAutoRefresh();autoRefreshInterval=setInterval((function(){self.refresh()}),9e5)}function stopAutoRefresh(){autoRefreshInterval&&(clearInterval(autoRefreshInterval),autoRefreshInterval=null)}function showLoading(){_loading.default.show()}function reloadGuide(context,newStartDate,scrollToTimeMs,focusToTimeMs,startTimeOfDayMs,focusProgramOnRender){var apiClient=_connectionManager.default.getApiClient(options.serverId),channelQuery={StartIndex:0,EnableFavoriteSorting:"false"!==userSettings.get("livetv-favoritechannelsattop")};channelQuery.UserId=apiClient.getCurrentUserId();currentChannelLimit=500,showLoading(),channelQuery.StartIndex=currentStartIndex,channelQuery.Limit=500,channelQuery.AddCurrentProgram=!1,channelQuery.EnableUserData=!1,channelQuery.EnableImageTypes="Primary";var categories=self.categoryOptions.categories||[],displayMovieContent=!categories.length||-1!==categories.indexOf("movies"),displaySportsContent=!categories.length||-1!==categories.indexOf("sports"),displayNewsContent=!categories.length||-1!==categories.indexOf("news"),displayKidsContent=!categories.length||-1!==categories.indexOf("kids"),displaySeriesContent=!categories.length||-1!==categories.indexOf("series");displayMovieContent&&displaySportsContent&&displayNewsContent&&displayKidsContent?(channelQuery.IsMovie=null,channelQuery.IsSports=null,channelQuery.IsKids=null,channelQuery.IsNews=null,channelQuery.IsSeries=null):(displayNewsContent&&(channelQuery.IsNews=!0),displaySportsContent&&(channelQuery.IsSports=!0),displayKidsContent&&(channelQuery.IsKids=!0),displayMovieContent&&(channelQuery.IsMovie=!0),displaySeriesContent&&(channelQuery.IsSeries=!0)),"DatePlayed"===userSettings.get("livetv-channelorder")?(channelQuery.SortBy="DatePlayed",channelQuery.SortOrder="Descending"):(channelQuery.SortBy=null,channelQuery.SortOrder=null);var date=newStartDate;date=new Date(date.getTime()+1e3);var nextDay=new Date(date.getTime()+864e5-2e3),allowIndicators=_dom.default.getWindowSize().innerWidth>=600,renderOptions={showHdIcon:allowIndicators&&"true"===userSettings.get("guide-indicator-hd"),showLiveIndicator:allowIndicators&&"false"!==userSettings.get("guide-indicator-live"),showPremiereIndicator:allowIndicators&&"false"!==userSettings.get("guide-indicator-premiere"),showNewIndicator:allowIndicators&&"false"!==userSettings.get("guide-indicator-new"),showRepeatIndicator:allowIndicators&&"true"===userSettings.get("guide-indicator-repeat"),showEpisodeTitle:!_layoutManager.default.tv};apiClient.getLiveTvChannels(channelQuery).then((function(channelsResult){var btnPreviousPage=context.querySelector(".btnPreviousPage"),btnNextPage=context.querySelector(".btnNextPage");channelsResult.TotalRecordCount>500?(context.querySelector(".guideOptions").classList.remove("hide"),btnPreviousPage.classList.remove("hide"),btnNextPage.classList.remove("hide"),channelQuery.StartIndex?context.querySelector(".btnPreviousPage").disabled=!1:context.querySelector(".btnPreviousPage").disabled=!0,channelQuery.StartIndex+500<channelsResult.TotalRecordCount?btnNextPage.disabled=!1:btnNextPage.disabled=!0):context.querySelector(".guideOptions").classList.add("hide");var programFields=[],programQuery={UserId:apiClient.getCurrentUserId(),MaxStartDate:nextDay.toISOString(),MinEndDate:date.toISOString(),channelIds:channelsResult.Items.map((function(c){return c.Id})).join(","),ImageTypeLimit:1,EnableImages:!1,SortBy:"StartDate",EnableTotalRecordCount:!1,EnableUserData:!1};renderOptions.showHdIcon&&programFields.push("IsHD"),programFields.length&&(programQuery.Fields=programFields.join("")),apiClient.getLiveTvPrograms(programQuery).then((function(programsResult){!function renderGuide(context,date,channels,programs,renderOptions,apiClient,scrollToTimeMs,focusToTimeMs,startTimeOfDayMs,focusProgramOnRender){programs.sort((function(a,b){return getProgramSortOrder(a,channels)-getProgramSortOrder(b,channels)}));var activeElement=document.activeElement,itemId=activeElement&&activeElement.getAttribute?activeElement.getAttribute("data-id"):null,channelRowId=null;activeElement&&(channelRowId=(channelRowId=_dom.default.parentWithClass(activeElement,"channelPrograms"))&&channelRowId.getAttribute?channelRowId.getAttribute("data-channelid"):null);!function renderChannelHeaders(context,channels,apiClient){var _step2,html="",_iterator2=_createForOfIteratorHelper(channels);try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var channel=_step2.value,hasChannelImage=channel.ImageTags.Primary,cssClass="guide-channelHeaderCell itemAction";_layoutManager.default.tv&&(cssClass+=" guide-channelHeaderCell-tv");var title=[];if(channel.ChannelNumber&&title.push(channel.ChannelNumber),channel.Name&&title.push(channel.Name),html+='<button title="'+title.join(" ")+'" type="button" class="'+cssClass+'" data-action="link" data-isfolder="'+channel.IsFolder+'" data-id="'+channel.Id+'" data-serverid="'+channel.ServerId+'" data-type="'+channel.Type+'">',hasChannelImage){var url=apiClient.getScaledImageUrl(channel.Id,{maxHeight:220,tag:channel.ImageTags.Primary,type:"Primary"});html+='<div class="guideChannelImage lazy" data-src="'+url+'"></div>'}channel.ChannelNumber&&(html+='<h3 class="guideChannelNumber">'+channel.ChannelNumber+"</h3>"),!hasChannelImage&&channel.Name&&(html+='<div class="guideChannelName">'+channel.Name+"</div>"),html+="</button>"}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}var channelList=context.querySelector(".channelsContainer");channelList.innerHTML=html,_imageLoader.default.lazyChildren(channelList)}(context,channels,apiClient);var startDate=date,endDate=new Date(startDate.getTime()+864e5);context.querySelector(".timeslotHeaders").innerHTML=function getTimeslotHeadersHtml(startDate,endDateTime){var html="";startDate=new Date(startDate.getTime()),html+='<div class="timeslotHeadersInner">';for(;startDate.getTime()<endDateTime;)html+='<div class="timeslotHeader">',html+=getDisplayTime(startDate),html+="</div>",startDate.setTime(startDate.getTime()+18e5);return html}(startDate,endDate),items={},function renderPrograms(context,date,channels,programs,options){var _step3,listInfo={startIndex:0},html=[],_iterator3=_createForOfIteratorHelper(channels);try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var channel=_step3.value;html.push(getChannelProgramsHtml(context,date,channel,programs,options,listInfo))}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}programGrid.innerHTML=html.join(""),programCells=programGrid.querySelectorAll("[is=emby-programcell]"),updateProgramCellsOnScroll(programGrid,programCells)}(context,date,channels,programs,renderOptions),focusProgramOnRender&&function focusProgram(context,itemId,channelRowId,focusToTimeMs,startTimeOfDayMs){var focusElem;itemId&&(focusElem=context.querySelector('[data-id="'+itemId+'"]'));if(focusElem)_focusManager.default.focus(focusElem);else{var autoFocusParent;channelRowId&&(autoFocusParent=context.querySelector('[data-channelid="'+channelRowId+'"]')),autoFocusParent||(autoFocusParent=programGrid);for(var pct=(focusToTimeMs-=startTimeOfDayMs)/864e5*100,programCell=autoFocusParent.querySelector(".programCell");programCell;){var left=(programCell.style.left||"").replace("%","");left=left?parseFloat(left):0;var width=(programCell.style.width||"").replace("%","");if(width=width?parseFloat(width):0,left>=pct||left+width>=pct)break;programCell=programCell.nextSibling}programCell?_focusManager.default.focus(programCell):_focusManager.default.autoFocus(autoFocusParent,!0)}}(context,itemId,channelRowId,focusToTimeMs,startTimeOfDayMs);!function scrollProgramGridToTimeMs(context,scrollToTimeMs,startTimeOfDayMs){var pct=(scrollToTimeMs-=startTimeOfDayMs)/864e5;programGrid.scrollTop=0;var scrollPos=pct*programGrid.scrollWidth;nativeScrollTo(programGrid,scrollPos,!0)}(0,scrollToTimeMs,startTimeOfDayMs)}(context,date,channelsResult.Items,programsResult.Items,renderOptions,apiClient,scrollToTimeMs,focusToTimeMs,startTimeOfDayMs,focusProgramOnRender),function hideLoading(){_loading.default.hide()}()}))}))}function getDisplayTime(date){if("string"===_typeof(date).toString().toLowerCase())try{date=_datetime.default.parseISO8601Date(date,{toLocal:!0})}catch(err){return date}return _datetime.default.getDisplayTime(date).toLowerCase()}function parseDates(program){if(!program.StartDateLocal)try{program.StartDateLocal=_datetime.default.parseISO8601Date(program.StartDate,{toLocal:!0})}catch(err){console.error("error parsing timestamp for start date")}if(!program.EndDateLocal)try{program.EndDateLocal=_datetime.default.parseISO8601Date(program.EndDate,{toLocal:!0})}catch(err){console.error("error parsing timestamp for end date")}return null}function getTimerIndicator(item){var status;if("SeriesTimer"===item.Type)return'<span class="material-icons programIcon seriesTimerIcon fiber_smart_record"></span>';if(item.TimerId||item.SeriesTimerId)status=item.Status||"Cancelled";else{if("Timer"!==item.Type)return"";status=item.Status}return item.SeriesTimerId?"Cancelled"!==status?'<span class="material-icons programIcon seriesTimerIcon fiber_smart_record"></span>':'<span class="material-icons programIcon seriesTimerIcon seriesTimerIcon-inactive fiber_smart_record"></span>':'<span class="material-icons programIcon timerIcon fiber_manual_record"></span>'}function getChannelProgramsHtml(context,date,channel,programs,options,listInfo){var html="",startMs=date.getTime(),endMs=startMs+864e5-1;html+='<div class="'+(_layoutManager.default.tv?"channelPrograms channelPrograms-tv":"channelPrograms")+'" data-channelid="'+channel.Id+'">';for(var programsFound,clickAction=_layoutManager.default.tv?"link":"programdialog",categories=self.categoryOptions.categories||[],displayMovieContent=!categories.length||-1!==categories.indexOf("movies"),displaySportsContent=!categories.length||-1!==categories.indexOf("sports"),displayNewsContent=!categories.length||-1!==categories.indexOf("news"),displayKidsContent=!categories.length||-1!==categories.indexOf("kids"),displaySeriesContent=!categories.length||-1!==categories.indexOf("series"),enableColorCodedBackgrounds="true"===userSettings.get("guide-colorcodedbackgrounds"),now=(new Date).getTime(),i=listInfo.startIndex,length=programs.length;i<length;i++){var program=programs[i];if(program.ChannelId===channel.Id){programsFound=!0,listInfo.startIndex++,parseDates(program);var startDateLocalMs=program.StartDateLocal.getTime(),endDateLocalMs=program.EndDateLocal.getTime();if(!(endDateLocalMs<startMs)){if(startDateLocalMs>endMs)break;items[program.Id]=program;var renderStartMs=Math.max(startDateLocalMs,startMs),startPercent=(startDateLocalMs-startMs)/864e5;startPercent*=100,startPercent=Math.max(startPercent,0);var endPercent=(Math.min(endDateLocalMs,endMs)-renderStartMs)/864e5;endPercent*=100;var cssClass="programCell itemAction",accentCssClass=null,displayInnerContent=!0;program.IsKids?(displayInnerContent=displayKidsContent,accentCssClass="kids"):program.IsSports?(displayInnerContent=displaySportsContent,accentCssClass="sports"):program.IsNews?(displayInnerContent=displayNewsContent,accentCssClass="news"):program.IsMovie?(displayInnerContent=displayMovieContent,accentCssClass="movie"):displayInnerContent=(program.IsSeries||displayMovieContent&&displayNewsContent&&displaySportsContent&&displayKidsContent)&&displaySeriesContent,displayInnerContent&&enableColorCodedBackgrounds&&accentCssClass&&(cssClass+=" programCell-"+accentCssClass),now>=startDateLocalMs&&now<endDateLocalMs&&(cssClass+=" programCell-active");var timerAttributes="";if(program.TimerId&&(timerAttributes+=' data-timerid="'+program.TimerId+'"'),program.SeriesTimerId&&(timerAttributes+=' data-seriestimerid="'+program.SeriesTimerId+'"'),html+="<button"+(endPercent>=2?' is="emby-programcell"':"")+' data-action="'+clickAction+'"'+timerAttributes+' data-channelid="'+program.ChannelId+'" data-id="'+program.Id+'" data-serverid="'+program.ServerId+'" data-startdate="'+program.StartDate+'" data-enddate="'+program.EndDate+'" data-type="'+program.Type+'" class="'+cssClass+'" style="left:'+startPercent+"%;width:"+endPercent+'%;">',displayInnerContent){html+='<div class="guideProgramName">',html+='<div class="guide-programNameCaret hide"><span class="guideProgramNameCaretIcon material-icons keyboard_arrow_left"></span></div>',html+='<div class="guideProgramNameText">'+program.Name;var indicatorHtml=null;program.IsLive&&options.showLiveIndicator?indicatorHtml='<span class="liveTvProgram guideProgramIndicator">'+_globalize.default.translate("Live")+"</span>":program.IsPremiere&&options.showPremiereIndicator?indicatorHtml='<span class="premiereTvProgram guideProgramIndicator">'+_globalize.default.translate("Premiere")+"</span>":program.IsSeries&&!program.IsRepeat&&options.showNewIndicator?indicatorHtml='<span class="newTvProgram guideProgramIndicator">'+_globalize.default.translate("New")+"</span>":program.IsSeries&&program.IsRepeat&&options.showRepeatIndicator&&(indicatorHtml='<span class="repeatTvProgram guideProgramIndicator">'+_globalize.default.translate("Repeat")+"</span>"),html+=indicatorHtml||"",program.EpisodeTitle&&options.showEpisodeTitle&&(html+='<div class="guideProgramSecondaryInfo">',program.EpisodeTitle&&options.showEpisodeTitle&&(html+='<span class="programSecondaryTitle">'+program.EpisodeTitle+"</span>"),html+="</div>"),html+="</div>",program.IsHD&&options.showHdIcon&&(_layoutManager.default.tv?html+='<div class="programIcon guide-programTextIcon guide-programTextIcon-tv">HD</div>':html+='<div class="programIcon guide-programTextIcon">HD</div>'),html+=getTimerIndicator(program),html+="</div>"}html+="</button>"}}else if(programsFound)break}return html+="</div>"}function getProgramSortOrder(program,channels){for(var channelId=program.ChannelId,channelIndex=-1,i=0,length=channels.length;i<length;i++)if(channelId===channels[i].Id){channelIndex=i;break}return 1e7*channelIndex+_datetime.default.parseISO8601Date(program.StartDate,{toLocal:!0}).getTime()/6e4}function nativeScrollTo(container,pos,horizontal){container.scrollTo?horizontal?container.scrollTo(pos,0):container.scrollTo(0,pos):horizontal?container.scrollLeft=Math.round(pos):container.scrollTop=Math.round(pos)}self.refresh=function(){currentDate=null,reloadPage(options.element),restartAutoRefresh()},self.pause=function(){stopAutoRefresh()},self.resume=function(refreshData){refreshData?self.refresh():restartAutoRefresh()},self.destroy=function(){stopAutoRefresh(),_events.default.off(_serverNotifications.default,"TimerCreated",onTimerCreated),_events.default.off(_serverNotifications.default,"SeriesTimerCreated",onSeriesTimerCreated),_events.default.off(_serverNotifications.default,"TimerCancelled",onTimerCancelled),_events.default.off(_serverNotifications.default,"SeriesTimerCancelled",onSeriesTimerCancelled),setScrollEvents(options.element,!1),_itemShortcuts.default.off(options.element),items={}};var lastGridScroll=0,lastHeaderScroll=0,scrollXPct=0;function changeDate(page,date,scrollToTimeMs,focusToTimeMs,startTimeOfDayMs,focusProgramOnRender){var newStartDate=function normalizeDateToTimeslot(date){return date.getMinutes()-30>=0?date.setHours(date.getHours(),30,0,0):date.setHours(date.getHours(),0,0,0),date}(date);currentDate=newStartDate,reloadGuide(page,newStartDate,scrollToTimeMs,focusToTimeMs,startTimeOfDayMs,focusProgramOnRender)}function getDateTabText(date,isActive,tabIndex){var html='<button is="emby-button" class="'+(isActive?"emby-tab-button guide-date-tab-button emby-tab-button-active":"emby-tab-button guide-date-tab-button")+'" data-index="'+tabIndex+'" data-date="'+date.getTime()+'">',tabText=_datetime.default.toLocaleDateString(date,{weekday:"short"});return tabText+="<br/>",html+='<div class="emby-button-foreground">'+(tabText+=date.getDate())+"</div>",html+="</button>"}function reloadPage(page){showLoading(),_connectionManager.default.getApiClient(options.serverId).getLiveTvGuideInfo().then((function(guideInfo){!function setDateRange(page,guideInfo){var today=new Date,nowHours=today.getHours();today.setHours(nowHours,0,0,0);var start=_datetime.default.parseISO8601Date(guideInfo.StartDate,{toLocal:!0}),end=_datetime.default.parseISO8601Date(guideInfo.EndDate,{toLocal:!0});start.setHours(nowHours,0,0,0),end.setHours(0,0,0,0),start.getTime()>=end.getTime()&&end.setDate(start.getDate()+1),start=new Date(Math.max(today,start));var dateTabsHtml="",tabIndex=0,date=new Date;currentDate&&date.setTime(currentDate.getTime()),date.setHours(nowHours,0,0,0);var startTimeOfDayMs=60*start.getHours()*60*1e3;for(startTimeOfDayMs+=60*start.getMinutes()*1e3;start<=end;){var isActive=date.getDate()===start.getDate()&&date.getMonth()===start.getMonth()&&date.getFullYear()===start.getFullYear();dateTabsHtml+=getDateTabText(start,isActive,tabIndex),start.setDate(start.getDate()+1),start.setHours(0,0,0,0),tabIndex++}page.querySelector(".emby-tabs-slider").innerHTML=dateTabsHtml,page.querySelector(".guideDateTabs").refresh();var newDate=new Date,newDateHours=newDate.getHours(),scrollToTimeMs=60*newDateHours*60*1e3,minutes=newDate.getMinutes();minutes>=30&&(scrollToTimeMs+=18e5),changeDate(page,date,scrollToTimeMs,60*(60*newDateHours+minutes)*1e3,startTimeOfDayMs,_layoutManager.default.tv)}(page,guideInfo)}))}function getChannelProgramsFocusableElements(container){var _step4,elements=container.querySelectorAll(".programCell"),list=[],currentScrollXPct=scrollXPct+1,_iterator4=_createForOfIteratorHelper(elements);try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var elem=_step4.value,left=(elem.style.left||"").replace("%","");left=left?parseFloat(left):0;var width=(elem.style.width||"").replace("%","");left+(width=width?parseFloat(width):0)>=currentScrollXPct&&list.push(elem)}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}return list}function onInputCommand(e){var container,focusableElements,newRow,target=e.target,programCell=_dom.default.parentWithClass(target,"programCell");switch(e.detail.command){case"up":programCell?(container=programGrid,(newRow=_dom.default.parentWithClass(programCell,"channelPrograms").previousSibling)?(focusableElements=getChannelProgramsFocusableElements(newRow)).length?container=newRow:focusableElements=null:container=null):container=null,lastFocusDirection=e.detail.command,_focusManager.default.moveUp(target,{container:container,focusableElements:focusableElements});break;case"down":programCell?(container=programGrid,(newRow=_dom.default.parentWithClass(programCell,"channelPrograms").nextSibling)?(focusableElements=getChannelProgramsFocusableElements(newRow)).length?container=newRow:focusableElements=null:container=null):container=null,lastFocusDirection=e.detail.command,_focusManager.default.moveDown(target,{container:container,focusableElements:focusableElements});break;case"left":(container=programCell?_dom.default.parentWithClass(programCell,"channelPrograms"):null)&&!programCell.previousSibling&&(container=null),lastFocusDirection=e.detail.command,_focusManager.default.moveLeft(target,{container:container});break;case"right":container=programCell?_dom.default.parentWithClass(programCell,"channelPrograms"):null,lastFocusDirection=e.detail.command,_focusManager.default.moveRight(target,{container:container});break;default:return}e.preventDefault(),e.stopPropagation()}function onScrollerFocus(e){var target=e.target,programCell=_dom.default.parentWithClass(target,"programCell");if(programCell){var id=target.getAttribute("data-id"),item=items[id];item&&_events.default.trigger(self,"focus",[{item:item}])}if("left"===lastFocusDirection)programCell&&_scrollHelper.default.toStart(programGrid,programCell,!0,!0);else if("right"===lastFocusDirection)programCell&&_scrollHelper.default.toCenter(programGrid,programCell,!0,!0);else if("up"===lastFocusDirection||"down"===lastFocusDirection){var verticalScroller=_dom.default.parentWithClass(target,"guideVerticalScroller");if(verticalScroller){var focusedElement=programCell||_dom.default.parentWithTag(target,"BUTTON");verticalScroller.toCenter(focusedElement,!0)}}}function setScrollEvents(view,enabled){if(_layoutManager.default.tv){var guideVerticalScroller=view.querySelector(".guideVerticalScroller");enabled?_inputManager.default.on(guideVerticalScroller,onInputCommand):_inputManager.default.off(guideVerticalScroller,onInputCommand)}}function onTimerCreated(e,apiClient,data){var _step5,programId=data.ProgramId,newTimerId=data.Id,_iterator5=_createForOfIteratorHelper(options.element.querySelectorAll('.programCell[data-id="'+programId+'"]'));try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var cell=_step5.value;cell.querySelector(".timerIcon")||cell.querySelector(".guideProgramName").insertAdjacentHTML("beforeend",'<span class="timerIcon material-icons programIcon fiber_manual_record"></span>'),newTimerId&&cell.setAttribute("data-timerid",newTimerId)}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}}function onSeriesTimerCreated(e,apiClient,data){}function onTimerCancelled(e,apiClient,data){var _step6,id=data.Id,_iterator6=_createForOfIteratorHelper(options.element.querySelectorAll('.programCell[data-timerid="'+id+'"]'));try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var cell=_step6.value,icon=cell.querySelector(".timerIcon");icon&&icon.parentNode.removeChild(icon),cell.removeAttribute("data-timerid")}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}}function onSeriesTimerCancelled(e,apiClient,data){var _step7,id=data.Id,_iterator7=_createForOfIteratorHelper(options.element.querySelectorAll('.programCell[data-seriestimerid="'+id+'"]'));try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var cell=_step7.value,icon=cell.querySelector(".seriesTimerIcon");icon&&icon.parentNode.removeChild(icon),cell.removeAttribute("data-seriestimerid")}}catch(err){_iterator7.e(err)}finally{_iterator7.f()}}new Promise((function(_resolve,_reject){return _require(["text!./tvguide.template.html"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref2){var template=_ref2.default,context=options.element;context.classList.add("tvguide"),context.innerHTML=_globalize.default.translateHtml(template,"core"),programGrid=context.querySelector(".programGrid");var timeslotHeaders=context.querySelector(".timeslotHeaders");_layoutManager.default.tv?_dom.default.addEventListener(context.querySelector(".guideVerticalScroller"),"focus",onScrollerFocus,{capture:!0,passive:!0}):_layoutManager.default.desktop&&timeslotHeaders.classList.add("timeslotHeaders-desktop"),(_browser.default.iOS||_browser.default.osx)&&(context.querySelector(".channelsContainer").classList.add("noRubberBanding"),programGrid.classList.add("noRubberBanding")),_dom.default.addEventListener(programGrid,"scroll",(function(e){!function onProgramGridScroll(context,elem,timeslotHeaders){if((new Date).getTime()-lastHeaderScroll>=1e3){lastGridScroll=(new Date).getTime();var scrollLeft=elem.scrollLeft;scrollXPct=100*scrollLeft/elem.scrollWidth,nativeScrollTo(timeslotHeaders,scrollLeft,!0)}updateProgramCellsOnScroll(elem,programCells)}(0,this,timeslotHeaders)}),{passive:!0}),_dom.default.addEventListener(timeslotHeaders,"scroll",(function(){!function onTimeslotHeadersScroll(context,elem){(new Date).getTime()-lastGridScroll>=1e3&&(lastHeaderScroll=(new Date).getTime(),nativeScrollTo(programGrid,elem.scrollLeft,!0))}(0,this)}),{passive:!0}),programGrid.addEventListener("click",onProgramGridClick),context.querySelector(".btnNextPage").addEventListener("click",(function(){currentStartIndex+=currentChannelLimit,reloadPage(context),restartAutoRefresh()})),context.querySelector(".btnPreviousPage").addEventListener("click",(function(){currentStartIndex=Math.max(currentStartIndex-currentChannelLimit,0),reloadPage(context),restartAutoRefresh()})),context.querySelector(".btnGuideViewSettings").addEventListener("click",(function(){!function showViewSettings(instance){new Promise((function(_resolve,_reject){return _require(["guide-settings-dialog"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref){_ref.default.show(instance.categoryOptions).then((function(){instance.refresh()}))}))}(self),restartAutoRefresh()})),context.querySelector(".guideDateTabs").addEventListener("tabchange",(function(e){var allTabButtons=e.target.querySelectorAll(".guide-date-tab-button"),tabButton=allTabButtons[parseInt(e.detail.selectedTabIndex)];if(tabButton){var previousButton=null==e.detail.previousIndex?null:allTabButtons[parseInt(e.detail.previousIndex)],date=new Date;date.setTime(parseInt(tabButton.getAttribute("data-date")));var scrollToTimeMs,scrollWidth=programGrid.scrollWidth;if(scrollToTimeMs=scrollWidth?programGrid.scrollLeft/scrollWidth*864e5:0,previousButton){var previousDate=new Date;previousDate.setTime(parseInt(previousButton.getAttribute("data-date"))),scrollToTimeMs+=60*previousDate.getHours()*60*1e3,scrollToTimeMs+=60*previousDate.getMinutes()*1e3}var startTimeOfDayMs=60*date.getHours()*60*1e3;startTimeOfDayMs+=60*date.getMinutes()*1e3,changeDate(context,date,scrollToTimeMs,scrollToTimeMs,startTimeOfDayMs,!1)}})),setScrollEvents(context,!0),_itemShortcuts.default.on(context),_events.default.trigger(self,"load"),_events.default.on(_serverNotifications.default,"TimerCreated",onTimerCreated),_events.default.on(_serverNotifications.default,"SeriesTimerCreated",onSeriesTimerCreated),_events.default.on(_serverNotifications.default,"TimerCancelled",onTimerCancelled),_events.default.on(_serverNotifications.default,"SeriesTimerCancelled",onSeriesTimerCancelled),self.refresh()}))};_exports.default=_default}));
//# sourceMappingURL=guide.js.map
