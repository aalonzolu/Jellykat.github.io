{"version":3,"sources":["components/pluginManager.js"],"names":["define","_exports","_events","_globalize","_interopRequireDefault","obj","__esModule","default","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","_classPrivateMethodGet","receiver","privateSet","fn","has","TypeError","value","cacheParam","Date","getTime","_loadStrings","WeakSet","_definePluginRoute","_registerPlugin","_register","_mapRoute","PluginManager","_classCallCheck","instance","Constructor","this","add","_defineProperty","_createClass","protoProps","staticProps","prototype","loadPlugin","pluginSpec","_this","console","debug","Promise","resolve","reject","require","pluginFactory","plugin","pluginsList","filter","p","id","installUrl","separatorIndex","Math","max","lastIndexOf","baseUrl","substring","paths","requirejs","config","waitSeconds","_registerPlugin2","call","then","catch","pluginBuilder","concat","err","error","ofType","type","o","mapPath","path","addCacheParam","packageName","url","includes","get","_loadStrings2","strings","getTranslations","globalize","loadStrings","name","_definePluginRoute2","route","contentPath","_mapRoute2","Emby","App","defineRoute","_this2","_register2","getRoutes","forEach","push","events","trigger","toLowerCase","startsWith","_default"],"mappings":"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","file":"pluginManager.js","sourcesContent":["import events from 'events';\nimport globalize from 'globalize';\n/* eslint-disable indent */\n\n    // TODO: replace with each plugin version\n    var cacheParam = new Date().getTime();\n\n    class PluginManager {\n        pluginsList = [];\n\n        get plugins() {\n            return this.pluginsList;\n        }\n\n        #loadStrings(plugin) {\n            var strings = plugin.getTranslations ? plugin.getTranslations() : [];\n            return globalize.loadStrings({\n                name: plugin.id || plugin.packageName,\n                strings: strings\n            });\n        }\n\n        #definePluginRoute(route, plugin) {\n            route.contentPath = this.mapPath(plugin, route.path);\n            route.path = this.#mapRoute(plugin, route);\n\n            Emby.App.defineRoute(route, plugin.id);\n        }\n\n        #registerPlugin(plugin) {\n            this.#register(plugin);\n\n            if (plugin.getRoutes) {\n                plugin.getRoutes().forEach((route) => {\n                    this.#definePluginRoute(route, plugin);\n                });\n            }\n\n            if (plugin.type === 'skin') {\n                // translations won't be loaded for skins until needed\n                return Promise.resolve(plugin);\n            } else {\n                return new Promise((resolve, reject) => {\n                    this.#loadStrings(plugin)\n                        .then(function () {\n                            resolve(plugin);\n                        })\n                        .catch(reject);\n                });\n            }\n        }\n\n        loadPlugin(pluginSpec) {\n            if (typeof pluginSpec === 'string') {\n                console.debug('Loading plugin (via deprecated requirejs method): ' + pluginSpec);\n\n                return new Promise((resolve, reject) => {\n                    require([pluginSpec], (pluginFactory) => {\n                        var plugin = pluginFactory.default ? new pluginFactory.default() : new pluginFactory();\n\n                        // See if it's already installed\n                        var existing = this.pluginsList.filter(function (p) {\n                            return p.id === plugin.id;\n                        })[0];\n\n                        if (existing) {\n                            resolve(pluginSpec);\n                        }\n\n                        plugin.installUrl = pluginSpec;\n\n                        var separatorIndex = Math.max(pluginSpec.lastIndexOf('/'), pluginSpec.lastIndexOf('\\\\'));\n                        plugin.baseUrl = pluginSpec.substring(0, separatorIndex);\n\n                        var paths = {};\n                        paths[plugin.id] = plugin.baseUrl;\n\n                        requirejs.config({\n                            waitSeconds: 0,\n                            paths: paths\n                        });\n\n                        this.#registerPlugin(plugin).then(resolve).catch(reject);\n                    });\n                });\n            } else if (pluginSpec.then) {\n                return pluginSpec.then(pluginBuilder => {\n                    return pluginBuilder();\n                }).then((plugin) => {\n                    console.debug(`Plugin loaded: ${plugin.id}`);\n                    return this.#registerPlugin(plugin);\n                });\n            } else {\n                const err = new TypeError('Plugins have to be a Promise that resolves to a plugin builder function or a RequireJS url (deprecated)');\n                console.error(err);\n                return Promise.reject(err);\n            }\n        }\n\n        // In lieu of automatic discovery, plugins will register dynamic objects\n        // Each object will have the following properties:\n        // name\n        // type (skin, screensaver, etc)\n        #register(obj) {\n            this.pluginsList.push(obj);\n            events.trigger(this, 'registered', [obj]);\n        }\n\n        ofType(type) {\n            return this.pluginsList.filter((o) => {\n                return o.type === type;\n            });\n        }\n\n        #mapRoute(plugin, route) {\n            if (typeof plugin === 'string') {\n                plugin = this.pluginsList.filter((p) => {\n                    return (p.id || p.packageName) === plugin;\n                })[0];\n            }\n\n            route = route.path || route;\n\n            if (route.toLowerCase().startsWith('http')) {\n                return route;\n            }\n\n            return '/plugins/' + plugin.id + '/' + route;\n        }\n\n        mapPath(plugin, path, addCacheParam) {\n            if (typeof plugin === 'string') {\n                plugin = this.pluginsList.filter((p) => {\n                    return (p.id || p.packageName) === plugin;\n                })[0];\n            }\n\n            var url = plugin.baseUrl + '/' + path;\n\n            if (addCacheParam) {\n                url += url.includes('?') ? '&' : '?';\n                url += 'v=' + cacheParam;\n            }\n\n            return url;\n        }\n    }\n\n/* eslint-enable indent */\n\nexport default new PluginManager();\n"]}