define(["require","exports","events","globalize","dom","date-fns","dfnshelper","serverNotifications","connectionManager","emby-button","listViewStyle"],(function(_require,_exports,_events,_globalize,_dom,datefns,_dfnshelper,_serverNotifications,_connectionManager,_embyButton,_listViewStyle){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var cache=new WeakMap;return _getRequireWildcardCache=function _getRequireWildcardCache(){return cache},cache}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache();if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function renderList(elem,apiClient,result,startIndex,limit){elem.innerHTML=result.Items.map((function(i){return function getEntryHtml(entry,apiClient){var html="";html+='<div class="listItem listItem-border">';var color="#00a4dc",icon="notifications";return"Error"!=entry.Severity&&"Fatal"!=entry.Severity&&"Warn"!=entry.Severity||(color="#cc0000",icon="notification_important"),entry.UserId&&entry.UserPrimaryImageTag?html+='<span class="listItemIcon material-icons dvr" style="width:2em!important;height:2em!important;padding:0;color:transparent;background-color:'+color+";background-image:url('"+apiClient.getUserImageUrl(entry.UserId,{type:"Primary",tag:entry.UserPrimaryImageTag})+"');background-repeat:no-repeat;background-position:center center;background-size: cover;\"></span>":html+='<span class="listItemIcon material-icons '+icon+'" style="background-color:'+color+'"></span>',html+='<div class="listItemBody three-line">',html+='<div class="listItemBodyText">',html+=entry.Name,html+="</div>",html+='<div class="listItemBodyText secondary">',html+=datefns.formatRelative(Date.parse(entry.Date),Date.parse(new Date),{locale:_dfnshelper.default.getLocale()}),html+="</div>",html+='<div class="listItemBodyText secondary listItemBodyText-nowrap">',html+=entry.ShortOverview||"",html+="</div>",html+="</div>",entry.Overview&&(html+='<button type="button" is="paper-icon-button-light" class="btnEntryInfo" data-id="'.concat(entry.Id,'" title="').concat(_globalize.default.translate("Info"),'">\n                       <span class="material-icons info"></span>\n                    </button>')),html+="</div>"}(i,apiClient)})).join("")}function reloadData(instance,elem,apiClient,startIndex,limit){null==startIndex&&(startIndex=parseInt(elem.getAttribute("data-activitystartindex")||"0")),limit=limit||parseInt(elem.getAttribute("data-activitylimit")||"7");var minDate=new Date,hasUserId="false"!==elem.getAttribute("data-useractivity");hasUserId?minDate.setTime(minDate.getTime()-864e5):minDate.setTime(minDate.getTime()-6048e5),ApiClient.getJSON(ApiClient.getUrl("System/ActivityLog/Entries",{startIndex:startIndex,limit:limit,minDate:minDate.toISOString(),hasUserId:hasUserId})).then((function(result){if(elem.setAttribute("data-activitystartindex",startIndex),elem.setAttribute("data-activitylimit",limit),!startIndex){var activityContainer=_dom.default.parentWithClass(elem,"activityContainer");activityContainer&&(result.Items.length?activityContainer.classList.remove("hide"):activityContainer.classList.add("hide"))}instance.items=result.Items,renderList(elem,apiClient,result)}))}function onActivityLogUpdate(e,apiClient,data){var options=this.options;options&&options.serverId===apiClient.serverId()&&reloadData(this,options.element,apiClient)}function onListClick(e){var btnEntryInfo=_dom.default.parentWithClass(e.target,"btnEntryInfo");if(btnEntryInfo){var id=btnEntryInfo.getAttribute("data-id"),items=this.items;if(items){var item=items.filter((function(i){return i.Id.toString()===id}))[0];item&&function showItemOverview(item){new Promise((function(_resolve,_reject){return _require(["alert"],(function(imported){return _resolve(_interopRequireWildcard(imported))}),_reject)})).then((function(_ref){(0,_ref.default)({text:item.Overview})}))}(item)}}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_events=_interopRequireDefault(_events),_globalize=_interopRequireDefault(_globalize),_dom=_interopRequireDefault(_dom),datefns=_interopRequireWildcard(datefns),_dfnshelper=_interopRequireDefault(_dfnshelper),_serverNotifications=_interopRequireDefault(_serverNotifications),_connectionManager=_interopRequireDefault(_connectionManager);var _default=function(){function ActivityLog(options){!function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,ActivityLog),this.options=options;var element=options.element;element.classList.add("activityLogListWidget"),element.addEventListener("click",onListClick.bind(this));var apiClient=_connectionManager.default.getApiClient(options.serverId);reloadData(this,element,apiClient);var onUpdate=onActivityLogUpdate.bind(this);this.updateFn=onUpdate,_events.default.on(_serverNotifications.default,"ActivityLogEntry",onUpdate),apiClient.sendMessage("ActivityLogEntryStart","0,1500")}return function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}(ActivityLog,[{key:"destroy",value:function destroy(){var options=this.options;options&&(options.element.classList.remove("activityLogListWidget"),_connectionManager.default.getApiClient(options.serverId).sendMessage("ActivityLogEntryStop","0,1500"));var onUpdate=this.updateFn;onUpdate&&_events.default.off(_serverNotifications.default,"ActivityLogEntry",onUpdate),this.items=null,this.options=null}}]),ActivityLog}();_exports.default=_default}));
//# sourceMappingURL=activitylog.js.map
